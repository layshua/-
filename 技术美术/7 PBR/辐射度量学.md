
---
title: 辐射度量学
aliases: []
tags: []
create_time: 2023-07-03 17:19
uid: 202307031719
banner: "![[Pasted image 20230709182107.png]]"
---

# 1 概念
**辐射度量学 (Radiometry)** 是一种用来度量电磁场辐射（包括可见光）的手段。有很多种**辐射度量 (radiometric quantities)** 可以用来测量曲面或者某个方向上的光，此处只讨论和反射方程有关的一种量，它就是**辐射率 (Radiance)**，用 $L$ 来表示。

辐射度量学涉及的概念、名词、公式

|名称<img width>|符号 |单位<img width> |公式|解析|
|---|---|---|---|---|
|**辐射能量** <br>Radiant energy | $Q$ |焦耳<br> $J$ |- |电磁辐射能量|
|**辐射通量** <br>Radiant Flux | $\Phi$ |瓦<br> $W$| $\displaystyle\Phi=\frac{dQ}{dt}$ |单位时间辐射的能量，也叫辐射功率 (Radiant Power)或通量 (Flux)|
|**辐照度**<br>Irradiance| $E$ |瓦/平方米 <br>$W/m^{2}$| $\displaystyle\Phi=\frac{d\Phi}{dA^{\perp}}$ |到达单位面积的辐射通量|
|**辐射度**<br>Radiosity| $M$ |瓦/平方米<br> $W/m^2$| $\displaystyle M=\frac{d\Phi}{dA^\perp}$ |离开单位面积的辐射通量，也叫辐出度、辐射出射度（Radiant Existance）|
|**辐射强度**<br>Radiant Intensity| $I$ |瓦/立体弧度<br> $W/sr$| $\displaystyle I=\frac{d\Phi}{d\omega}$ |通过单位立体角的辐射通量|
|**辐射率**<br>Radiance| $L$ |瓦/平方米立体弧度 <br>$W/m^2sr$| $L=\displaystyle\frac{d\Phi}{d\omega dA^{\perp}}$ |通过单位面积单位立体角的辐射通量|
|**立体角**<br>Solid Angle| $\omega$ |立体弧度，球面度<br>$sr$ | $\displaystyle\omega=\frac{S}{r^{2}}$ |是二维弧度在三维的扩展，1 球面度等于单位球体的表面面积|

辐射率被用来量化单一方向上发射来的光线的大小或者强度。辐射率是由多个物理变量集合而成的，它涉及的物理变量有以下几种：

*   **辐射通量 (Radiant Flux)**：辐射通量用符号 $\Phi$ 表示，表示一个光源输出的能量，以瓦特为单位。光是由多种不同波长的能量集合而成，每种波长与一种特定的（可见的）颜色相关。因此一个光源所放射出来的能量可以被视作这个光源包含的所有各种波长的一个函数。波长介于 390nm（纳米）到 700nm 的光被认为是处于可见光光谱中，也就是说它们是人眼可见的波长。
    ![](1679148476662.png)
    
      
    _上图展示了太阳光中不同波长的光所具有的能量。_  
    传统物理学上的辐射通量将会计算这个由不同波长构成的函数的总面积，这种计算很复杂，耗费大量性能。在 PBR 技术中，不直接使用波长的强度，而是使用三原色编码（RGB）来简化辐射通量的计算。虽然这种简化会带来一些信息上的损失，但是这对于视觉效果上的影响基本可以忽略。
    
*   **立体角 (Solid Angle)**：用符号 $\omega$ 表示，它描述投射到单位球体上的一个截面的大小或者面积。可以把立体角想象成为一个带有体积的方向：  
    
    ![](1679148476688.png)
    
      
    更加形象地描述：观察者站在单位球面的中心，向着投影的方向看，在单位球体面上的投影轮廓的大小就是立体角。
    
*   **辐射强度 (Radiant Intensity)**：用符号 $I$ 表示，它描述的是在单位球面上，一个光源向每单位立体角所投送的辐射通量。举个例子，假设一个点光源向所有方向均匀地辐射能量，辐射强度就能计算出它在一个单位面积（立体角）内的能量大小：  
    
    ![](1679148476720.png)
    
      
    计算辐射强度的公式：
    

$$I = \frac{d\Phi}{d\omega}$$

其中 $I$ 表示辐射通量 $\Phi$ 除以立体角 $\omega$ 的辐射强度。

理解以上物理变量后，可以继续讨论辐射率方程了。下面方程代表的意义是：一个辐射强度为 $\Phi$ 的光通过立体角 $\omega$ 辐射在区域 $A$ 的可被观察到的总能量。

$$L=\frac{I}{dA^\perp}=\frac{\frac{d\Phi}{d\omega}}{dA\cos\theta}=\frac{d\Phi}{ dA d\omega \cos\theta}$$

笔者注：原文的公式是 $L = \frac{d^2\Phi}{ dA d\omega \cos\theta}$，经推导之后，并没有平方。​

![](1679148476742.png)

辐射率是一个区域内光照量的辐射学度量，按照光的入射（或者来源）角与平面法线的夹角 $\theta$ 计算 $\cos \theta$。越是斜着照射在平面上光越弱，反之越是垂直照射在表面上的光越强，类似基础光照中的漫反射颜色计算，$\cos \theta$ 直接等于光的方向和表面法线的点积。

```
float cosTheta = dot(lightDir, N);
```

上面的物理符号似乎和 PBR 的反射方程没有直接的关系。但是，如果将立体角 $\omega$ 跟区域 $A$ 都看作无限小，就可以使用辐射率来分析一束光线打在空间上一个点的通量，也就是说能够计算单束光线对单个（片元）点的辐射率影响。进一步地，将立体角 $\omega$ 转化为方向向量 $\omega$，将区域 $A$ 转化成点 $p$，因此在 shader 中直接使用辐射率来计算单束光线对每个片元的贡献。

实际上，当谈及光的辐射率时，通常只关注的是所有射入点 $p$ 的光线，这些光的辐射度总和称为**辐照度 (Irradiance)**。理解了辐射率和辐照度，回到反射方程：

$$L_o(p,\omega_o) = \int\limits_{\Omega} f_r(p,\omega_i,\omega_o) L_i(p,\omega_i) n \cdot \omega_i d\omega_i$$

渲染方程式中 $L$ 代表某个点 $p$ 的辐射率，而无限小的入射光的立体角 $\omega_i$ 可以看作入射光方向向量 $\omega_i$，将用来衡量入射光与平面法线夹角对能量的影响的 $\cos \theta$ 分量移出辐射率方程，作为反射方程的单独项 $n \cdot \omega_i$ 。

反射方程计算了点 $p$ 在所有视线方向 $\omega_0$ 上被反射出来的辐射率 $L_o(p,\omega_o)$ 的总和。换言之：$L_0$ 计算的是在 $\omega_o$ 方向的眼睛观察到的 $p$ 点的总辐照度。

反射方程里面使用的辐照度，必须要包含所有以 $p$ 点为中心的半球 $\Omega$ 内的入射光，而不单单只是某一个方向的入射光。这个半球指的是围绕面法线 $n$ 的那一个半球：  

![](1679148476772.png)

笔者注：为什么只计算半球而不计算整个球体呢？

因为另外一边的半球因与视线方向相反，不能被观察，也就是辐射通量贡献量为 0，所以被忽略。

为了计算这个区域（半球）内的所有值，在反射方程中使用了一个称作为积分的数学符号 $\int$，来计算半球 $\Omega$ 内所有的入射向量 $d\omega_i$。

积分计算面积的方法，有**解析 (analytically)** 和**渐近 (numerically)** 两种方法。目前尚没有可以满足渲染计算的解析法，所以只能选择离散渐近法来解决这个积分问题。

具体做法是在半球 $\Omega$ 按一定的步长将反射方程离散地求解，然后再按照步长大小将所得到的结果平均化，这种方法被称为**黎曼和 (Riemann sum)**。下面是实现的伪代码：

```
int steps = 100; // 分段计算的数量，数量越多，计算结果越准确。
float dW  = 1.0f / steps;
vec3 P    = ...;
vec3 Wo   = ...;
vec3 N    = ...;
float sum = 0.0f;
for(int i = 0; i < steps; ++i) 
{
    vec3 Wi = getNextIncomingLightDir(i);
    sum += Fr(P, Wi, Wo) * L(P, Wi) * dot(N, Wi) * dW;
}
```

`dW` 的值越小结果越接近正确的积分函数的面积或者说体积，衡量离散步长的 `dW` 可以看作反射方程中的 $d\omega_i$。积分计算中我们用到的 $d\omega_i$ 是线性连续的符号，跟代码中的 `dW` 并没有直接关系，但是这种方式有助于我们理解，而且这种离散渐近的计算方法总是可以得到一个很接近正确结果的值。值得一提的是，通过增加步骤数 `steps` 可以提高黎曼和的准确性，但计算量也会增大。

反射方程加了所有的，以各个方向 $\omega_i$ 射入半球 $\Omega$ 并打中点 $p$ 的入射光，经过反射函数 $f_r$ 进入观察者眼睛的所有反射光 $L_o$ 的辐射率之和。入射光辐射度可以由光源处获得，此外还可以利用一个环境贴图来测算所有入射方向上的辐射度。

至此，反射方程中，只剩下 $f_r$ 项未描述。$f_r$ 就是**双向反射分布函数** (Bidirectional Reflectance Distribution Function, BRDF)，它的作用是基于表面材质属性来对入射辐射度进行缩放或者加权。
