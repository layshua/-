在 fft 海面模拟中，需要生成服从标准生成分布的随机数（见：[杨超：fft 海面模拟 (一)](https://zhuanlan.zhihu.com/p/64414956)）。

我们知道数构造服从目标分布的随机数发生器，一般是采用反函数法：对目标分布的 CDF 求反函数，则当其输入服从 U(0,1) 的随机数时，就返回服从目标分布的随机数。（参考 pbrt 第三版第 13 章第 3 节）。

不过由于正态分布的 CDF 无法用初等函数表达，所以上面方法走不通，需另辟蹊径。

通常使用称为 Box-Muller 转换（Box-Muller transform）的方法来生成服从标准正态分布的随机数（对儿）。

**一，Box-Muller 转换的基本形式（basic form）**

设 U1,U2 相互独立，均服从分布 U(0,1)

X= $Rcos\Theta=\sqrt{-2lnU_1}cos(2\pi U_2)$

Y= $Rsin\Theta=\sqrt{-2lnU_1}sin(2\pi U_2)$

则 X、Y 相互独立且均服从标准正态分布。

证明：

U1,U2~U(0,1) 所以 $p_{U_1}(u_1)=p_{U_2}(u_2)=1$。

因为$\Theta=2\pi U_2$ ，根据一元随机变量函数分布（见：[杨超：pbrt 注解：transforming between distributions](https://zhuanlan.zhihu.com/p/67446317)）有：

$p_\Theta(\theta)=|\frac{d\theta}{du_2}|^{-1}p_{U_2}(u_2)$

$=|\frac{d(2 \pi u_2)}{du_2}|^{-1}p_{U_2}(u_2)$

$=\frac{1}{2 \pi}$

因为$R=\sqrt{-2lnU_1}$ ，同样，根据一元随机变量函数分布，有：

$p_R(r)=|\frac{dr}{du_1}|^{-1}p_{U_1}(u_1)$

$=|\frac{d\sqrt{-2lnu_1}}{du_1}|^{-1}*1$

$=u_1\sqrt{-2lnu_1}$

(因为 $r=\sqrt{-2lnu_1}$ ，所以 $u_1=e^{-\frac{r^2}{2}}$，所以 )

$=r*e^{-\frac{r^2}{2}}$

因为 U1、U2 互相独立，而 $\Theta$ 只取决于 U2，R 只取决于 U1，所以 $\Theta$ 、R 互相独立。而独立随机变量联合分布等于边缘分布之积。所以

$p_{\Theta,R}(\theta,r)=p_{\Theta}(\theta)*p_R(r)=\frac{1}{2 \pi}r*e^{-\frac{r^2}{2}}$

因为

$X=Rcos\Theta$

$Y=Rsin\Theta$

根据二元随机变量函数分布（见：[杨超：pbrt 注解：transforming between distributions](https://zhuanlan.zhihu.com/p/67446317)），有：

$p_{X,Y}(x,y)=|J|^{-1}p_{\Theta,R}(\theta,r)$

其中

$J=\begin{vmatrix} \frac{\partial x}{\partial \theta} &\frac{\partial x}{\partial r} \\ \frac{\partial y}{\partial \theta} &\frac{\partial y}{\partial r} \end{vmatrix}$

$=\begin{vmatrix} \frac{\partial (r*cos\theta)}{\partial \theta} &\frac{\partial (r*cos\theta)}{\partial r} \\ \frac{\partial (r*sin\theta)}{\partial \theta} &\frac{\partial (r*sin\theta)}{\partial r} \end{vmatrix}$

$=\begin{vmatrix} -r*sin\theta & cos\theta \\ r*cos\theta&sin\theta \end{vmatrix}$

$=-r*sin^2\theta-r*cos^2\theta$

$=-r$

所以

$p_{X,Y}(x,y)=|-r|^{-1}*\frac{1}{2 \pi}r*e^{-\frac{r^2}{2}}$

$=\frac{1}{2 \pi}e^{-\frac{r^2}{2}}$

(因为 $r^2=x^2+y^2$ ，所以)

$=\frac{1}{2 \pi}e^{-\frac{x^2+y^2}{2}}$

所以

$p_X(x)=\int_{-\infty}^{\infty}p_{X,Y}(x,y)dy$

$=\int_{-\infty}^{\infty}\frac{1}{2\pi}e^{-\frac{x^2+y^2}{2}}dy$

$=\frac{1}{2\pi}e^{-\frac{x^2}{2}}\int_{-\infty}^{\infty}e^{-\frac{y^2}{2}}dy$

$=\frac{1}{2\pi}e^{-\frac{x^2}{2}}*\sqrt{2\pi}*\int_{-\infty}^{\infty}\frac{1}{\sqrt{2\pi}}e^{-\frac{y^2}{2}}dy$

(注意其中积分正好是标准正态分布密度函数的积分，故积分结果为 1)

$=\frac{1}{2\pi}e^{-\frac{x^2}{2}}*\sqrt{2\pi}*1$

$=\frac{1}{\sqrt{2\pi}}e^{-\frac{x^2}{2}}$

同理可得：

$p_Y(y)=\int_{-\infty}^{\infty}p_{X,Y}(x,y)dx=\frac{1}{\sqrt{2\pi}}e^{-\frac{y^2}{2}}$

可见 X 和 Y 均服从标准正态分布。又因可验证 $p_{X,Y}(x,y)=p_X(x)*p_Y(y)$ ，所以 X,Y 互相独立。

证毕。

**二，Box-Muller 转换的极坐标形式（polar form）**

设 u,v 相互独立，均服从分布 U(-1,1)，但拒绝掉 $u^2+v^2=0$ 和 $u^2+v^2\geq1$ 的 (u,v) 对儿。

X= $u*\sqrt{\frac{-2lns}{s}}$

Y= $v*\sqrt{\frac{-2lns}{s}}$

其中 $s=u^2+v^2$

则 X、Y 相互独立且均服从标准正态分布。

证明：

实际上在 Box-Muller 转换的标准形式

X= $\sqrt{-2lnU_1}cos(2\pi U_2)$

Y= $\sqrt{-2lnU_1}sin(2\pi U_2)$

中，作变换 (*)：

$U_1=s$

$cos(2\pi U_2)=\frac{u}{\sqrt s}$

$sin(2\pi U_2)=\frac{v}{\sqrt s}$

即得

X= $u*\sqrt{\frac{-2lns}{s}}$

Y= $v*\sqrt{\frac{-2lns}{s}}$

但问题是上述变换 (*) 能满足 “U1,U2 相互独立，均服从分布 U(0,1)” 吗？

验证如下：

（1）首先确认 U1,U2 的取值范围均为 (0,1)：

![](https://pic2.zhimg.com/v2-f7a6610eebff35f3742aea5629912ed5_r.jpg)

如图，因为 (u,v) 均匀分布在单位圆内，而

$U_1=s=r^2$

故 U1 取值范围为 (0,1)。

又由图中看出 $2\pi U_2$ 即为辐角θ，因为θ取值范围为 $(0,2\pi)$ ，故 U2 取值范围为 (0,1)。

（2）再看 U1,U2 的分布：

因为 (u,v) 均匀分布在单位圆内，故 $p_{u,v}(u,v)=\frac{1}{\pi}$ 。

根据二元随机变量函数分布，有：

$p_{U_1,U_2}(u_1,u_2)=|J|^{-1}p_{u,v}(u,v)$

其中

$J=\begin{vmatrix} \frac{\partial u_1}{\partial u} &\frac{\partial u_1}{\partial v} \\ \frac{\partial u_2}{\partial u} &\frac{\partial u_2}{\partial v} \end{vmatrix}$

$\frac{\partial u_1}{\partial u}$ 和 $\frac{\partial u_1}{\partial v}$ 好求：

$\frac{\partial u_1}{\partial u}=\frac{\partial s}{\partial u}=\frac{\partial (u^2+v^2)}{\partial u}=2u$

$\frac{\partial u_1}{\partial v}=\frac{\partial s}{\partial v}=\frac{\partial (u^2+v^2)}{\partial v}=2v$

$\frac{\partial u_2}{\partial u}$ 和 $\frac{\partial u_2}{\partial v}$ 则需隐函数求导：

将$cos(2\pi u_2)=\frac{u}{\sqrt s}$ 两边对 v 求导，得：

$-sin(2\pi u_2)*2\pi*\frac{\partial u_2}{\partial v}=-\frac{uv}{s\sqrt s}$

解得：

$\frac{\partial u_2}{\partial v}=\frac{uv}{s\sqrt s *sin(2\pi u_2)*2\pi}$

(因为 $sin(2\pi u_2)=\frac{v}{\sqrt s}$ ，所以)

$=\frac{uv}{s\sqrt s *(v/\sqrt s)*2\pi}$

$=\frac{u}{2\pi s}$

同理，将 $sin(2\pi u_2)=\frac{v}{\sqrt s}$ 两边对 u 求导，可解得：

$\frac{\partial u_2}{\partial u}=\frac{-v}{2\pi s}$

所以：

$J=\begin{vmatrix} \frac{\partial u_1}{\partial u} &\frac{\partial u_1}{\partial v} \\ \frac{\partial u_2}{\partial u} &\frac{\partial u_2}{\partial v} \end{vmatrix}$

$=\begin{vmatrix}2u &2v \\ \frac{-v}{2\pi s} &\frac{u}{2\pi s} \end{vmatrix}$

$=\frac{u^2+v^2}{s\pi}$

(因为 $u^2+v^2=s$ ，所以)

$=\frac{1}{\pi}$

所以

$p_{U_1,U_2}(u_1,u_2)=|J|^{-1}p_{u,v}(u,v)$

$=|\frac{1}{\pi}|^{-1}*\frac{1}{\pi}$

$=1$

所以

$p_{U_1}(u_1)=\int_{-\infty}^{\infty}p_{U_1,U_2}(u_1,u_2)du_2$

(因为 U2 取值范围为 (0,1)，所以)

$=\int_{0}^{1}1du_2$

$=1$

同理

$p_{U_2}(u_2)=\int_{-\infty}^{\infty}p_{U_1,U_2}(u_1,u_2)du_1=\int_{0}^{1}1du_1=1$

故 U1，U2 均服从 U(0,1)。

又 $p_{U_1,U_2}(u_1,u_2)=p_{U_1}(u_1)*p_{U_2}(u_2)$ ，故 U1,U2 相互独立。

证毕。

**三，代码**

采用极坐标形式：

```
public Vector2 gaussianRandomVariablePair() {
		float x1, x2, w;
		do {
			x1 = 2f * Random.Range(0f,1f) - 1f;
			x2 = 2f * Random.Range(0f,1f) - 1f;
			w = x1 * x1 + x2 * x2;
		} while ( w >= 1f );
		w = Mathf.Sqrt((-2f * Mathf.Log(w)) / w);
		return new Vector2(x1 * w, x2 * w);
	}
```

**参考：**

[https://blog.csdn.net/weixin_41793877/article/details/84700875](https://blog.csdn.net/weixin_41793877/article/details/84700875)

[http://dept.stat.lsa.umich.edu/~moulib/426-notes-3.pdf](http://dept.stat.lsa.umich.edu/~moulib/426-notes-3.pdf)

[https://en.wikipedia.org/wiki/Box–Muller_transform](https://en.wikipedia.org/wiki/Box%E2%80%93Muller_transform)