主要内容：**预计算glossy材质下的环境光照 和 通过RSM算法来实现全局光照**

本文是闫令琪教授所教授的 Games-202:Real-Time High Quality Rendrting 学习笔记的第七讲 Real-Time Global Illumination (In 3D)，本人属于新手上路暂无驾照，有错误欢迎各位大佬指正.

[GAMES202 - 高质量实时渲染_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1YK4y1T7yY?p=7)

## Real-Time Global Illumination (in 3D)

全局光照是增强真实感的重要部分, 因此也是十分复杂的一部分.

从下图中我们会发现, 没有任何一处是全黑的看不见东西的, 比如书本的下方, 蜡烛内部等. 也就是光线 bounce 了很多次才到达我们的眼里, 在 GAMES101 中我们在布林冯模型中, 假设 ambient term, 认为来自四面八方的间接光照都是相同的, 且最后的 shading 和 normal 是无关的, 这样得到的结果是十分不真实的.

下图中的全局光照就不能这么假设了, 大家可以看到书本下方各位置的亮度不同, 还可以看到一些 caustics 等从金属球反射出的间接光, 他们之间是不一样的, 如果还做 Ambient term 那种假设从而只提升了一点亮度是无法得到图中的结果的.

**Overall, 全局光照很复杂.**

## **Reflective Shadow Map(RSM)**

![[9ebe091cb9361a52bad8173848c635ac_MD5.jpg]]

在实时渲染中, 全局光照是**比直接光照多一次 bounce 的间接光照.**

如图中, 光线弹射两次, 先打到红色的墙壁上, 在达到 box 面上, 最后被 camera/eye 看到, 这就是在 rtr 中要解决的所谓的 "全局光照".

我们希望他:

**①简单 -> 实现起来不麻烦**

**②快速 -> 因为全局光照非常难算**

![[7892b5fc089d2feb45acaa2a1f6e36bc_MD5.jpg]]

**我们通过这幅图来理解什么是一次 bounce 的间接光照:**

![[e7c0fc8110c059148c054456a3c3bc25_MD5.jpg]]

在 games101 lecture16 中我们讲 path tracing 时说, 在做 tracing 时, 从 camera 出发打出一条光线到点 P,P 点又往场景中不同的方向发射光线, 如果打到光源则表示接受的是**直接光照.**

如果没打到光源而是打到了点 Q, 那么我们认为 P 点接收到的光照是从 Q 点反射到 P 点的 Radiance, 也就是 Q 点接收到的直接光照所反射出的光照打到 P 点上.

点 Q 接受的是直接光照, 我们则认为接收到直接光照的表面可以被当作次级光源 (Secondary Light Sourse) 用自身反射的光照来照亮其他物体.

![[7272db0e3d700db34647c2685606082b_MD5.jpg]]

我们可以看到 P 点在柱子后面, 不可能接收到直接光照, 我们稀疏的标示出次级光源.

![[def7c012709fdb3a0d19310869b53be0_MD5.jpg]]

现在的 P 点就是所有标示次级光源反射出的光照来照亮 P 点所得到的结果。

![[a81eadd8dfac9018a70c95c5ff256f82_MD5.jpg]]

那么为了计算点 P 的 shading 需要知道什么？

**1：哪些表面会被直接照到？**

**2：如何计算每个 surface patch 对着色点 p 的贡献？**

**首先我们来解决问题 1-----> 哪些表面会被直接照到？**

这里可以使用 shadow map，shadow map 上每一个像素可以看成是一个小 surface patch。

![[cb37864c4dd13dbb60fd9a51eb4bf867_MD5.jpg]]

![[cf82a4b1ad0defef9010d4ac1dd8632c_MD5.jpg]]

## 假设: 所有的反射物 (次级光源) 都是 diffuse 的:

次级光源如果想照亮点 P, 观察方向是从 P 点去观察次级光源的, 也就是对于不同的 P 点来说出射方向是 unknown 的, 因此是无法计算 P 点的 shading 的, 为了不依赖于观察方向, 在 RSM 中我们假设，所有次级光源 (reflector) 都是 diffuse(这里是假设 reflector，没有要求 receiver 也是 diffuse)，故 outgoing radiance 在所有方向上都是 uniform 的, 这样不管从 camera 看过去还是从点 p 看过去所得到的结果是一样的.

**接下来我们来解决问题 2----------> 如何计算每个 surface patch 对着色点 p 的贡献？**

考虑所有 surface patch 的贡献，进行求和；并且每个 surface patch 可以看成是一个 area light。

在此我们需要复习一下 GAMES101 中的一些辐射度量学的知识:

![[6c60758809d997d6b796875c6b5a7b21_MD5.jpg]]

*   **Radiant Engery: 光能 --> 一个区域内光子能量的总和, 用 Q 来表示, 单位是焦耳 (J).**

![[051a2cb85f43bb4e101308084ba70dd1_MD5.jpg]]

*   **Radiant Flux: 光通量 --> 在单位时间内穿过单位截面积的光能.**

![[9c42837a46c70625d19d924000ec5b4a_MD5.jpg]]

*   **Radiant Intensity：一个单位立体角上对应的能量。(单位立体角上的光通量)**
*   **Irrdiance：在一个单位面积下对应的能量。(单位面积上的光通量)**
*   **Radiance：一个单位立体角下单位面积上的能量。(个人理解是, 单位立体角上通过单位投影面积的光通量)**

回到问题本身, 我们之前说过每一个小的 patch 都可能对照亮 p 点做出贡献, 因此我们可以先计算出一个 patch 做出的贡献, 之后用求和的形式将所有 patch 的贡献加在一起.

![[fe87d3d9f98021b041d4f87aa0cf87f1_MD5.jpg]]

我们可以看到 q 是一个 patch 去照亮点 P

q 其实就是 RSM 中一个 Texel 所对应的 patch, 在 games101 中我们说过, 原本计算 q 对 p 点的贡献, 我们应该是对整个立体角进行采样, 但是这样的话很浪费很多的 sample, 为何不直接在 light 处采样然后去计算 p 点的 shading 值呢.

![[d3ef30b418b849db92a51399ba3c963e_MD5.jpg]]

也就是把立体角的积分变成了对 light 区域面积的积分, 如果当区域足够小的时候 dA 甚至不用积分，直接相乘后相加就行, 现在我们要解的是 patch 在接受直接光照后反射出的 radiance 是多少, 也就是从 q 点到 p 点的 radiance, 那么如何解呢?

![[a8632c9547fa648e72256a821a9b5900_MD5.jpg]]

对于每个次级光源点来说, 由于我们假设它的 brdf 是 diffuse 的, 因此次级光源的 fr 积分后是个常数, 此时我们把 Li 代入到式子中会发现 dA 刚好会被抵消. 之后式子会少去 dA, 多了个 $\phi_{p}$ , 然后$\phi_{p}$ 和 $\frac{cos\theta_{p}cos\theta_{q}}{\left| \left|q - p \right| \right|^{2}}$ 又组成了下列公式中的 Ep 与剩余部分结合求出了一个次级光源 p 对着色点所得到的 shading 结果, 再将积分域中所有的结果加在一起, 就是着色点最后被间接光照照亮所得到的 shading 值.

![[4f46b930d7919c45ec10acd98522233b_MD5.png]]

公式求的是次级光源的光线贡献在着色点上的 Irradiance,Ep 表示次级光源对着色点贡献的入射 irradiance.

在此仍然存在一些问题:

次级光源能否看到着色点?

*   渲染方程中的 V 是指次级光源到着色点是否可见，如果想解决这个问题，需要为每个次级光源算一次 shadow map，这个运算不好算也是很难算的, 这个时候我们要学习乌鸦的精神:**" 难办, 那就别办了.**
*   值得注意的是原文公式中的分母是 4 次方，闫老师认为是作者考虑了次级光源发射的光线有衰减，这里应该是 2 次形式。(他们后来说闫老师吃键盘了, 我毕竟还没看到后面所以我先留着.) 更新: **闫老师确实吃键盘了, 但是老师没有错, paper 也没有错, 因为在分子中有两个 Xp-X，当把这两个放到分母中后，结果与我们推导的结果一致，同为 2 次方。**

![[4349ad391293d2efe75b48c4643753a9_MD5.jpg]]

由于可见性、方向性以及距离的不同，对于某一个着色点，认为 shadow map 上所有的 pixel 不可能都有贡献:

*   -Visibility（仍然非常难算）；
*   - 方向：比如 X-1 点在 SM 中记录的是桌子的表面，而且这个表面的点法线方向是朝上的，因此根本不可能照亮 X 点；
*   - 距离：因为远处的次级光源贡献很少，通常只要找距离足够近的次级光源就行了。

因此为了加速这一过程, 我们认为在 shadow map 中着色点 $x$ 的位置和间接光源 $x_p$ 的距离可以近似为它们在世界空间中的距离。所以我们认为，对着色点 $x$ 影响大的间接光源在 shadow map 中一定也是接近的。

于是我们决定先获取着色点 $x$ 在 shadow map 中的投影位置 $(s,t)$，在该位置附近采样间接光源，多选取一点离着色点近的 VPL，并且为了弥补越往外采样数越少可能会带来的问题，引入了权重，越近了权重越小，越远的权重越大。那么对于一个 shading point 差不多找 400 个次级光源来计算是比较合适的。如下图所示。

![[22460703afbf468da094b344ead8a937_MD5.jpg]]

**数据存储:**

RSM 在每一个像素 $p$ 中都需要存储深度值 $d_p$，世界坐标 $x_p$，法线 $n_p$，反射光功率$\phi _p$，如下图的可视化效果，四个 map 对应像素 p 的四个参数.

![[e64145f9c3a27bcc60c8831b9b276982_MD5.jpg]]

RSM 效果通常应用于游戏中手电筒的次级光照，如图:

![[96d94721b441e925d1265fe33774371d_MD5.jpg]]

在此可以更加理解我上文写的对于式子的理解

屋顶某个点亮了的区域就是手电筒直接照亮区域对屋顶那个点的贡献, 屋顶点积分的时候积分域就是手电筒直接照亮的位置.

**优点：**

*   易于实现

**缺点：**

*   性能随着直接光源数的增加而降低 (因为需要计算更多的 shadow map)
*   对于间接光照，没有做可见性检查
*   有许多假设：反射物需要是 diffuse 等
*   需要在质量和采样率上做一个平衡

  
全局光照这里, 其实是最折磨我的, 因为数学底子不好所以在理解 paper 中的式子时很难让我迷糊过来, 还好在看了很多大佬的笔记和咨询了大佬

[@沙滩 Beachc](https://www.zhihu.com/people/d12a94f4ac827bba2b25e1af2444b73f)

之后才让我恍然大悟, 计算机图形学真的是很难又很有趣........... 我还有很长的路要走啊.

**引用：**

[1] Reflective Shadow Maps - Carsten Dachsbacher, Marc Stamminger

[2] GAMES202 - 高质量实时渲染 - 闫令琪

[3] GAMES202 高质量实时渲染笔记 Lecture07：Real-Time Global Illumination (In 3D) - 沙滩 beachc

[4] 【论文复现】Reflective Shadow Maps

[Monica 的小甜甜：【论文复现】Reflective Shadow Maps](https://zhuanlan.zhihu.com/p/357259069)