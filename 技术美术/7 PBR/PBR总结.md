**PBR 是指使用基于物理原理和微平面理论建模的着色/光照模型，以及使用从现实中测量的表面参数来准确表示真实世界材质的渲染理念。**

**三大组成部分：**
1. 基于物理的材质（Material）
2. 基于物理的光照（Lighting）
3. 基于物理的摄像机（Camera）


物理渲染（Physical Rendering）是指跟真实世界完全一致的计算机渲染效果。基于现阶段的知识水平和硬件水平，还不能渲染跟真实世界完全一致的效果，只能一定程序上模拟接近真实世界的渲染画面，故而叫**基于物理的渲染**（**Physically Based Rendering**），而非**物理渲染**（**Physical Rendering**）。

相比传统的 Lambert 着色和 Phong 着色，PBR 着色在效果上有着质的提升，可以表示更多更复杂的材质特征：

*   表面细节
*   物体粗糙度
*   区别明显的金属和绝缘体
*   物体的浑浊程度
*   菲涅尔现象：不同角度有不同强度的反射光
*   半透明物体
*   多层混合材质
*   清漆效果
*   其它更复杂的表面特征

# PBR 基础基础理论和推导
满足以下条件的光照模型才能称之为 PBR 光照模型（基于物理的材质三大条件）：
*   基于微平面理论的表面模型（Be based on the microfacet surface model）。
*   能量守恒（Be energy conserving）。
*   使用基于物理的双向反射分布函数BRDF（Use a physically based BRDF）。

## 微表面理论
**微平面理论**是将物体表面建模成无数微观尺度上有随机朝向的**理想镜面反射**的小平面（microfacet）的理论。

> [!NOTE] 理想镜面反射
> 理想镜面反射即严格遵循反射定律，反射角等于入射角

光在与非光学平坦表面（Non-Optically-Flat Surfaces）的交互时，非光学平坦表面表现得像一个微小的光学平面表面的大集合。表面上的每个点都会以略微不同的方向对入射光反射，而最终的表面外观是许多具有不同表面取向的点的聚合结果。


![[Pasted image 20230703155510.png]]
>微平面理论：在微观尺度上，表面越粗糙，反射越分散。表面越光滑，反射越集中，就会有更明显的高光。

从微观角度来说，没有任何表面是完全光滑的。由于这些微平面已经微小到无法逐像素地继续对其进行细分，因此我们只有假设一个 Roughness 参数，然后用**统计学方法**来概略的估算微平面的粗糙程度。
我们可以基于一个平面的粗糙度来计算出某个向量的方向与微平面平均取向方向一致的概率。这个向量便是位于光线向量 $l$ 和视线向量 $v$ 之间的中间向量，被称为**半角向量 (Halfway Vector)**。  

![[1679148476577.png##pic_center]]
$$h = \frac{l + v}{\|l + v\|}$$

我们可以基于一个平面的粗糙度来计算出某个向量的方向与微平面平均取向方向一致的概率。这个向量便是位于光线向量 $l$ 和视线向量 $v$ 之间的中间向量，被称为**半角向量 (Halfway Vector)**。  

## 能量守恒
**能量守恒** ：出射光线的能量永远不能大于入射光线的能量。

当光线折射进入内部的时候会与物体的微小粒子不断发生碰撞并散射到随机方向，同时在碰撞的过程中一部分光线的能量会被吸收转换为热能，有些光线在多次碰撞之后能量消耗殆尽，则表示该光线完全被物体吸收。
还有一部分折射到物体内部的光线会因为散射方向的随机性重新离开表面，而这部分光线就形成了漫反射。

![[Pasted image 20230703155647.png]]

通常情况下，PBR 会简化折射光，将平面上所有折射光都视为被完全吸收而不会散开。而有一些被称为次表面散射 (Subsurface Scattering) 技术的着色器技术会计算折射光散开后的模拟，它们可以显著提升一些材质（如皮肤、大理石或蜡质）的视觉效果，不过性能也会随着下降。

金属 (Metallic) 材质会立即吸收所有折射光，故而金属只有镜面反射，而没有折射光引起的漫反射。

回到能量守恒话题。被表面反射出去的光无法再被材质吸收。故而，**进入材质内部的折射光就是入射光减去反射光后余下的能量。**

![[Pasted image 20230703155640.png]]
>基于微平面理论，我们可以观察到随着粗糙度的上升镜面反射区域的面积会增加。
>基于能量守恒，我们可以观察到镜面反射区域的平均亮度则会下降。

## 渲染方程与双向反射分布函数（BRDF）
#### 渲染方程
如何实现能量守恒➡渲染方程

> [!NOTE]
> 我们定义：
>- 入射光方向为点到光源的方向
> - 出射光方向为点到摄像机的方向
> 

![[Pasted image 20230703155835.png]]

某一点 p 的渲染方程如下：

PBR 的反射方程可抽象成下面的形式：

$$L_o(p,\omega_o) = \int\limits_{\Omega} f_r(p,\omega_i,\omega_o) L_i(p,\omega_i) n \cdot \omega_i d\omega_i$$


![[Pasted image 20230703155823.png]]

![[Pasted image 20230703155826.png]]

实时渲染中，我们常用的是渲染方程的简化的版本：
![[Pasted image 20230703155848.png]]
>简单地说就是近似计算在一个给定了属性的不透明表面上每个单独的光线对最终的反射光的贡献量。


#### BRDF
光强度信息我们从基于物理的光照中可以拿到
其他参数比较好计算，**我们还要知道反射比例是多少，这就需要使用 BRDF**


BRDF 描述了入射光反射后在各个方向如何分布。
![[Pasted image 20230703155918.png]]

Diffuse BRDF 可以分为传统型和基于物理型两大类。其中，传统型主要是众所周知的 Lambert。而基于物理型，从 1994 年的 Oren Nayar 开始，到现在较新的有 GDC 2017 上提出的适用于 GGX+Smith 的基于物理的漫反射模型（PBR diffuse for GGX+Smith），在 SIGGRAPH2018 上提出的，来自《使命召唤：二战》的多散射漫反射 BRDF（MultiScattrering Diffuse BRDF）。

在实时渲染中，会有两种光对物体表面造成影响，分别是直接光和间接光，分为四个部分。
- **直接光的漫反射**
- **直接光的高光反射**
- 间接光的漫反射
- 间接光的高光反射

**Cook-Torrance BRDF：**

![[Pasted image 20230703160015.png]]

将 Cook-Torrance 带入渲染方程可得：

![[Pasted image 20230703160024.png]]
![[Pasted image 20230703160030.png]] 是漫反射项，c 为反射率 Albedo
![[Pasted image 20230703160036.png]] 是高光反射项
DFG 分别是三个函数，n 表示粗糙度
D：法线分布函数
F：菲涅尔项
G：几何遮蔽函数

实时渲染中，基于物理的光照模型，漫反射部分依然采用 lambert 算法，已经可以取得不错的效果。
这里的 ks 表示镜面反射所占百分比，kd=1-ks 表示漫反射所占百分比
更多的细节都在高光反射部分。

**Cook-Torrance BRDF —— D 法线分布函数**

主流的的法线分布函数是 GGX（Trowbridge-Reitz），因为具有更好的高光长尾：
![[Pasted image 20230703160117.png]]
![[Pasted image 20230703160122.png]]
>D 法线分布函数：描述的是微表面的法线方向与半角向量对齐的概率，如果对齐那么认为该反射光可以被看到，否则没有。

α：粗糙度
m：半角向量
n：法线向量

Blinn-Phong 模型主要考虑的还是法线对反射比例的影响
右图可见，GGX 算法的结果更加狭长，实验的数据也证实了 GGX 的算法更符合真实情况（绿色为 GGX）
![[Pasted image 20230703160130.png]]


**Cook-Torrance BRDF ——F 菲涅尔项：**

菲涅尔反射：视线垂直于表面时，反射较弱，而当视线非垂直表面时，夹角越小，反射越明显。反映了反射/折射与视点角度之间的关系。如果你站在湖边，低头看脚下的水，你会发现水是透明的，反射不是特别强烈；如果你看远处的湖面，你会发现水并不是透明的，但反射非常强烈。这就是“菲涅尔效应”。
![[Pasted image 20230703160302.png]]
![[Pasted image 20230703160305.png]]
菲涅尔（Fresnel）方程很复杂，计算量很大，实时渲染中广泛采用 Schlick 的 Fresnel 近似，因为计算成本低廉，而且精度足够：
![[Pasted image 20230703160214.png]]
>R0：平面基础反射率。大多数常见电介质的 F0 范围为 0.02-0.05（线性值），对于导体，R0 范围为 0.5-1.0。


**Cook-Torrance BRDF ——G 几何遮蔽函数**
G：我们是使用微平面理论，也就是说每个面单独计算互不干扰。但现实世界中，物体的表面的凹凸存在相互遮蔽的情况。主要受粗糙度影响
因此，几何函数从统计学上近似的求得了微平面间相互遮蔽的比率这种相互遮蔽会损耗光线的能量。(除了被吸收，还有被自身遮蔽带来的能量损耗）

![[Pasted image 20230703160450.png]]
计算 G 项的方案有很多，虚幻引擎使用的是 Schlick-GGX，
基于 Schlick 近似，将 k 映射为 k=a/2，去匹配 GGX Smith 方程
![[Pasted image 20230703160317.png]]
![[Pasted image 20230703160320.png]]

![[Pasted image 20230703160437.png]]
>可以得到如下所示不同粗糙度的视觉效果 0: 没有微平面阴影    1：微平面彻底被遮蔽
