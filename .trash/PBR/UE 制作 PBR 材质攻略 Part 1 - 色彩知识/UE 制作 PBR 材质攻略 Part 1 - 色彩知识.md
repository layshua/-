目录

*   [**一、前言**](#一前言)
*   [**二、色彩知识**](#二色彩知识)
    *   [**2.1 色彩理论**](#21-色彩理论)
        *   [**2.1.1 成像原理**](#211-成像原理)
        *   [**2.1.2 色彩模型和色彩空间**](#212-色彩模型和色彩空间)
            *   [**2.1.2.1 CIE 1931 XYZ**](#2121-cie-1931-xyz)
            *   [**2.1.2.2 LAB**](#2122-lab)
            *   [**2.1.2.3 RGB**](#2123-rgb)
            *   [**2.1.2.4 HSV**](#2124-hsv)
            *   [**2.1.2.5 CMYK**](#2125-cmyk)
            *   [**2.1.2.6 YUV**](#2126-yuv)
        *   [**2.1.3 色彩属性**](#213-色彩属性)
            *   [**2.1.3.1 色环**](#2131-色环)
            *   [**2.1.3.2 色阶**](#2132-色阶)
            *   [**2.1.3.3 色纯**](#2133-色纯)
            *   [**2.1.3.4 色温**](#2134-色温)
            *   [**2.1.3.5 对比度**](#2135-对比度)
            *   [**2.1.3.6 清晰度**](#2136-清晰度)
            *   [**2.1.3.7 锐利度**](#2137-锐利度)
        *   [**2.1.4 直方图**](#214-直方图)
        *   [**2.1.5 色调曲线**](#215-色调曲线)
        *   [**2.1.6 线性空间与 Gamma 空间**](#216-线性空间与gamma空间)
        *   [**2.1.7 HDR 和色调映射**](#217-hdr和色调映射)
    *   [**2.2 颜色操作**](#22-颜色操作)
        *   [**2.2.1 基础操作**](#221-基础操作)
            *   [**2.2.1.1 颜色相加**](#2211-颜色相加)
            *   [**2.2.1.2 颜色相乘**](#2212-颜色相乘)
        *   [**2.2.2 颜色插值**](#222-颜色插值)
            *   [**2.2.2.1 线性插值**](#2221-线性插值)
            *   [**2.2.2.2 S 插值**](#2222-s插值)
            *   [**2.2.2.3 其它插值**](#2223-其它插值)
        *   [**2.2.3 颜色混合**](#223-颜色混合)
    *   [**2.3 常用曲线**](#23-常用曲线)
        *   [**2.3.1 线性曲线**](#231-线性曲线)
        *   [**2.3.2 指数曲线**](#232-指数曲线)
        *   [**2.3.3 三角函数**](#233-三角函数)
        *   [**2.3.4 贝塞尔曲线**](#234-贝塞尔曲线)
        *   [**2.3.5 Catmull–Rom 曲线**](#235-catmullrom曲线)
        *   [**2.3.6 其它曲线**](#236-其它曲线)
*   [**特别说明**](#特别说明)
*   [**参考文献**](#参考文献)

# **一、前言**

首先申明：这是一篇涵盖技术、美术、审美、摄影等知识的文章，不是纯粹的技术文章！！准确地说是一篇 TA 向的文章。

可能有些人会好奇，笔者乃一介码夫，为何会涉及摄影、美术、TA 的领域。

其实跟个人的兴趣爱好有关。笔者虽当了多年码农，本该潜心钻研技术，奈何禁不住心中对美的追求，玩起了摄影，并且一玩就是好几年，也拍了一些能拿得出手的作品。

![](1679151991447.png)

_作品《余荫阁 • 秋思》，2019 年 9 月摄于余荫山房，出镜：宝儿_

![](1679151991508.png)

_作品《九尾狐仙》，2019 年 4 月摄于鹤之洲，出镜：冰冰_

![](1679151991544.png)

_作品《粉色的记忆》，2019 年 1 月摄于中山影视城，出镜：婷婷_

![](1679151991698.png)

_作品《超跑与美女》，2019 年 1 月摄于某超跑俱乐部，出镜：血狼_

这几年，对摄影艺术有了一定的认知，并且艺术是相通的，摄影艺术跟图形渲染的美术艺术有着千丝万缕的联系。笔者在实际工作中，也会尝试去利用摄影接触的艺术知识引入其中，最直接的体现就是用 UE 制作 PBR 材质。久而久之，有了不少心得体会，于是斗胆撰写了此篇文章。

当然，这**不是一篇入门教学**，要求读者了解 UE，接触过 PBR 材质。比较适合阅读的人群：

*   美术
*   TA
*   程序员（对材质底层和艺术感兴趣）
*   摄影师（对游戏引擎、摄影基础感兴趣）
*   其他（对 UE 材质感兴趣）

如果对 UE 或 UE 的材质系统不熟悉，建议直接阅读 [UE 官方文档](https://docs.unrealengine.com/zh-CN/index.html)和[材质系统](https://docs.unrealengine.com/zh-CN/Engine/Rendering/Materials/index.html)。

# **二、色彩知识**

本章不涉及 PBR 相关的讲解，先详细地讲解一些前置知识 -- 色彩的原理、理论、操作，为后面 PBR 的制作奠定基础。毫不夸张地说：**只有扎实地掌握了颜色的基础理论和操作，才能更好地制作出真实且美观的 PBR 材质，进而更好地为产品服务。**

## **2.1 色彩理论**

色彩就是颜色，本质是人眼能够感知的可见光。本节将重点介绍色彩相关的知识和理论。

### **2.1.1 成像原理**

光的本质是在可见光频段（波长在 380nm~780nm）的单一或复合电磁波。

![](1679151991880.png)

虽然真实物理世界的光绝大多数是连续的复合光，但人眼能够感知的光波长分别是**红**（Red，波长为 700nm）、**绿**（Green，波长为 546.1nm）、**蓝**（Blue，波长为 438.8nm）的光，其它颜色皆由这三种原色光混合而成。

![](1679151991913.png)

_上图的上部分是自然界存在的连续的自然光，下部分是离散的红、绿、蓝光，刚好跟人类视觉成像原理匹配，所以人类无法发现它们之间的差别。也就是说，人类的视觉是有损的，将无限维度的复合光简化成了三维视觉空间。_

人眼见到的颜色不仅取决于光源的颜色，还取决于物体的表面特征，如颜色反射率、粗糙度、导电性、各向异性等等，最直观的是颜色反射率。

![](1679151992171.png)

_一束白光（复合光）照在成熟的苹果表面上，由于苹果表面吸收了除红色以外的光，反射较多红色光，使得其表面呈现红色的特征。_

**这些物体的表面特征就是 PBR 材质研究的范畴**，也是本文要重点研究和阐述的对象。后续章节将会重点介绍 PBR 抽象出的属性和特性。

最简单、最直接的光照公式如下：

$$人眼感知的物体颜色 = 光源颜色 * 物体表面颜色反射系数$$

但是以上公式只考虑了光源和物体表面反射系数，实际上，还需要考虑粗糙度、导电性、各向异性、透明度等等因素，可扩展一下，加入$衰减因子$，以涵盖其它因素对物体表面反射系数的影响：

 

$$人眼感知的物体颜色 = 光源颜色 * (物体表面颜色反射系数 * 衰减因子)$$

其中$衰减因子$的计算决定了以上公式是基于物理的还是基于经验值或是其它模式的，也决定了渲染效果的真实可信度。例如，Cook-Torrance 就是一种计算高光反射衰减因子的 PBR 光照模型：

 

$$人眼感知的物体高光颜色 = 光源颜色 * (物体表面颜色反射系数 * 衰减因子_{Cook-Torrance})$$

### **2.1.2 色彩模型和色彩空间**

**色彩模型**是用一定规则来描述（排列）颜色的方法。常见的色彩模型有 RGB、HSV、HSL、LAB、CYMK 等。

然而，色彩模型无法确切地描述颜色的具体信息和含义，例如：RGB 模型用规定红、绿、蓝 3 个分量描述颜色，然而并没有确定红色、绿色、蓝色到底是什么波长亮度多少的光，更无法描述它们能够表达的范围。

这就需要引入**色彩空间**，以确切地描述色彩模型的具体信息和含义。比如，使用 RGB 色彩模型的 sRGB 色彩空间最大红色的定义就是 CIE XYZ: 0.4360657, 0.2224884, 0.013916。其中 CIE XYZ 是一个特殊的色彩空间，根据人眼三刺激值实验测试结果而建立。

一个色彩模型下可以有多个不同的色彩空间，它们根据排列的条件的不同会有不同的色域（所能表示色彩的范围）和含义，色彩模型只有具体到一种色彩空间上才有实用性。例如，RGB 色彩模型下有 sRGB、Adobe RGB、ProPhoto RGB 等色彩空间。

#### **2.1.2.1 CIE 1931 XYZ**

**CIE 1931 XYZ 色彩空间**（也叫做 **CIE 1931 色彩空间**）是其中一个最先采用数学方式来定义的色彩空间，它由国际照明委员会（CIE）于 1931 年创立。

CIE XYZ 色彩空间是从 1920 年代后期 W. David Wright 和 John Guild 做的一系列实验中得出的。他们的实验结果合并到了 CIE RGB 色彩空间的规定中，CIE XYZ 色彩空间再从它得出。

这种色彩空间是基于 RGB 三原色测量而成，刚好覆盖所有人类可见的色彩范围（下图）。

![](1679151992326.png)

#### **2.1.2.2 LAB**

**Lab 色彩空间**（**Lab color space**）是颜色 - 对立空间，带有维度 **L** 表示亮度，**a** 和 **b** 表示颜色对立维度，基于了非线性压缩的 CIE XYZ 色彩空间坐标。

不像 RGB 和 CMYK 色彩空间，Lab 颜色被设计来接近人类视觉。它致力于感知均匀性，它的 L 分量密切匹配人类亮度感知。因此可以被用来通过修改 a 和 b 分量的输出色阶来做精确的颜色平衡，或使用 L 分量来调整亮度对比。这些变换在 RGB 或 CMYK 中是困难或不可能的——它们建模于物理设备的输出，而不是人类的视觉感知。

对于不同的亮度值 L，所呈现的二维图将有较大差异：

![](1679151992403.png)

#### **2.1.2.3 RGB**

RGB 色彩模型采用与人眼成像原理相似的 R、G、B 分量表达颜色，是一种在黑色介质上叠加色彩原色的模型。

![](1679151992455.png)

RGB 呈现的立体色彩三维图如下，是面向设备的一种色彩模型，当今的绝大多数显示设备都采用 RGB 色彩模型。

![](1679151992535.png)

RGB 色彩模型下拥有较多的色彩空间，常见的有 sRGB、AdobeRGB、ProPhotoRGB 等，它们能够表达的色域范围依次递增（下图）。

![](1679151992640.png)

**sRGB 色彩空间**是惠普与微软于 1996 年一起开发的用于显示器、打印机以及因特网的一种标准 RGB 色彩空间。这种标准得到了 W3C、Exif、英特尔、Pantone、Corel 以及其它许多业界厂商的支持。也是目前应用和支持得最广泛的一种色彩空间。

sRGB 使用的是 Gamma 校准系数为 **2.2** 的色彩空间，也是 CRT 显示器在这种情况下的平均线性电压响应。

sRGB 中定义的 R、G、B 及白色分别位于 CIE xy 颜色坐标系中的 [0.6400, 0.3300]、[0.3000, 0.6000]、[0.1500, 0.0600]、[0.3127,0.3290] 的 D65。（下图）

![](1679151992721.png)

**Adobe RGB 色彩空间**是一种由 Adobe Systems 于 1998 年开发的色彩空间。开发的目的是为了尽可能在 CMYK 彩色印刷中利用计算机显示器等设备的 RGB 颜色模式上囊括更多的颜色。Adobe RGB 色彩空间包括了约 50% 的 Lab 色彩空间中的可视色彩，主要在青绿色（cyan-green）色系上有所提升。

Adobe RGB 中定义的 R、G、B 及白色分别位于 CIE xy 颜色坐标系中的 [0.6400, 0.3300]、[0.2100, 0.7100]、[0.1500, 0.0600]、[0.3127,0.3290] 的 D65。（下图）

![](1679151992802.png)

#### **2.1.2.4 HSV**

由于 RGB 是面向显示设备的色彩模型，对人眼来说，难以分辨各个分量合成的颜色。例如，50% 的红色分量和 80% 的绿色混合后的颜色，人类无法快速感知。

于是引入了 HSV 色彩模型，以便人类更加方便描述和感知色彩。

**HSV** 分别代表了 **H**ue（色相）、**S**aturation（饱和度）、**V**alue（明度），是一种面向人类的色彩模型。它的色彩三维图如下：

![](1679151992930.png)

HSV 的值可由 RGB 三原色计算出来，具体过程如下：

设 $(r, g, b)$分别是一个颜色的红、绿和蓝坐标，它们的值是在 $0.0$到 $1.0$之间的实数，设 $max$等价于 $r$, $g$和 $b$中的最大值，设 $min$等于这些值中的最小值。要找到在 HSV 空间中的 $(h, s, v)$值，这里的 $h$ ∈$[0, 360)$度是角度的色相角，而 $s, l ∈ [0.0,1.0]$是饱和度和明度，计算公式：

![](1679151993036.png)

![](1679151993116.png)

$$v = max$$

同样地，HSV 坐标空间的颜色也可以转成 RGB 坐标空间：

![](1679151993201.png)

HSV 也被称为 **HSB**，与之相类似的还有 **HSL**（色相、饱和度、亮度）。它们都是面向人类的色彩模型，区别仅仅是饱和度、亮度的定义略有不同（下图）。

![](1679151993251.png)

HSV 广泛地应用在 DDC 软件中的颜色选取、变色及其它颜色操作中，也是 UE 和 UE 材质编辑器中最常用的一种色彩模型。

![](1679151993299.png)

_UE 的颜色拾取器，上半部分是 HSV 图形选择界面，下半部分左侧是 RGB 色彩模型的值，半部分右侧是 HSV 色彩模型的值。_

#### **2.1.2.5 CMYK**

**CMYK** 分别代表 **C**yan（青色）、**M**agenta（洋红、品红）、**Y**ellow（黄色）、Blac**k**（黑色），是一种在白色介质上吸收原色色彩的模型，常用于印刷。

![](1679151993409.png)

#### **2.1.2.6 YUV**

**YUV** 是电视等数码领域常用的一种色彩空间，“Y” 表示**明亮度**（Luminance、Luma），“U”和 “V” 则是**色度**、**浓度**（Chrominance、Chroma）。Y'UV, YUV, YCbCr，YPbPr 等专有名词都可以称为 YUV。

以下是 YUV 色彩空间的 UV 分布图：

![](1679151993484.png)

Y′UV, YUV, YCbCr, YPbPr 所指涉的范围，常有混淆或重叠的情况。从历史的演变来说，其中 YUV 和 Y'UV 通常用来编码电视的模拟信号，而 YCbCr 则是用来描述数字的影像信号，适合影片与图片压缩以及传输，例如 MPEG、JPEG。 但在现今，YUV 通常已经在计算机系统上广泛使用。

若将图片分解成 YUV 各分量，可得到以下的画面：

![](1679151993590.png)

_最上是正常的图片，下面三幅图分别是分解出来的 Y、U、V 分量图。_

除了以上色彩模型和色彩空间，实际上还有很多其它的色彩模型和空间，但与 PBR 关联较强的只有 RGB 和 HSV 色彩模型。故其它不在此讨论，有兴趣的可以查阅这篇文章：[深入理解 color model(颜色模型)](https://www.jianshu.com/p/f03e9ac9c9ef)。

### **2.1.3 色彩属性**

#### **2.1.3.1 色环**

**色环**也叫**色轮**，其实就是 HSV 或 HSL 中的**色相**分量，可由一个 2D 的圆形表示出来（下图）。

![](1679151993669.png)

其中 0 度是红色，60 度是黄色，120 度是绿色，180 度是青色，240 度是蓝色，300 度是品红。

在色环中，相距 60 度以内的色彩被称为**相邻色**，也被称为**类似色**；相距 100~179 度的色彩被称为**对比色**；相距 180 度的色彩被称为**互补色**。例如，对于红色，它的相邻色是黄色和品红，对比色是绿色和蓝色，互补色是青色。

在色环中，常见的 RGB 和 CYM 的相邻和互补色如下图：

![](1679151993735.png)

在色环中，还存在**冷暖色系**，代表着相同物体在不同温度下所发出的颜色，也代表着其它很多含义（活泼度、紧张度、情绪度、强烈度、夸张度、食欲度、成熟度等等）。其中，**暖色**代表物体温度较低时发出的颜色，以橙色为中心的半圆；**冷色**是物体温度较高时发出的颜色，以蓝色为中心的半圆：

![](1679151993977.png)

在良好的色彩搭配当中，色彩数量不宜过多，控制在 3 种以内；色彩之间搭配合理、得当，充分利用相邻色、互补色及冷暖调以达到画面的统一、和谐或增加对比度、冲击力。

![](1679151994057.png)

_上图大面积的冷色表明了山湖环境的宁静和寒冷，而小范围的暖色突出了屋子灯光的暖和，强烈的冷暖对比给人以高反差的视觉观感。_

当然实际应用中，不宜受条条框框的限制，应以主题为目标，充分发挥色环的作用。更多色彩搭配理论推荐阅读：[《色彩设计的原理》](https://item.jd.com/10851918.html)。

UE 材质编辑器提供了色相修改节点`HueShift`：

![](1679151994103.png)

#### **2.1.3.2 色阶**

**色阶**反应了 HSV 色彩模型的分量 V：明度，表达了人眼能够感受到的色彩的亮度级别。

值得一提的是，人眼对 R、G、B 三原色的亮度感知程度是不一样的。绿色提供最多的亮度贡献值，红色、蓝色次之，可用以下公式表达：

 

$$颜色亮度 = R*0.3 + G*0.6 + B*0.1$$

仔细观察上述公式，可发现 R、G、B 的 3 个亮度贡献值相加刚好为 $0.3+0.6+0.1=1.0$，这也保证了能量守恒。

在摄影学中，通常将颜色的亮度划分为若干等分，每个等分跨度一致，一个等分成为**色阶**。

![](1679151994386.png)

其中亮度靠近黑色的色阶被称为**暗调**（low tone，也叫低调、阴影、黑色、黑场），亮度位于中间的色阶被成为**中调**（mid tone，也叫中间调、曝光），亮度靠近白色的被称为**亮调**（high tone，也叫高调、白色、高光、白场）。

至于色阶被划分的数量及命名并没有统一的规定。例如，Photoshop 的 Camera Raw 中，将色阶划分为：高光、亮调、暗调、阴影：

![](1679151994444.png)

而 Light Room 中，将色阶划分为：白色、高光、曝光、阴影、黑色。

![](1679151994519.png)

虽然划分和名称不一，但我们只需要记住：靠近黑色的是低调，中间部分是中调，靠近白色的是高调。

理解和掌握色阶色调，有助于操作 PBR 材质、后处理、色调映射、颜色操作等。例如，如果需要对 PBR 的漫反射贴图进行调整，而且需要对各个色阶进行精确控制，则可以用 UE 的材质节点`3PointLevels`：

![](1679151994593.png)

上图中的`Black Value`、`Middle Value`、`White Value`分别代表暗调、中调、亮调。

#### **2.1.3.3 色纯**

**色纯**也叫**色彩饱和度**，表达了色纯的鲜艳程度。纯度越高，色彩越艳越浓，纯度越低则色彩变灰变淡。

![](1679151994624.png)

上图从左到右饱和度依次降低，可以看见，饱和度越高，色彩越浓越艳丽，饱和度越低，色彩趋向灰白色。

利用饱和度的这种特点，可以将画面分为高饱和、中饱和、低饱和画面，分别代表着不同的风格和意义。比如，高饱和画面充满激情、热烈，但不耐看，容易视觉疲劳；低饱和画面代表冷淡、平静，但也会给人一种压抑的感觉。

![](1679151994678.png)

_相同的画面，由于左边饱和度低，给人以压抑和情绪感；而右边饱和度高，给人以清新明丽的感觉。[图片来源](https://www.weibo.com/ttarticle/p/show?id=2309404398272885162046)_

所以，充分利用色彩纯度，可以突出色彩的作用和画面的风格。

UE 材质编辑器也提供了相应节点，可方便地调整饱和度：

![](1679151994774.png)

#### **2.1.3.4 色温**

**色温**是可见光在摄影、录像、出版、图形渲染等领域具有重要应用的特征。光源的色温是通过对比它的色彩和理论的热黑体辐射体来确定的。在摄影学中，也被称为**白平衡**。

下面是黑体物质在温度慢慢升高的颜色变化图：

![](1679151995104.png)

但是，上图只是近似变化图，实际上，发光物体的色温跟很多因素有关，计算公式可由**普朗克辐射定律（Planck's Radiation Law）**描述：

$$U(λ,T) = \frac{8\pi hcλ^{-5}} { e^{\frac{hc}{λkT}}-1 }$$

公式中各符号代表的意义如下：

*   $U$ - 辐射能量
*   $λ$ - 电磁波波长，单位：米
*   $T$ - 温度，单位开尔文（Kelvin）
*   $h$ - 普朗克常量，值为 $6.626×10^{-34} J·s$
*   $k$ - 波尔兹曼常量，值为 $1.381×10^{-23} J·K^{-1}$
*   $c$ - 真空光速，值为 $3.0 × 10^8 m \cdot s^{-1}$

在生活中，常见发光物体对应的色温如下表：

<table><thead><tr><th style="text-align: right">色温</th><th>发光物体</th></tr></thead><tbody><tr><td style="text-align: right">1700 K</td><td>火柴光</td></tr><tr><td style="text-align: right">1850 K</td><td>蜡烛</td></tr><tr><td style="text-align: right">2800 K</td><td>钨灯（白炽灯）的常见色温</td></tr><tr><td style="text-align: right">3000 K</td><td>卤素灯及黄光日光灯的常见色温</td></tr><tr><td style="text-align: right">3350 K</td><td>演播室 “CP” 灯</td></tr><tr><td style="text-align: right">3400 K</td><td>演播室台灯,、照相泛光灯（不是闪光灯）等...</td></tr><tr><td style="text-align: right">4100 K</td><td>月光、浅黄光日光灯</td></tr><tr><td style="text-align: right">5000 K</td><td>日光</td></tr><tr><td style="text-align: right">5500 K</td><td>平均日光、电子闪光（因厂商而异）</td></tr><tr><td style="text-align: right">5770 K</td><td>有效太阳温度</td></tr><tr><td style="text-align: right">6420 K</td><td>氙弧灯</td></tr><tr><td style="text-align: right">6500 K</td><td>最常见的白光日光灯色温</td></tr><tr><td style="text-align: right">9300 K</td><td>电视屏幕（模拟）</td></tr></tbody></table>

5000K 和 6500K 的黑体的颜色分别接近于普通 D50 和 D65 的发光物，这通常用于颜色再现的场合（摄影、出版，等等）。在摄影中，5000K 又是最常作为太阳发出的白色光色温。

同一张画面，不同的色温将呈现出不同的效果：

![](1679151995151.png)

_左图是正常色温画面，右图是色温偏向暖调，给人以太阳强烈照射的暖色感。_

在 UE 中，灯光可通过属性面板开启色温调节，以模拟不同类型的发光源：

![](1679151995311.png)

#### **2.1.3.5 对比度**

**对比度（Contrast）**是描述整副图像的明暗反差程度，反映的是色彩的明度（亮度）关系。

对比度越高，明暗反差越明显，暗部更加暗，亮部更加亮（下图）。

![](1679151995412.png)

_左图通过加强对比度之后，形成明暗反差更加强烈的右图。_

适当提高对比度可增加画面的冲击力，提升画面的通透度，但同时，要注意过犹不及，过高的对比度，会出现死黑和死白现象，导致画面诡异或不合理。

UE 材质编辑器也提供了对比度调整节点`CheapContrast`：

![](1679151995699.png)

#### **2.1.3.6 清晰度**

**清晰度（Clarity）**是反映画面的可识别度和可辨别度。清晰度越高的照片，能呈现的细节越多，反之，图片将变得越模糊。

![](1679151995788.png)

_左图是正常清晰度的照片，右图降低了清晰度，显而易见，图片变得非常模糊不清。_

同样地，UE 材质编辑器也有相应节点调整颜色清晰度：

![](1679151995836.png)

#### **2.1.3.7 锐利度**

**锐利度（Sharpness）**跟清晰度比较类似，但也有区别。清晰度反映的是画面像素之间的反差程度，而锐利度反映的是画面轮廓或边缘的反差程度。更通俗地说，清晰度表述的是**所有**像素，而锐利度只表述轮廓、边缘或反差较大的**局部**像素。

![](1679151995936.png)

_右图经过提升锐利度后，脸部、头发、衣服、草丛等的边缘和轮廓变得更加清晰了。_

可能有人会疑惑：**色彩既然有了清晰度的属性为什么还需要锐利度？**

从摄影学上更好回答这个问题：对含有人物（特别是美女）的画面，为了使画面更加美观，往往不需要在皮肤上增加清晰度，只需要在脸部和五官轮廓处增加，而锐利度恰好符合这一特点，使得摄影师或者设计师能够快速地得到美观而清晰的画面。

在 Photoshop 中，增加锐利度的方法有很多，常见的有：USM 锐化、边缘锐化、智能锐化、高反差保留等等。

![](1679151996017.png)

在 UE 材质编辑器中，也有材质节点增加锐利度：

![](1679151996138.png)

上图的`HighPass`就是 PS 里的高反差保留锐化。

对 UE 渲染的画面而言，在后处理节点执行锐化是非常有必要的。因为 UE 默认采用了延迟着色模式并且开启了 TAA（时间抗锯齿），而 TAA 算法的特性会导致画面变模糊，在最后阶段增加锐利度，可一定程度上抵消 TAA 带来的画面模糊，提升画面通透度和美观感。

### **2.1.4 直方图**

**直方图**是反应一副图像中所有像素在各个亮度色阶的数量分布情况。

通常情况下，直方图左侧是暗调，中间是中调，右边是亮调。例如，下图左侧是一副正常后期过的图片，它对应的直方图在右上角。

![](1679151996328.png)

通过直方图，我们可以清晰地观察到，上述图片大量像素亮度集中在高调部分，属于一副高调风格的片子。此外，还可以通过调整色阶，实时查看图片的直方图以观察整副图片的亮度变化情况。

### **2.1.5 色调曲线**

**色调曲线**（Tone curve）是一种将颜色值的输入值一一映射到输出值的曲线函数，可以精确地控制处于不同色阶的像素的亮度。若将色调曲线设为 $f_{tone}$，则颜色调整公式为：

$$x' = f_{tone}(x)$$

其中 $x'$是调整后的颜色值，$x$是原始颜色值，可以是 RGB 的任一分量。

下列是一些特殊色调曲线的调整和对应的效果图。

![](1679151996488.png)

_正常的画面和色调曲线，此时的色调曲线呈 45 度的直线。_

![](1679151996554.png)

_加强明暗对比的画面和色调曲线，此时的色调曲线暗部处于直线下方，中间调位于直线上，亮部位于直线上方。_

![](1679151996643.png)

_自定义的色调曲线，曲线大范围偏离到直线下部，使得整体画面亮度变暗，对比度变小。_

由此可见，色调曲线给予了非常精确、自由、灵活的色彩调整功能，在摄影学、数码硬件、DDC、图像处理、计算机图形学、计算机视觉乃至 PBR 制作中，都有着举足轻重的作用。

### **2.1.6 线性空间与 Gamma 空间**

本质上，**Gamma 曲线是一种特殊的色调曲线，线性曲线又是一种特殊的 Gamma 曲线。**

**线性空间**（Linear Space）是 RGB 颜色都处于色调曲线的对角直线状态（下图），处于线性空间的颜色值是线性变化的，而不会有任何非线性改变，用公式来表达是：$x'=f(x) = x$。

![](1679151996755.png)

与线性空间相对立的是 **Gamma 空间**，它是有着指数级的色调曲线的变换空间，Gamma 曲线计算公式：

$$x'= f(x) = x^n = pow(x, n)$$

其中，$x$是颜色 $r,g,b$任一分量的值，值域是 $[0.0, 1.0]$，$n$是 Gamma 校正指数。下图中，分别是 $n$取 $0.45$,$1.0$,$2.2$的 Gamma 空间色调曲线图。

![](1679151996861.png)

1.0 是线性空间，输入输出值一样；0.45 和 2.2 是 Gamma 曲线，处于此空间的色彩将被提亮或压暗，并且 $0.45 \cdot 2.2 \approx 1.0$，以保证两次 Gamma 校正之后能够恢复到线性空间：

$$x' = f_{gamma2.2}(f_{gamma0.45}(x)) = ({x^{0.45}})^{2.2} = x^{0.45 \cdot 2.2} = x^{0.99} \approx x$$

![](1679151997142.png)

_从左到右：0.45 的 Gamma 校正图像，1.0 的线性空间的原始图像，2.2 的 Gamma 校正图像。_

上图左执行 2.2 的 Gamma 校正后将得到中间图像；同样，上图右执行 0.45 的 Gamma 校正后也可以得到中间图像。

线性空间对于计算机图形学中，有着至关重要的作用，它能够保证在 GPU 的 shader 中经过多次复杂的计算后，依然能够得到正确的颜色值；反之，如果是在 Gamma 空间执行 shader 计算，将得到误差很大的画面效果。

![](1679151997186.png)

_上半部分是线性空间，在不同光强度的反应下，能够得到正确的结果；下半部分是 Gamma 空间的计算，对光强度的反应过于强烈，会得到过曝的画面。_

正因为线性空间能够得到更加准确的渲染结果，所以主流商业引擎（UE、Unity、CryEngine、Frostbite 等）都支持了线性空间渲染管线。

![](1679151997244.png)

_线性空间渲染管线（下半部分）在 shader 前期去除了 Gamma 校正，在 shader 后期恢复 Gamma 校正。_

**那为什么线性空间的渲染管线要在前期和后期分别去掉又加回 Gamma 校正呢？**

这其实是历史遗留的问题。

早期的电视机采用 CRT 显像管，由于电压的强度与人眼感知的亮度不成正比，成指数为 0.45 的指数级曲线。为了解决这个问题，就引入指数为 2.2 的 Gamma 校正，强行提升显示图像的数据让电压与人眼感知亮度成线性比例。久而久之，之后的很多硬件设备、色彩空间 (如 sRGB)、文件格式（如 jpeg,png 等）、DDC 软件（如 ps）默认都执行了 Gamma 校正，并且一直沿用至今。

虽然当今的液晶显示器不再需要 Gamma 校正，但为了兼容已经广泛存在的有着 Gamma 校正的色彩空间及标准，也不得不保留 Gamma 校正。所以在 shader 后期还是要恢复 Gamma 校正，以便图片能够在显示设备正常显示。

更多关于线性空间和 Gamma 空间的知识，请参阅：[Gamma & Linear Color Space](https://www.jianshu.com/p/321f39b7fa93)。

### **2.1.7 HDR 和色调映射**

**HDR（High Dynamic Range）**即高动态范围，拥有更高的对比度和更广的色域，可分为基于软件的后处理 HDR 和基于硬件的显示设备 HDR。与 HDR 相对立的是 **LDR**（Low Dynamic Range，低动态范围）。

基于软件的后处理 HDR 是指摄影后期、图形渲染后处理阶段在亮部增加类似泛光（Bloom）的效果，但实际上依然可能是 LDR（低动态范围）。

![](1679151997298.png)

_UE 后处理阶段增加的泛光效果。_

基于硬件的 HDR 显示设备里有两个重要参数：

*   **Paper White**：直译是白纸的白，表示白色的亮度，单位为尼特（nits）。
*   **Max Luminance**：表示显示设备能达到的最大亮度，单位也是尼特（nits）。

在 LDR 设备上，Paper White 和 Max Luminance 是一样的，一般是 100 尼特。而在 HDR 显示设备上，Paper White 还是 100 左右，Max Luminance 可以达到 400~1000 尼特。

所以，基于硬件的 HDR 显示设备才是真正意义上的 HDR，因为它们可以显示超过很多倍标准白色的亮度。

当然，拥有 HDR 显示设备还不够，需要应用程序在渲染阶段支持 HDR 数据，最直观的一点就是 shader 里的数据允许颜色值超过 255（或归一化的 1.0）。

目前，主流商业引擎都支持了 HDR 的渲染流程，下图是 UE 的 LDR 和 HDR 对比图：

![](1679151997347.png)

  

![](1679151997382.png)

_UE 的 LDR（上）和 HDR（下）对照图，可明显看出 HDR 色彩更鲜艳，亮度对比更显著。_

启用 HDR 的应用程序面临一个问题：应用程序阶段的 HDR 数据格式很可能与显示设备所需的 HDR 格式不一致，或者显示设备压根不支持 HDR，只支持 LDR 格式。

为了解决以上这个问题，就需要引入**色调映射（Tone Mapping）**，它可以将 HDR 颜色变换成 LDR 格式或者另一种 HDR 格式（VDR）。

常见的色调映射方法有：

*   **Reinhard Tone Mapping**

该方法是 Reinhard 在 2002 年通过论文 [Photographic Tone Reproduction for Digital Images](https://link.zhihu.com/?target=http%3A//www.cmap.polytechnique.fr/~peyre/cours/x2005signal/hdr_photographic.pdf) 提出的色调映射方法。

它的特点是通过压缩亮部和暗部的存储空间，以提升中间调的细节和对比度。曲线如下图所示：

![](1679151997465.png)

利用 Reinhard 可较好地保留亮部和暗部细节：

![](1679151997499.png)

_上图未采用色调映射，下图采用了 Reinhard 色调映射法，可清楚看到亮部细节被很好地保留了。_

Reinhard 的实现非常简单，在早期对性能要求苛刻的实时渲染领域，非常适用。它的 shader 实现代码：

```
// color是线性空间的HDR颜色值，adapted_lum是根据整个画面统计出来的亮度
float3 ReinhardToneMapping(float3 color, float adapted_lum) {
    const float MIDDLE_GREY = 1; // 中性灰，基于经验获得
    color *= MIDDLE_GREY / adapted_lum;
    return color / (1.0f + color);
}
```

*   **CryEngine Tone Mapping**

2007 年发布的孤岛危机（Crysis）使用的是 CryEngine 渲染引擎，CryEngine 使用了更加简单暴力的色调映射，它的曲线如下图：

![](1679151997533.png)

由于该方法更大地压缩了亮部和亮度的对比度，所以可以得到比 Reinhard 更加高对比和色彩的画面。

![](1679151997572.png)

_启用了 CE 色调映射的 Crysis 游戏画面。_

*   **Filmic Tone Mapping**

2010 年，冒险动作主机游戏神秘海域 2（Uncharted 2）公布了它的色调映射方法，被称为 **Filmic Tone Mapping**（电影级色调映射）。

该方法的源自艺术家或者 TA 用专业数码设备模拟出的胶片感，再加上用 DDC 软件手动色调映射的结果，然后用拟合软件得到色调映射曲线。将它应用到渲染领域，能得到人工调整的结果，从而得到高质量的电影胶片感。

![](1679151997615.png)

从上图看看到，Filmic Tone Mapping 曲线在暗部拥有非常长非常缓的坡度，表明极大压缩了暗部的显示区域，腾出空间给中部和亮部。下图是神秘海域 2 的游戏画面：

![](1679151997707.png)

它的实现代码稍微较长：

```
float3 F(float3 x) {
	// 多项式的系数
	const float A = 0.22f;
	const float B = 0.30f;
	const float C = 0.10f;
	const float D = 0.20f;
	const float E = 0.01f;
	const float F = 0.30f;
 
	return ((x * (A * x + C * B) + D * E) / (x * (A * x + B) + D * F)) - E / F;
}

float3 Uncharted2ToneMapping(float3 color, float adapted_lum) {
	const float WHITE = 11.2f; // 白色位置，基于经验获得
	return F(1.6f * adapted_lum * color) / F(WHITE);
}
```

Gamma 校正也可以和 Filmic 色调映射合并在一起，从而提升渲染性能。

*   **ACES Tone Mapping**

**ACES**（Academy Color Encoding System，学院色彩编码系统）是一套专门管理和编解码色彩的体系。而它的创立者 Academy of Motion Picture Arts and Sciences 是颁发好莱坞奥斯卡的官方机构。

ACES 提供了一套通用格式以兼容 LDR 和各种 HDR 颜色数据格式，对于实时渲染领域，只需用下列的色调曲线将线性空间的颜色转成 HDR 格式：

![](1679151997792.png)

如果用代码实现，则是以下所示：

```
float3 ACESToneMapping(float3 color, float adapted_lum) {
	const float A = 2.51f;
	const float B = 0.03f;
	const float C = 2.43f;
	const float D = 0.59f;
	const float E = 0.14f;

	color *= adapted_lum;
	return (color * (A * color + B)) / (color * (C * color + D) + E);
}
```

UE4 中使用的胶片色调映射器也符合 ACES 标准，所采用的曲线如下图：

![](1679151997823.png)

相较旧的色调映射器，新的渲染结果更加接近物理真实：

![](1679151997870.png)

  

![](1679151998150.png)

_上图是 UE 旧的色调映射，下图采用了 ACES 的色调映射，可见新的色调映射在自发光率足够大时，颜色开始变白，更符合物理真实。_

与色调映射常常一起出现的概念还有**色彩分级**（Color Grading）和**颜色查找表**（LUT），它们都是属于后处理的范畴，更多可参阅虚幻官方文档：[颜色分级和胶片色调映射器](https://docs.unrealengine.com/zh-CN/Engine/Rendering/PostProcessEffects/ColorGrading/index.html)和[高动态范围显示输出](https://docs.unrealengine.com/zh-CN/Engine/Rendering/HDRDisplayOutput/index.html)。

## **2.2 颜色操作**

本节将深入分析颜色的各类常见操作，以及结果的变化趋势，以便为后续的 PBR 制作打下更加扎实的基础。

### **2.2.1 基础操作**

本小节将分析颜色的基本操作加减乘除，由于加与减、乘与除本质上是一样的，所以只需分析加法和乘法。

#### **2.2.1.1 颜色相加**

颜色相加是最常用到的一种操作，通常用于若干个光源叠加，或者若干种颜色分量叠加。当然，PBR 制作也经常用到颜色相加，以调整颜色的结果。颜色相加操作本质上是对颜色执行线性曲线的平移，抽象成函数：

$$f(x) = x + c$$

其中 $c$就是相加操作数。

颜色相加操作的分析主要可分两种情况：一是操作数是灰白色；二是操作数是彩色。

如下图，是第一种情况，可以看到彩色 $(0.75, 0.5, 0.25)$加了灰白色 $(0.25, 0.25, 0.25)$，得到右边的新颜色 $(1.0, 0.75, 0.5)$。

![](1679151998198.png)

彩色操作数的 HSV 是 $(30,0.67,0.75)$，新颜色 HSV 是 $(30,0.51,1.0)$。由此可得出结论：**颜色与灰色相加，得到的新颜色色相不变，饱和度降低，亮度增加。**

现在看第二种情况，将灰色改成彩色：

![](1679151998282.png)

颜色操作数 1 的 HSV 是 $(30,0.67,0.75)$，颜色操作数 2 的 HSV 是 $(216,0.82,0.59)$，结果颜色的 HSV 是 $(300,0.07,0.84)$。由此可得出结论：**颜色与彩色相加，得到的新颜色色相会改变，饱和度也会改变，亮度会增加。**

实际上，加法还有其它一些特殊情况，诸如黑色、同色相颜色相加的情况，结果颜色的变化见下表：

<table><thead><tr><th>加法操作数</th><th>色相变化</th><th>饱和度变化</th><th>亮度变化</th><th>对比度变化</th></tr></thead><tbody><tr><td>灰色</td><td>不变</td><td>降低</td><td>增加</td><td>降低</td></tr><tr><td>彩色</td><td>改变</td><td>改变或不变</td><td>增加或不变</td><td>降低或不变</td></tr><tr><td>黑色</td><td>不变</td><td>不变</td><td>不变</td><td>不变</td></tr><tr><td>同色相彩色</td><td>不变</td><td>改变或不变</td><td>增加或不变</td><td>降低或不变</td></tr><tr><td>白色</td><td>变成 0</td><td>变成 0</td><td>大于等于 1</td><td>变成 0</td></tr></tbody></table>

上表针对的是加法操作，减法的结果与加法有着规律的对比，降低的变增加，增加的变降低，不变的依然保持不变。

#### **2.2.1.2 颜色相乘**

颜色相乘也是最常用、最基本的操作，代表着颜色随着某种系数衰减或者增强。颜色相乘操作本质上是对颜色执行线性曲线的缩放，抽象成函数：

$$f(x) = c \cdot x$$

其中 $c$就是乘法操作数。

颜色相乘操作也可分为灰色和彩色因子两大类，其中灰色因子分为因子大于 1 或不大于 1 两种情况。先分析灰色因子，如下图：

![](1679151998349.png)

  

![](1679151998403.png)

上图是小于 1 的因子，新颜色的色相和饱和度不变，亮度降低；下图是大于 1 的因子，新颜色的色相和饱和度不变，亮度增加。

![](1679151998466.png)

上图中，两个彩色相乘，得到的结果色相、饱和度、亮度都发生了改变。

结合一些特殊的情况，可得到如下表：

<table><thead><tr><th>乘法操作数</th><th>色相变化</th><th>饱和度变化</th><th>亮度变化</th><th>对比度变化</th></tr></thead><tbody><tr><td>灰色（大于 1）</td><td>不变</td><td>不变</td><td>增加</td><td>增加</td></tr><tr><td>灰色（小于 1）</td><td>不变</td><td>不变</td><td>降低</td><td>降低</td></tr><tr><td>白色</td><td>不变</td><td>不变</td><td>不变</td><td>不变</td></tr><tr><td>黑色</td><td>变成 0</td><td>变成 0</td><td>变成 0</td><td>变成 0</td></tr><tr><td>彩色</td><td>改变</td><td>改变</td><td>改变</td><td>改变</td></tr></tbody></table>

除法与乘法有着类似的规律，只是灰色（大于 1）和灰色（小于 1）反过来，并且与黑色相除的结果无定义。

### **2.2.2 颜色插值**

**颜色插值**是通过一组插值系数在多个操作数中取不同权重的值的操作，在 PBR 制作、后处理、数码后期等领域使用得非常多，常见的插值方式有线性、S 形、三角插值等等。

#### **2.2.2.1 线性插值**

线性插值需要两个操作数 $a$,$b$和一个插值系数 $x$，则它们的插值公式是：

$$f(x) = a + (b - a) * x$$

其中 $x$的值域是 $[0, 1]$，以上公式对应的曲线图如下：

![](1679151998522.png)

UE 材质编辑器也提供了线性插值节点：

![](1679151998591.png)

#### **2.2.2.2 S 插值**

线性插值在操作数附近过渡比较生硬，不够自然，而 S 形插值则可以解决这个问题。S 形插值可用很多方式模拟，如 $\sin$、色调映射、贝塞尔曲线等。

其中，用 $\sin$模拟的 S 形插值的公式是：

$$f(x) = \sin(x\cdot \pi-\frac{\pi}{2})\cdot 0.5 + 0.5$$

模拟出的曲线如下图：

![](1679151998642.png)

从上图可以看出，在曲线两端，斜率由水平逐渐过渡，从而达到平滑插值的目的。

UE 默认不提供上述曲线的插值材质节点，需要手动实现，笔者实现的材质函数`SineLerp`如下图：

![](1679151998728.png)

由于 UE 的内置`Sine`材质节点在内部乘了$\pi$且做了偏移，所以实现起来跟上面提到的公式略有不同，会更加简便，但也会给不熟悉 UE 材质编辑器的人带来困惑。

#### **2.2.2.3 其它插值**

其它插值诸如法线融合、三角插值、方格插值、高度图插值，对应不同的应用场景，在 PBR 材质中较少用到，有兴趣的同学自行查阅相关资料或到 UE 材质编辑器摸索。

![](1679151998761.png)

_UE 材质编辑器提供的各式插值方式。_

### **2.2.3 颜色混合**

**颜色混合**是指将一种颜色与目标颜色通过某种方式相融合的操作，这些操作被称为**混合模式（Blend Mode）**。

不同的混合模式将得到不同的混合结果，通常涉及两个颜色：**混合颜色**（Blend Color，记作 $a$）和**底色**（Base Color，记作 $b$），部分混合模式还涉及混合系数 $alpha$。

它也是 Photoshop 的图层混合模式，同时 UE 也提供了相应的混合材质节点。混合模式很多，可分为普通、变暗、变亮、饱和度、差集、颜色等几大类。（下图）

![](1679151998818.png)

_Photoshop 的图层混合模式，相信美术、TA、摄影、设计等领域的同学都不陌生。_

*   **正常 (Normal)**

正常混合模式是最普通、最常用的一种混合模式，其实就是在两个图层中进行线性插值。它的公式如下：

$$f(a, b, alpha) = a \cdot alpha + b \cdot (1 - alpha)$$

用 UE 实现的效果如下图：

![](1679151998875.png)

*   **正片叠底 (Multiply)**

正片叠底就是将混合颜色和底色相乘，通常会得到更低亮度和饱和度的颜色。公式如下：

$$f(a, b) = a \cdot b$$

用 UE 实现的效果如下图：

![](1679151998946.png)

*   **颜色加深 (Color Burn)**

在此混合模式中，若混合颜色 $a$越暗，则在最终结果中使用该颜色越多。如果颜色 $a$为白色，则不进行任何更改。它的公式：

$$f(a,b) = 1- \frac{1-b}{a}$$

UE 的材质节点`Blend_ColorBurn`实现了这种混合模式：

![](1679151998998.png)

*   **线性加深 (Linear Burn)**

将底色颜色与混合颜色相加，然后从结果中减去 1。它的公式：

$$f(a,b) = a + b - 1$$

UE 的材质节点`Blend_LinearBurn`的内部实现及效果：

![](1679151999040.png)

*   **颜色减淡 (Color Dodge)**

通过将底色颜色反转并将其除以混合颜色，使结果变亮。混合公式：

$$f(a,b) = \frac{b}{1-a}$$

UE 的材质节点`Blend_ColorDodge`可实现这种混合模式：

![](1679151999089.png)

*   **线性减淡 (Linear Dodge)**

将 “底色”（Base）颜色与 “混合”（Blend）颜色相加。混合公式：

$$f(a,b) = a + b$$

UE 的材质节点`Blend_LinearDodge`可实现这种混合模式：

![](1679151999155.png)

*   **线性光 (Linear Light)**

线性光是 Overlay（覆盖）的线性版本，用于提供更粗糙的结果。此函数对混合颜色执行比较，从而每当混合比 50% 灰度亮时，就通过筛滤（Screen）操作对底色和混合颜色进行组合。如果混合颜色比 50% 灰度暗，那么将像 “乘” 功能一样，将底色与混合相乘。公式如下：

$$f(a,b)={ \begin{cases} ab, &{\mbox{if }}a<0.5 \\2a+b-1,&{\mbox{else}} \end{cases} }$$

UE 的材质节点`Blend_LinearLight`的混合效果：

![](1679151999185.png)

*   **变暗 (Darken)**

针对底色和混合颜色的每个像素，选择较暗的值。如果混合颜色为白色，则不会产生变化。公式：

$$f(a,b) = \min(a, b)$$

UE 材质编辑器的`Blend_Darken`实现及效果：

![](1679151999217.png)

*   **变亮 (Lighten)**

对底色和混合颜色的每个像素进行比较，并返回较亮的结果。公式：

$$f(a,b) = \max(a, b)$$

UE 材质编辑器的`Blend_Lighten`实现及效果：

![](1679151999309.png)

*   **差异 (Difference)**

通过从混合中减去底色，然后取结果的绝对值，创建反转样式的效果。公式：

$$f(a,b) = | a - b|$$

UE 材质编辑器的`Blend_Difference`实现及效果：

![](1679151999353.png)

*   **排除 (Exclusion)**

将底色和混合纹理二等分，对其进行组合，然后对结果执行部分反转。公式：

$$f(a,b) = 0.5 - 2(a - 0.5)(b - 0.5)$$

UE 材质编辑器的`Blend_Exclusion`实现及效果：

![](1679151999431.png)

*   **强光 (Hard Light)**

强光与覆盖（Overlay）的粗糙版本相似，它会对底色和混合进行筛滤或相乘。此函数对混合颜色执行比较，从而每当混合比 50% 灰度亮时，就通过筛滤（Screen）操作对底色和混合进行组合。如果混合比 50% 灰度暗，那么将像 “乘” 功能一样，将底色与混合相乘。然后，提高最终结果的对比度，以产生粗糙输出。公式如下：

$$f(a,b)={\begin{cases}2ab, &{\mbox{if }}a<0.5 \\1 - (1-2(a-0.5))(1-b),&{\mbox{else}}\end{cases}}$$

UE 材质编辑器的`Blend_HardLight`实现的效果：

![](1679151999492.png)

*   **覆盖 (Overlay)**

**覆盖**在 PS 被称为**叠加**，对底色和混合进行筛滤或相乘。此函数对混合颜色执行比较，从而每当混合比 50% 灰度亮时，就通过筛滤（Screen）操作对底色和混合进行组合。如果混合比 50% 灰度暗，那么将像 “乘” 功能一样，将底色与混合相乘。公式：

$$f(a,b)={ \begin{cases} 2ab, &{\mbox{if }}a<0.5 \\1-2(1-a)(1-b),&{\mbox{else}} \end{cases} }$$

UE 的材质节点`Blend_Overlay`的混合效果：

![](1679151999547.png)

*   **点光 (Pin Light)**

点光与 Overlay（覆盖）相似，它使底色和混合一起变亮或变暗。此函数对混合颜色执行比较，从而每当混合比 50% 灰度亮时，就通过筛滤操作对底色和混合进行组合。如果混合比 50% 灰度暗，那么将像 “乘” 功能一样，将底色与混合相乘。对比度会软化，这使此函数成为 Overlay（覆盖）的不太粗糙版本。公式：

$$f(a,b)={ \begin{cases} \min(2a,b), &{\mbox{if }}a<0.5 \\ \max(2(a-0.5),b),&{\mbox{else}} \end{cases} }$$

UE 的材质节点`Blend_PinLight`的混合效果：

![](1679151999594.png)

*   **筛滤 (Screen)**

**筛滤** (Screen) 在 PS 里叫**滤色**，按混合颜色使底色变亮。其工作方式如下：对这两种颜色都执行 “一减”，将它们相乘，然后对结果执行 “一减”。公式：

$$f(a,b) = 1 - (1 - a)(1 - b)$$

UE 材质编辑器的`Blend_Screen`实现及效果：

![](1679151999628.png)

*   **柔光 (Soft Light)**

**柔光**是 Overlay（覆盖）的柔和版本。此函数对混合颜色执行比较，从而每当混合比 50% 灰度亮时，就通过筛滤操作对底色和混合进行组合。如果混合比 50% 灰度暗，那么将像 “乘” 功能一样，将底色与混合相乘。对比度会软化，这使此函数成为 Overlay（覆盖）的不太粗糙版本。公式：

$$f(a,b)={ \begin{cases} (a+0.5)\cdot b, &{\mbox{if }}a<0.5 \\ 1 - (1-(a-0.5))(1-b),&{\mbox{else}} \end{cases} }$$

它也是 Photoshop 后期处理中用得比较多的一种混合模式，可以加大画面对比度，提升通透感。UE 的材质节点`Blend_SoftLight`的混合效果：

![](1679151999678.png)

## **2.3 常用曲线**

从上两节可以看到，颜色的原理、理论和操作大量运用了曲线函数，这节将 PBR 制作中常用的曲线总结出来并加以分析。

### **2.3.1 线性曲线**

线性曲线在颜色插值、色调映射、后处理、混合等操作中经常用到，抽象的公式如下：

$$f(x) = ax + b$$

其中 $x$是变量，$a$和 $b$是实数。当 $a=0.6,b=-0.1$时的曲线如下所示：

![](1679151999727.png)

### **2.3.2 指数曲线**

指数曲线是指变量 $x$的指数 $n$大于 1，可由若干个多项式抽象出来：

$$f(x) = \sum_{i=1}^{n}a_ix^i + b$$

其中 $a_i$是每个项的实数。当然，我们实际应用中，极少用到多项式，一般只需一项，即取 $a_n=1,a_i=0(i<n),b=0$，如此便可简化成：

$$f(x) = x^n$$

进一步地，取 $n=2$可得到曲线 $f(x)=x^2$，对应的曲线图：

![](1679151999778.png)

由上图可知：在指数级曲线中，当底数小于 1 时，数值比原来的值要小。

常用的还有不同指数的曲线：

![](1679151999811.png)

细心的童鞋应该发现了，当 $n=2.2$和 $n=0.45$时，就是前面提到的 Gamma 校正曲线。

### **2.3.3 三角函数**

三角函数有正弦、余弦、切线、余切等等，但 PBR 制作中常用的是正弦和余弦，而正弦和余弦本质是一样的，只是偏移不同，故下面只列出正弦公式：

$$f(x) = a\cdot\sin(x\cdot t + \theta) + b$$

其中 $a$是振幅，$t$是周期缩放因子，$\theta$是相位偏移，$b$是振幅偏移。当 $a=1,t=1,\theta = 0, b = 0$就是 $f(x)=\sin(x)$，对应曲线如下：

![](1679151999844.png)

当 $a=0.5,t=\pi,\theta = -\frac{\pi}{2}, b = 0.5$就可获得 S 形插值曲线：

$$f(x) = 0.5 \cdot \sin(x\cdot \pi-\frac{\pi}{2}) + 0.5$$

### **2.3.4 贝塞尔曲线**

贝塞尔曲线是一种由若干控制点控制的平滑曲线。假设控制点数量是 $n$，则控制点可表示为 $P_0, P_1,...,P_{n-1}(n\ge2)$。

当控制点数量是 2 时，贝塞尔曲线公式如下：

$$\boldsymbol B(t) = P_0 \cdot t + P_1 \cdot (1-t), t\in[0,1]$$

实际上就是线性插值和正常混合公式。

当控制点数量是 3 时，贝塞尔曲线公式和曲线图如下：

$$\boldsymbol B(t) = P_0 \cdot (1-t)^2 + P_1 \cdot 2t(1-t) + P_2\cdot t^2, t\in[0,1]$$

![](1679151999894.png)

当控制点数量是 4 时，公式将更加复杂：

$$\boldsymbol B(t) = P_0 \cdot (1-t)^3 + P_1 \cdot 3t(1-t)^2 + P_2\cdot 3(1-t)t^2 + P_3 \cdot t^3, t\in[0,1]$$

对应的示例图如下：

![](1679151999933.png)

### **2.3.5 Catmull–Rom 曲线**

贝塞尔曲线的特点是模拟出来的曲线不经过控制点，而 Catmull–Rom 曲线恰恰补足了这个特性，模拟出来的曲线具体平滑且经过控制点的特性。（下图）

![](1679151999974.png)

曲线公式和计算可以参见 [Centripetal Catmull–Rom spline](https://en.wikipedia.org/wiki/Centripetal_Catmull%E2%80%93Rom_spline)。

它正因为有这种优点，所以被广泛应用于动画插值、颜色混合、曲线调整当中，例如 Photoshop、LightRoom、UE 中的曲线调整：

![](1679152000058.png)

_在 Lightroom 利用色调曲线的若干控制点精确调整图片色调，此处的控制点就采用了 Catmull–Rom 曲线。_

### **2.3.6 其它曲线**

实际上，还有很多很多曲线，但限于篇幅，只介绍以上常用的几类曲线，其它曲线可以参看以下链接：

*   [List of Famous Curves](https://www.matematica.pt/en/useful/list-curves.php)
*   [缓动函数速查表](https://easings.net/)

其中[缓动函数速查表](https://easings.net/)列举了大量实用的曲线，并且附带了动态图，可以直观地看到曲线平滑度和坡度：

![](1679152000102.png)

# **特别说明**

*   感谢所有参考文献的作者们！
    
*   **原创文章，未经许可，禁止转载！**
    
*   **系列文章，未完待续，后面更精彩！！**
    

# **参考文献**

*   [由浅入深学习 PBR 的原理和实现](https://www.cnblogs.com/timlly/p/10631718.html)
*   [PBR Materials Guide](https://docs.highfidelity.com/en/rc83/create/3d-models/pbr-materials-guide.html)
*   [THE PBR GUIDE - 2018 EDITION](https://www.substance3d.com/pbr-guide)
*   [Making Realistic PBR Materials - Part 1](https://www.blenderguru.com/tutorials/pbr-shader-tutorial-pt1)
*   [Making Realistic PBR Materials - Part 2: Metal](https://www.blenderguru.com/tutorials/making-realistic-pbr-materials-part-2-metal)
*   [Materials (PBR)](https://help.sketchfab.com/hc/en-us/articles/204429595-Materials-PBR-)
*   [Real Shading in Unreal Engine 4](https://cdn2.unrealengine.com/Resources/files/2013SiggraphPresentationsNotes-26915738.pdf)
*   [Procedural PBR Material Creation using Substance Designer for Visualization](http://aucache.autodesk.com/au2016/sessionsFiles/15677/11767/handout_15677_DV15677-ScottDeWoody-AU2016.pdf)
*   [Unreal Engine 4 Game Development in 24 Hours](http://ptgmedia.pearsoncmg.com/images/9780672337628/samplepages/9780672337628.pdf)
*   [PBR: Implications of its application to Unreal 4 engine map and material creation](http://twvideo01.ubm-us.net/o1/vault/gdcchina15/slides/Li_Wenlei_PBR%20Implications_EN.pdf)
*   [Unreal Engine Document: Materials How-To's](https://docs.unrealengine.com/en-US/Engine/Rendering/Materials/HowTo/index.html)
*   [Unreal Engine Document: Physically Based Materials](https://docs.unrealengine.com/en-US/Engine/Rendering/Materials/PhysicallyBased/index.html)
*   [Unreal Engine Document: Materials](https://docs.unrealengine.com/en-US/Engine/Rendering/Materials/index.html)
*   [25 tips for Unreal Engine 4](https://www.creativebloq.com/3d/25-tips-unreal-engine-4-71621196)
*   [Create a PBR Material in Twinmotion](https://www.facebook.com/notes/twinmotion/create-a-pbr-material-in-twinmotion/2473971466210774/)
*   [SUBSTANCE IN UNREAL ENGINE 4: MATERIALS MADE EASY](https://www.substance3d.com/blog/substance-unreal-engine-4-materials-made-easy)
*   [DDO Painter + UE4: Master Materials - Quixel](https://quixel.se/tutorial/ddo-painter-for-ue4-master-materials/)
*   [Intro to Materials in UE4](http://3dmotive.com/series/intro-to-materials-in-ue4.html)
*   [Materials I - PBR materials, inputs & material editor within UE](https://www.modelical.com/en/gdocs/materials-i-pbr-materials-inputs-material-editor-within-ue/)
*   [Unreal Engine 4 Shaders and Effects Cookbook](https://books.google.com.tw/books?id=WJSaDwAAQBAJ&pg=PA7&lpg=PA7&dq=how+to+make+unreal+pbr+material)
*   [DONTNOD Physically based rendering chart for Unreal Engine 4](https://seblagarde.wordpress.com/2014/04/14/dontnod-physically-based-rendering-chart-for-unreal-engine-4/)
*   [Working with Physically-Based Shading: a Practical Approach](https://blogs.unity3d.com/2015/02/18/working-with-physically-based-shading-a-practical-approach/)
*   [Artist's PBR Guide / 淘宝美工 PBR 白皮书 3——色彩空间与色彩模型](https://zhuanlan.zhihu.com/p/74390558)
*   [Artist's PBR Guide / 淘宝美工 PBR 白皮书 4——Linear 与 Gamma](https://zhuanlan.zhihu.com/p/74182404)
*   [深入理解 color model(颜色模型)](https://www.jianshu.com/p/f03e9ac9c9ef)
*   [《李涛：简单后期教程》](https://www.youtube.com/watch?v=zlatSIHiQ0A)
*   [《刘杨：造像之术》](https://www.gogoup.com/course/GMTg=)
*   [《色彩设计的原理》](https://item.jd.com/10851918.html)
*   [《老邮差数码照片处理技法 -- 色彩篇》](https://read.douban.com/ebook/11292797/)
*   [Understanding Physically Based Rendering in Arnold](https://docs.arnoldrenderer.com/display/A5AFMUG/Understanding+Physically+Based+Rendering+in+Arnold)
*   [Color Model](https://en.wikipedia.org/wiki/Color_model)
*   [Color Space](https://en.wikipedia.org/wiki/Color_space)
*   [再谈色彩（RGB 通道和 HSV）](https://zhuanlan.zhihu.com/p/76808432)
*   [学会后期调色，从认识颜色开始](https://zhuanlan.zhihu.com/p/27785954)
*   [材质](https://docs.unrealengine.com/zh-CN/Engine/Rendering/Materials/index.html)
*   [材质表达式参考](https://docs.unrealengine.com/zh-CN/Engine/Rendering/Materials/ExpressionReference/index.html)
*   [材质函数参考](https://docs.unrealengine.com/zh-CN/Engine/Rendering/Materials/Functions/Reference/index.html)
*   [Lab 色彩空间](https://zh.wikipedia.org/wiki/Lab%E8%89%B2%E5%BD%A9%E7%A9%BA%E9%97%B4)
*   [CIE1931 色彩空间](https://zh.wikipedia.org/wiki/CIE1931%E8%89%B2%E5%BD%A9%E7%A9%BA%E9%97%B4)
*   [日系海边照片怎么修？看完这篇你就会！](https://www.weibo.com/ttarticle/p/show?id=2309404398272885162046)
*   [伽马空间与线性空间](https://blog.csdn.net/bill2ccssddnn/article/details/53423410)
*   [Gamma & Linear Color Space](https://www.jianshu.com/p/321f39b7fa93)
*   [如何支持 HDR 显示设备](https://zhuanlan.zhihu.com/p/27627260)
*   [Tone mapping 进化论](https://zhuanlan.zhihu.com/p/21983679)
*   [Coloure-temperature](http://www.techmind.org/colour/coltemp.html)
*   [色温](https://zh.wikipedia.org/wiki/%E8%89%B2%E6%B8%A9)
*   [Blend modes](https://en.wikipedia.org/wiki/Blend_modes)
*   [YUV](https://zh.wikipedia.org/wiki/YUV)
*   [Formulas for Photoshop blending modes](http://www.deepskycolors.com/archivo/2010/04/21/formulas-for-Photoshop-blending-modes.html)
*   [Centripetal Catmull–Rom spline](https://en.wikipedia.org/wiki/Centripetal_Catmull%E2%80%93Rom_spline)