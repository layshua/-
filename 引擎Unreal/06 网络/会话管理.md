# 概念
## Session 会话 
**在虚幻引擎中，`Session`（会话）是指游戏中的一个实例或场景，它包含了游戏的状态、玩家的信息以及与其他玩家进行交互的机制。**

>想象一个在线游戏大厅，列出当前正在进行的所有游戏。**列表中的每场游戏都是一场会话

简单来说，会话是游戏中的一个特定状态，它可以是一个单人游戏的进度、一个多人游戏的实例，或者是一个特定的游戏模式。会话可以包含玩家的位置、属性、游戏进度等信息，并提供与其他玩家进行通信和互动的功能。

在多人游戏中，会话管理是非常重要的，它涉及到创建、加入、离开游戏会话，以及同步玩家状态、处理游戏逻辑等。会话管理还可以包括匹配玩家、创建房间、设置游戏规则等功能，以提供更好的多人游戏体验。
## host 主机
在虚幻引擎中，会话管理是指在多人游戏中管理游戏会话（游戏实例）的过程。**而"host"（主机）是指托管游戏会话的玩家或计算机。**

在多人游戏中，通常有一个玩家或计算机充当主机，负责托管游戏会话并处理与其他玩家的通信。主机负责创建游戏实例、处理游戏逻辑、同步玩家状态等。其他玩家则通过与主机进行通信来参与游戏。

**总之，"host"（主机）在会话管理中是指托管游戏会话的玩家或计算机，负责管理游戏实例和与其他玩家的通信。**

#  联机子系统概述
Online Subsystem 

联机子系统及其接口的存在是为了在给定环境中提供一个清晰的抽象概念，以实现跨平台的通用联机功能。
这里的平台指的是 Steam、Xbox Live、Facebook 等。可移植性是主要目标之一。

> [!question] 我需要子系统做什么？
默认情况下，您将使用 `SubsystemNULL`。这样您就可以作为 host 托管局域网会话（ LAN Sessions）（这样您就可以通过服务器列表找到会话，并在局域网（LAN）中加入它们）或直接通过 IP 加入。
> 

互联网上不允许这样托管会话，因为没有主服务器为客户端提供服务器/会话列表。

子系统（例如 Steam）允许您托管在互联网上可见的服务器/会话。了解这一点很重要！

您也可以创建自己的子系统/主服务器，但这需要在虚幻引擎之外进行大量编码。

# 联机子系统模块

## 基本设计

基础模块 Online Subsystem 负责管理平台特定模块的定义和在引擎中注册的方式。对平台服务的所有访问都将通过该模块进行。

加载时，该模块会尝试加载 "`Engine.ini` "文件中指定的默认平台服务器模块：

```c++
[OnlineSubsystem]
DefaultPlatformService = <Default Platform Identifier>
```

如果成功，在没有指定参数的情况下，该默认在线接口将通过静态访问器提供。

```c++
static IOnlineSubsystem* Get(const FName& SubsystemName = NAME_None);
```

从该函数调用附加服务时，会根据需要加载适当的标识符。

## 委托的使用


与之前的虚幻引擎版本类似，在线子系统在调用具有异步（Asynchronous）副作用的函数时将大量使用委托。


重要的是要尊重委托，在调用链中更下游的函数之前，要等待适当的委托被调用。

不等待异步任务可能会导致崩溃和意外的、未定义的行为。在发生连接故障（如拉线（cable pull）或其他断开事件）时，等待委托尤为重要。  

在理想情况下，完成一项任务所需的时间似乎是瞬时的，但在超时情况下，则可能长达近一分钟。

The Delegate interface is fairly straightforward, with each Delegate clearly defined at the top of each interface header. Every Delegate has an Add, Clear, and Trigger function. (Although Triggering delegates manually is discouraged).  
委托接口相当简单明了，每个接口头的顶部都明确定义了每个委托。每个委托都有添加、清除和触发（Add, Clear, Trigger）函数。(虽然不鼓励手动触发委托）。

通常的做法是，在调用相应函数之前先 `Add()` 委托，然后从委托本身 `Clear()` 委托。

###  接口

并非所有平台都能实现所有接口，因此游戏代码应制定相应的计划。

#### Profile 配置文件
Interface definition for the online services Profile services. Profile services are defined as anything related to a given User Profile and its associated metadata (Online Presence, Access Permissions, etc).

在线服务 "Profile 服务"的接口定义：Profile 服务是指与给定的用户配置文件及其相关元数据（在线状态、访问权限等）有关的任何服务。

#### Friends 朋友

Interface definition for the online services Friends services. Friends services are anything related to the Maintenance of Friends and Friends Lists.  
在线服务 "好友服务 "的接口定义。好友服务是指与维护好友和好友列表有关的任何服务。

#### Sessions 会话

Interface definition for the online services Session services.  
在线服务的接口定义 会话服务。  
Session services are defined as anything related to managing a Session and its state.  
会话服务是指与管理会话及其状态有关的任何服务。

#### Shared Cloud共享云

Provides the Interface for sharing files already on the cloud (see User Cloud with other users).  
提供共享云上已有文件的界面（请参阅 "与其他用户共享用户云"）。

#### User Cloud用户云

Provides the Interface for per User Cloud file storage.  
为每个用户提供云文件存储接口。

#### Leaderboards 排行榜

Provides the Interface for accessing online Leaderboards.  
提供访问在线排行榜的界面。

#### Voice声音

Provides the Interface for Voice Communication over network while in the game.  
为游戏中的网络语音通信提供接口。

#### Achievements成就

Provides the Interface for Reading/Writing/Unlocking Achievements.  
提供读取/写入/解锁成就的界面。

#### External UI外部用户界面

Provides the Interface for accessing a given platform's external Interfaces if available.  
为访问特定平台的外部接口（如有）提供接口。

### 会话和匹配（Matchmaking）

Matchmaking 是将 "玩家 "与 "会话 "进行匹配的过程。  

**会话是在服务器上运行的游戏的一个实例，具有一组给定的属性，会话可以是公开的，这样想玩游戏的玩家就可以找到并加入；也可以是私密的，这样只有通过某种方式被邀请或通知的玩家才能加入。**

想象一个在线游戏大厅，列出当前正在进行的所有游戏。**列表中的每场游戏都是一场会话**或个人在线比赛。玩家通过搜索或其他方式与会话匹配，然后加入会话进行比赛。

#### 会话的基本生命周期

- 按所需设置创建新会话
- 等待玩家申请加入游戏
- 注册想要加入的玩家
- 开始会话
- 进行游戏
- 结束会话
- 取消玩家注册。或者
    - 如果您想更改比赛类型并返回到等待玩家加入的状态，请更新会话
    - 销毁会话

#### 会话接口（仅服务器）

The Session Interface, IOnlineSession, provides platform-specific functionality for setting up the pieces behind the scenes that is necessary to perform Matchmaking as well as other methods of allowing Players to find and join online games.  
会话接口 `IOnlineSession` 提供平台特定的功能，用于在幕后设置执行匹配所需的组件，以及允许玩家查找和加入在线游戏的其他方法。

这包括会话管理、通过搜索或其他方式查找会话，以及加入和离开这些会话。

**会话接口由联机子系统创建和拥有。这意味着它只存在于服务器上。**

每次只会存在一个会话接口，即引擎当前运行平台的会话接口。  

虽然会话接口会执行所有的会话处理，但游戏一般不会直接与之交互。

**相反，游戏会话（GameSession），即 `AGameSession`，则作为会话接口的特定游戏包装，当游戏代码需要与会话交互时，就会调用它。**

**GameSession 由 GameMode 创建和拥有，也只在运行在线游戏时存在于服务器上。**

**每个游戏都可能有多个 GameSession 类型，但每次只能使用一个。**

#### 会话设置

由 "`FOnlineSessionSettingsclass` "定义的会话设置是一组决定会话特性的属性。

- 允许参赛 Players人数
- 会话是公开的还是私人的
- 会话是否与局域网匹配
- 服务器是专用的还是玩家托管的
- 是否允许邀请
- 等等。

以在线游戏大厅为例，每个游戏都是一个会话，都有自己的会话设置。  
例如，有些会话可能是玩家对玩家（PvP），而另一些则是多人合作（Co-Op）。
不同的会话可能会玩不同的地图或游戏列表，需要不同数量的玩家等。

#  会话管理

**所有会话节点都是异步任务（时钟符号），完成后会调用 `OnSuccess` "或 `OnFailure`。在此期间，您可以使用最上面的执行输出。**

## 创建会话

要让玩家找到会话并加入会话，需要创建一个会话并设置其属性，以及决定哪些属性是可见的。

- 当前的引擎版本可能不支持通过蓝图注册专用服务器会话。  
- 在 C++ 中，您应该通过重载 `RegisterServer` 函数，在 `AGameSession` 内部创建正常的 C++ 会话！

### 通过蓝图创建会话

![[f326e6b0ce21ba212fe02050d63ca061_MD5.png|"Create Session Node"]]

要在蓝图中创建会话，可以使用 Epic 已经公开的 "`CreateSession`节点。它提供的选项不多，但可以通过论坛上的插件进行扩展。

## 更新会话

如果要更改现有会话的设置，则需要使用 **`IOnlineSession::UpdateSession()`** 函数进行更新。

例如，当前会话设置可能只允许 8 名玩家参赛，而下一场比赛则需要允许 12 名玩家参赛。要更新会话，需要调用 `UpdateSession()`，将新的会话设置传给它，指定最多允许 12 名球员。

When the request to update a Session has been completed, the 'OnUpdateSessionComplete' delegate is fired. This provides the opportunity to perform any configuration or initialization necessary to handle the Session Settings changing.  
更新会话的请求完成后，**`OnUpdateSessionComplete`委托**将被触发。这样就有机会执行处理会话设置更改所需的任何配置或初始化。

Updating a Session is generally performed between Matches on the Server, but it is also performed on the Client to keep the Session information in sync.  
更新会话通常在服务器上的两场比赛之间进行，但也会在客户端上进行，以保持会话信息同步。

### Updating a Session via Blueprint[​](https://cedric-neukirchen.net/docs/session-management/#updating-a-session-via-blueprint "Direct link to Updating a Session via Blueprint")  
通过蓝图更新会话

There is no Blueprint Version of this function yet, but it can be extended via Plugins from the Forum.  
该功能还没有蓝图版本，但可以通过论坛上的插件进行扩展。

## Destroying Sessions[​](https://cedric-neukirchen.net/docs/session-management/#destroying-sessions "Direct link to Destroying Sessions") 破坏会议

When a Session ends and is no longer needed, the Session is destroyed using the 'IOnlineSession::DestroySession()' function. When the destruction operation has been completed, the 'OnDestroySessionComplete' Delegate is fired, enabling you to perform cleanup operations.  
会话结束且不再需要时，会使用 "IOnlineSession::DestroySession() "函数销毁会话。销毁操作完成后，会触发 "OnDestroySessionComplete "委托，以便执行清理操作。

### Destroying a Session via Blueprint[​](https://cedric-neukirchen.net/docs/session-management/#destroying-a-session-via-blueprint "Direct link to Destroying a Session via Blueprint")  
通过蓝图销毁会话

![[ca92f18151ec7ab30d823d9537ce86f2_MD5.png|"Destroy Session Node"]]

  

## Searching Sessions[​](https://cedric-neukirchen.net/docs/session-management/#searching-sessions "Direct link to Searching Sessions") 搜索会话

The simplest way to find Sessions is to search for Sessions that match some desired subset of Settings.  
查找会话的最简单方法是搜索与某些所需的设置子集相匹配的会话。

This could be in response to the Player choosing a collection of filters in a User Interface, or it could be done automatically behind the scenes, based on the Player's skill and other factors, or it could be a combination of both methods.  
这可能是对玩家在用户界面上选择过滤器集合的响应，也可能是根据玩家的技能和其他因素在幕后自动完成的，还可能是两种方法的结合。

The most basic form of Searching for Sessions is the classic Server Browser that shows all available games and allows the Player to filter those based on the type of Game they want to play.  
搜索会话的最基本形式是经典的服务器浏览器，它可以显示所有可用游戏，并允许玩家根据自己想玩的游戏类型过滤这些游戏。

### Searching Sessions via Blueprint[​](https://cedric-neukirchen.net/docs/session-management/#searching-sessions-via-blueprint "Direct link to Searching Sessions via Blueprint")  
通过蓝图搜索会话

![[074182f4bae9844a8b0dd79fa515e7c1_MD5.png|"Find Sessions Node"]]

  

For Blueprints you can use the 'FindSessions' Node that Epic already exposed for you. You can specify the number of results and if you want to search for LAN or Online Games.  
对于蓝图，您可以使用 Epic 已为您提供的 "FindSessions "节点。您可以指定搜索结果的数量，以及是否要搜索局域网游戏或在线游戏。

More can be specified using Plugins from the Forum.  
更多信息可使用论坛上的插件进行说明。

## Joining Sessions[​](https://cedric-neukirchen.net/docs/session-management/#joining-sessions "Direct link to Joining Sessions") 参加会议

Once you have determined a Session for the Player to join, the process of joining is initiated by calling 'IOnlineSession::JoinSession()' and passing it the Number of the Player and the Name and SearchResult of the Session to join.  
一旦确定了玩家要加入的会话，就可以调用 "IOnlineSession::JoinSession()"，并将玩家的编号以及要加入的会话的名称和搜索结果传给它，从而启动加入会话的过程。

When the joining process completes, the 'OnJoinSessionComplete' Delegate is fired. This is where the logic to get the Player into the Match is performed.  
当加入过程完成时，"OnJoinSessionComplete"（加入会话完成）委托会被触发。在此执行让玩家加入比赛的逻辑。

More information about this logic can be read below and on my Session C++ Blogpost.  
有关此逻辑的更多信息，请参阅下文和我的会话 C++ 博客文章。

### Joining a Session via Blueprint[​](https://cedric-neukirchen.net/docs/session-management/#joining-a-session-via-blueprint "Direct link to Joining a Session via Blueprint")  
通过蓝图加入会议

![[994ca6778bd687a5d20bed47b6126e14_MD5.png|"Join Session Node"]]

  

For joining a Session via Blueprint, you can use the 'JoinSession' Node, that Epic already exposed. It needs a SessionResult, which you can get from the 'FindSession' Node.  
要通过蓝图加入会话，可以使用 Epic 已经公开的 "JoinSession "节点。它需要一个会话结果，可以从 "FindSession "节点获取。

It returns on Array of SessionResults. The 'JoinSession' Node will directly join the Map 'OnSuccess'.  
它会返回会话结果数组。JoinSession "节点会在 "OnSuccess "时直接加入地图。

You don't have to deal with that.  
你不需要处理这个问题。

## Cloud-Based Matchmaking[​](https://cedric-neukirchen.net/docs/session-management/#cloud-based-matchmaking "Direct link to Cloud-Based Matchmaking")  
基于云的婚介

Cloud-Based Matchmaking refers to built-in Matchmaking Services that are available, and generally platform specific.  
基于云的婚介指的是可用的内置婚介服务，一般针对特定平台。  
An example of this type of service is the TrueSkill System available through the Microsoft Xbox Live Service.  
通过微软 Xbox Live 服务提供的 TrueSkill 系统就是这类服务的一个例子。

To initiate Matchmaking on Platforms that support it, you call 'IonlineSession::Startmatchmaking()' and pass it the Controller Number of the Player to matchmake for, the SessionName, SessionSettings to use if creating a new Session, and Settings to Search against.  
要在支持匹配的平台上启动匹配，需要调用 "IonlineSession::Startmatchmaking()"，并向其传递要进行匹配的玩家的控制器编号、会话名称、创建新会话时要使用的会话设置（SessionSettings）以及搜索设置。  
The 'OnMatchmakingComplete' Delegate is fired when Matchmaking is complete. This provides a bool specifying whether the process was successful and the Name of the Session to join in that case.  
当匹配完成时，"OnMatchmakingComplete "委托会被触发。它提供了一个 bool 值，指定过程是否成功，以及在这种情况下要加入的会话名称。

A Matchmaking action, which is in progress, can be canceled by calling 'IOnlineSession::CancelMatchmaking()' and passing it the Controller Number of the Player and the SessionName that was passed to the call to start Matchmaking in the first place.  
可以通过调用 "IOnlineSession::CancelMatchmaking() "来取消正在进行的匹配操作，并将玩家的控制器编号和会话名称传递给调用以开始匹配。

The 'OnCancelMatchmakingCompletedelegate' is fired when the cancel operation is completed.  
当取消操作完成时，"OnCancelMatchmakingCompletedelegate "会被触发。

## Following and Inviting Friends[​](https://cedric-neukirchen.net/docs/session-management/#following-and-inviting-friends "Direct link to Following and Inviting Friends")  
关注和邀请好友

On platforms that support the concept of Friends, Players can follow Friends into a Session or invite Friends to join them in a Session.  
在支持好友概念的平台上，玩家可以跟随好友进入会话或邀请好友加入会话。

Following a Friend into a Session is done by calling 'IOnlineSession::FindFriendSession()' and passing it the Number of the local Player that wants to join the Session and the ID of the Friend already in the Session.  
通过调用 "IOnlineSession::FindFriendSession()"，并将想要加入会话的本地玩家的编号和会话中已有朋友的 ID 传递给它，就可以将朋友加入会话。  
The 'OnFindFriendSessionComplete' Delegate is fired when the Session is found and it contains a SearchResult that can be used to join the Session.  
当找到会话时，"OnFindFriendSessionComplete "委托会被触发，它包含一个可用于加入会话的搜索结果。

A Player can also invite one or more Friends to join them in their current Session using 'IOnlineSession::SendSessionInviteToFriend()' or 'IOnlineSession::SendSessionInviteToFriends()' and passing in the Local Player Number, SessionName, and ID(s) of the Player(s) to be invited.  
玩家还可以使用 "IOnlineSession::SendSessionInviteToFriend() "或 "IOnlineSession::SendSessionInviteToFriends() "邀请一个或多个好友加入当前会话，并输入本地玩家编号、会话名称和要邀请的玩家的 ID。

When a Friend accepts an invitation, the 'OnSessionInviteAccepted' Delegate containing the SearchResult of the Session to join is fired.  
当好友接受邀请时，包含要加入会话的搜索结果的 "OnSessionInviteAccepted "委托就会被触发。