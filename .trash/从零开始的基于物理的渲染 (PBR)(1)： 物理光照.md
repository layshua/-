目录：

[TheTus：从零开始的基于物理的渲染 (PBR)(0)：开篇](https://zhuanlan.zhihu.com/p/633603239)

为了更好地理解后面在 BRDF 和反射方程中使用的各个物理量的含义，我们需要先了解物理光学的基础知识。在本章中，我们讨论了光的物理定义以及重要的辐射度量学。最后，我们讨论了辐射量与人眼接收颜色之间的关系。

由于本章很多内容从物理入手，所以刚接触可能有点抽象，对于大部分内容只需要有个印象即可。重点需要理解 **各个辐射量的概念**。

## 物理光学

在物理光学中，光被建模为一种 **电磁横波 (transverse wave)** ，即沿其传播方向垂直振荡的电场和磁场。这两个场的振荡是耦合的。磁场和电场向量相互垂直，它们长度之比是固定的。这个比率等于相位速度。

如下图，这是一个最简单的 **单色光 (monochromatic light)** 的电磁横波建模。它既是单色 (single colored) 的(具有单一波长λ)，又是 **线偏振 (linearly polarized)** 的 (电场和磁场沿一条直线震荡)。

![[ed5cf9b335edfd296201770ad556d40f_MD5.jpg]]

实际上，我们更关注 **非线偏振光 (unpolarized light)** 。非线偏振光的场的振荡沿传播轴垂直的所有方向均匀分布，即光波的振荡方向在时间上是随机的。

具有不同波长 (相邻同一相位点(例如峰值点) 的距离)的电磁波往往具有不同的特性。在自然界中，电磁波存在于一个具大的范围内，人类可以看到的感知光只是一小部分，从紫外光约 **400nm** 到红光略高于 **700nm**。

![[d2cb0d9c3cca183f010181e8e8b973e9_MD5.jpg]]

正如图上所示，光的频率决定了光的颜色。高频率的光成蓝色调，低频滤的光呈红色调，而中间则是绿色调。

如果跟踪光波上特定相位点 (例如峰值点) 随时间的变化，我们会看见它以恒定速度在空间移动，这个速度就是波的 **相位速度 (phase velocity)** 。对于真空中传播的光波，我们称为光速，c≈300,000km/s。

光波携带能量，能量流密度等于电场和磁场幅值 (峰值和谷值距离) 乘积。由于电场和磁场幅成比例关系，因此能量流密度与电磁幅值平方成正比。由于电场对物质影响更强烈，我们更关注电场部分。

**光子 (photon)** 是光的基本粒子，具有离散的能量量子。它们携带光的能量，并在电磁波中传播。光波的能量可以看作是由许多光子组成的。因此，我们可以将光的能量表示为光子的能量的总和。

在渲染过程中，我们关心随时间变化的平均能量的流动情况，并与平方波振幅成正比进行处理。该平均能量流密度称为 **辐射度 (irradiance)** (E)。即每个光子携带的能量为 E。普朗克常数记为 h，光子的能量和它的频率 f 的关系可以够成以下等式：

 $E=hf$

光波 **线性组合**，总波式各分量波的和。

当物体内的电荷振荡时，会发射出光波。引起振荡的能量 (热能、电能、化学能) 的一部分被转换成了光能，并从物体辐射出去。在渲染中，这样的物体被称为 **光源 (light sources)**。

光波发射后会穿过空间，打到物体上进行相互作用。振荡电场推拉着物质中的电荷，使它们也开始振荡。振荡电荷会发射出新的光波，在新方向上重新定向一部分入射光波能量，这被称为 **散射 (scattering)**。广义上，弹性散射可以表现为 **反射 (reflection)** 和 **散射 (refraction)**

散射后的光波具有与原始波相同的频率。通常情况下，原始波包含多个不同频率的光线时，每个频率都会单独地与物质进行交互作用。

一个孤立的分子会将光散射到各个方向，但强度存在一定的方向性变化。在接近原视传播轴线的前后方向上，散射更多的光线。在渲染中，我们关注许多分子组合的集合体 (例如固体物体、液体悬浮物或气体中的微粒)。

## 辐射度量学

**辐射度量学 (radiometry)** 是研究光的辐射和传输过程的科学。它关注光的物理特性，如能量、亮度和颜色，并提供了一套用于描述和量化光的属性的数学工具和概念。

在计算机图形学中，辐射度量学着重讨论光的电磁横波中光学谱段的**可见光谱**的辐射能的计算。光学谱段范围值从波长 0.1 的红外线到 0.1nm 的 X 射线这一距离。可见光谱段指人眼产目视刺激从而形成光感和色感的谱段，范围大约为 0.38—0.76μm。

![[72aa859882b5529883e2f24bc378217a_MD5.jpg]]

**辐射量 (radiometric quantities)** 用于测量电磁辐射的各个方面：总能量，功率，以及与面积、方向两者都有关的功率密度。如下表。

![[dc2240a46f993b5e906932fe91b534d2_MD5.jpg]]

下面，我们将对它们逐一讨论。

### 立体角

在介绍具体的辐射度量学前，我们需要先介绍 **立体角 (solid angles)** 的概念，它是角度概念的三维扩展。

立体角指的是，球面上所夹面积与半径平方的比率。以球心为顶点，半径 R 为棱长作一个圆锥体，则这个圆锥体底面所对球面面积为 A，则立体角为

 $\Omega = \frac{A}{r^{2}}$

![[c104454fa8ccaf2c79312d8571bd2095_MD5.jpg]]

单位立体角指的是一个立体弧度为 **半径 1** 的球面上 **1 平方米面积** 所张成的立体角。

如果在球面坐标系下对立体角进行定义，则 $rd\theta$ 就是微分面积元的长， $rsin\theta d\phi$ 就是微分面积的宽。则面积微元公式 dA 可以写成：

 $\begin{align} dA&=(rd\theta)(rsin\theta d\phi)\\ &=r^{2}sin\theta d\theta d\phi \end{align}$

进一步，微分立体角可以表示为：

 $d\omega = \frac{dA}{r^{2}}=sin\theta d\theta d\phi$

利用上述公式，可以验证球的立体角为 4π：

 $\begin{align} \Omega&=\int_{S^{2}}d\omega\\ &=\int_{0}^{2\pi}\int_{0}^{\pi}sin\theta d\theta d\phi\\ &=4\pi \end{align}$

### Radiant Energy

**辐射能 (radiant energy)** 是电磁辐射的能量。它以焦耳为单位进行测量，符号表示为：  
 $Q[J=Joule]$

前面提到，光是一种电磁横波，携带着能量，这种能量被称为辐射能。并且，辐射能是波动的，因此具有频率，人眼只能识别 400nm 到 700nmHZ 之间的一小部分频率。

### Flux

**辐射通量 (radiant flux)**，也称为**功率 (power)**，是单位时间内通过表面或空间区域的总能量。符号表示为：  
 $\phi\equiv\frac{dQ}{dt}[W=Watt][lm=lumen]^{*}$

辐射通量类比于功率，是辐射度量学的 **基本单位**。它通常用来评估能量强度，例如有两个灯泡同时产生 100J 辐射能，灯泡 A 需要 10 分钟，灯泡 B 需要 5 分钟。因此，在任何时刻灯泡 B 都比灯泡 A 产生多 1 倍的辐射功率，因此灯泡 B 使房间更明亮。

光的频率决定人眼对光颜色的感知，而辐射通量决定人眼对光亮度的感知。

在一个空间内，光子的流动与传播遵循能量守恒定律。所有流入空间内的光子总能量，一定等于从本空间流出的光子能量与本空间吸收的光子能量之和。

光子有两种方法进入该空间：

*   从外部空间流入 (入射) 的光，记为 **Φi**
*   从本空间内部物体发射 (反射) 的光，记为 **Φe**

光子有三种方式流出该空间：

*   不经过本空间任何干扰直接向外流出，记为 **Φs**
*   被本空间内物体完全反射后流出 (出射)，记为 **Φo**
*   被本空间内物体吸收，记为 **Φa**

_注：下面的积分可以只看个乐子 (或者忽略)，在实时渲染中一般不会精确计算，所以才会提出蒙特卡洛积分等算法进行近似。_

那么给定的单位时间内空间 V 的 **辐射通量方程** 如下：

 $\phi_{e}+\phi_{i}=\phi_{s}+\phi_{o}+\phi_{a}$

单位时间内，规定点 $p\in V$ ，方向 $\omega \in \tau$ ，辐射通量为 $\Phi(p,\omega)$ 。

各点各方向上的总自发光辐射通量Φe 表达式为：

 $\Phi_{e}=\Phi(p,\omega)=\int_{\tau}\int_{V}\Phi(p,\omega)dpd\omega$

规定点 p 处 $\omega$ 方向单位时间内被吸收的概率函数为 $\alpha(p,\omega)$ 。因此，p 点光子在该时间该方向被吸收的辐射通量应该为 $d\Phi_{a}=\Phi(p,\omega)\alpha(p,\omega)$ 。则各点各方向上的总被吸收的辐射通量Φa 表达式为：

 $\Phi_{a}=\int_{\tau}\int_{V}\alpha(p,\omega)\Phi(p,\omega)dpd\omega$

规定光子在点 p 处以 $\omega$ 方向入射，然后以 $\omega'$ 的方向出射的概率函数为 $b(p,\omega,\omega')$ ，并且 $\omega'\in\Omega$ 。则各点各方向上的总出射光的辐射通量Φo 的表达式为：

 $\Phi_{o}=\int_{\tau}\int_{V}\int_{\Omega}b(p,\omega,\omega')\Phi(p,\omega)d\omega'dpd\omega$

反之，各点各方向上的总入射光辐射通量 $\phi_{i}$ 的表达式只需将 $\omega$ 与 $\omega_{i}$ 对调。

 $\Phi_{i}=\int_{\tau}\int_{v}\int_{\Omega}b(p.\omega',\omega)\Phi(p,\omega)d\omega'dpd\omega$

Φs 指的是经过此空间不受任何干扰，向外边界 S 流出的光。则点 $p\in S$ 在各方向 $\omega\in\tau$ 上总流出光的辐射通量Φs 的表达式为：

 $\Phi_{s} =\int_{\tau}\int_{V}\Phi(p,\omega)dpd\omega$

由上所述，如果知道了任意一点 p 在任意一点上沿 $\omega$ 的辐射通量的值 $\phi(p,\omega)$ ，就能得到计算机图形学中的光照问题的完整解决方案。因为知道了某处的辐射通量，就能得到在单位时间内的能量，从而计算出光的波，根据光的波长便能重构能被人眼感知的场景颜色。然而直接利用上述公式计算的工作量非常大，所以计算机图形学主要采用通过一些列的近似公式来模拟上述公式的结果。一个满足实时渲染性能的结果和产生真是光照感的解是完全不同的。而这些理论，是基于物理的光照的基础。

### Radiant Intensity

**辐射强度 (radiant intensity)** 是点光源发出的 **每单位立体角 (per unit solid angle)** 的 flux/power。符号表示为：  
 $\begin{gather} I(w)\equiv\frac{d\phi}{d\omega}\\ [\frac{W}{st}][\frac{lm}{sr}=cd=candela] \end{gather}$

![[9ae88c1242f6f6c1bb702675aa8368ca_MD5.jpg]]

例如，在上图中，蓝色区域的 radiant intensity 是由所有穿过蓝色区域的黄线产生的 flux 除以蓝色区域面积得出的。任何未经过立体角的红线的 flux 都是无关紧要的。

令 flux 为 $\Phi$ ，立体角为 $\Omega$ ，辐射亮度为 $L$ ，radiant intensity 为 $I$ ，则

 $dI=\frac{d\Phi}{d\Omega}=\frac{L}{dAcos\theta}$

对一个面 A 的区域求积分得到：

 $I(\alpha,\beta)=\int\frac{L}{cos\theta dA}$

I 称为表面面积微元 dA 在方向 (α, β) 上的辐射强度。与距离无关，但是与发射面 dA 的面积有关。

由于光源通常具有一定秒你就，所以在图形学中常常使用 I 来表示一个光源的辐射强度分布。

### Irradiance

**辐射照度 (Irradiance)** 是表面 **每单位照射面积 (per uint area)** 接收的 flux。符号表示为：  
 $\begin{gather} E(x)\equiv\frac{d\phi(x)}{dA}\\ [\frac{W}{m^{2}}][\frac{lm}{m^{2}}=lux] \end{gather}$

需要注意的是，密度与物质在一定区域的数量和区域大小共同决定。如下图所示，有 3 个球形光源发射 10W/s 通量的光线。但是，只有很小一部分的光线会落在 P 区域内。假设 P 区域面积为 2 平方米，则 $Irradiance=(0.7+1+0.1)/2=0.9W/m^{2}$

![[fa50e171c7cf3edc9605f7c3a8e09db8_MD5.jpg]]

在上面的例子中，每个光源发出的 flux 都是 10W/s，但是打到表面的 irradiace 却不同。实际上，表面接收到的 irradiance 与表面法线和入射光线之间的夹角相关联。

根据 irradiance 的定义，它指的是 **单位照射面积** 接受到的 flux。如下图所示，“宽度” 相同为 A 的光照射到表面，当垂直入射时，照射面积为 A。但当斜着入射时，照射面积变为了 $A'=\frac{A}{cos\theta}$ 。当入射光斜率变大，光束扩散到更大的区域，这意味着该区域中每一点从该光束中接收到的 flux 更少。

![[927d991ce539d162f22c976124f6bfc9_MD5.jpg]]

这被称为 **兰伯特余弦定律 (Lambert's Cosine Law)**，它表明到达表面的 flux 数量与 cos(θ) 成比例，其中θ为表面法线和入射光方向之间的弧度角。即：

 $E=\frac{\Phi}{A}cos\theta$

此外，表面接收到的 irradiance 还与光源距离相关。如下图，假设有一个均匀发出 $flux=\Phi$ 的点光源，距离为 1 的表面接收 irradiance 为 $E=\frac{\Phi}{4\pi}$ 。而距离为 r 的表面接收 irradiance 衰减为 $E'=\frac{\Phi}{4\pi r^{2}}=\frac{E}{r^{2}}$ 。

![[2014bf0baa35cc6737dd870124af3999_MD5.jpg]]

### Radiance (L)

**Radiance(辐射亮度)** 是表面 **每单位投影面积 (per projected unit area)**、**每单位立体角 (per unit solid angle)** 接收的的 flux。符号表示为：  
 $\begin{gather} L(p,\omega)\equiv\frac{d^{2}\phi(p,\omega)}{d\omega dAcos\theta}\\ [\frac{W}{srm^{2}}][\frac{cd}{m^{2}}=\frac{lm}{srm^{2}}=nit] \end{gather}$

Radiance 指定了单位立体角和单位垂直面积，同时还指定了光的方向与照射表面所收到的 **亮度** 。

这里需要注意区分 irradiance 的 单位照射面积 和 radiance 的 单位投影面积。前面提到，单位照射面积指表面实际接收到光的面积。而在 radiance 中，为了更好地使其成为描述一条光线传播中的亮度，且在传播过程中 **大小不随方向改变** ，所以定义中关于接收面积的部分是每单位投影面积。

![[f0af2fc1d0b3eab736e6a9edc748dc5c_MD5.jpg]]

如上图所示，Ω角度入射光入射。Irradiance 指定的单位照射面积为表面实际接收面积 dA。而 radiance 指定的单位投影面积为 dA⊥。两者的关系为 $dA\bot=dAcos\theta$ 。

根据单位照射面积和单位投影面积的关系以及 irradiance $E(p)$ 和 radiance $L(p,\omega)$ 的定义，很容易得出它们之间的关系。

 $L(p,\omega)=\frac{dE(p)}{d\omega cos\theta}$

进一步可以推导出：

 $\begin{align} dE(p,\omega)&=L_{i}(p,\omega)cos\theta d\omega\\ E(p)&=\int_{H^{2}}L_{i}(p,\omega)cos\theta d\omega \end{align}$

观察积分后的式子，irradiance $E(P)$ 表示点 p 每单位照射面积的 flux，而 radiance $L_{i}(p,\omega)$ 表示入射光每立体角，每单位投影面积的 flux，因此积分式子右边的 $cos\theta$ 解释了面积上定义的差异。而对 $d\omega$ 积分，则是相当于对所有不同角度入射光线的贡献求和。所以这个积分式子的物理含义为：点 p 所接收到的亮度 (irradiance)，由不同方向入射光线 radiance 共同贡献得到。

![[1d3179e65ecbf6271b7774bdc0e22a81_MD5.jpg]]

Radinace 是传感器 (例如眼睛或相机) 所测量到的辐射量，所以它是渲染中最基本最重要的单位。评估渲染方程就是计算从某点射出打到相机的射线的 radiance。

由定义中的 “单位投影面积” 可以得出，radiance 的一个重要特性是它 **不受距离等影响**。换句话说，不论表面离观察者多远，其 radiance 都相同。

### 光谱功率分布

大部分光波是不同波长光波的混合物，这通常被视为 **光谱功率分布 (spectral power distribution, SPD)**。SPD 用于描述光能在不同波长上分布情况。下图展示了三个例子。虽然下图中间的 SPD 与下图下面的 SPD 曲线差异过大，但它们被感知为同一种颜色。

![[346857ee74b40843c3fa407c423a5574_MD5.jpg]]

所有辐射量都具有光谱分布。由于完整 SPDs 在渲染过程中使用起来很麻烦，实际上辐射量通常表示为 RGB 三元组。

## 色度学

辐射度量学存粹处理物理量，不考虑人类感知。相关领域 **光度学 (photometry)** 与辐射度量学相似，但它通过人眼的敏感性对所有物体进行加权。辐射计算结果通过乘以 CIE 光度曲线转换为广度单位，该曲线是以 555nm 为中心的钟形曲线，代表了眼睛对各种波长的光的响应。CIE 光度曲线如下所示。

![[c22f1643397ed1e815e772b3ea67c84f_MD5.jpg]]

光度学理论和辐射度量学理论之间唯一区别在于 CIE 光度曲线和测量单位。每个辐射度量都有一个相应的光度计量单位。下表显示了各自的名称和单位，这些单位都有预期的关系。

![[ff3ef5af7ed104536d3ef67e2dfc8a00_MD5.jpg]]

## 色度测量学

上面提到，人眼对光颜色的感知与光的 SPD 密切相关，并且这不是一个简单的一对一关系 (不同 SPD 的光可能被识别为相同颜色)。**色度测量学 (colorimetry)** 处理了光谱功率分布于颜色感知之间的关系。

人眼结构模型如下图。视网膜是感知光的地方，视网膜上存在感光细胞。感光细胞分为视杆细胞和视锥细胞。视杆细胞是一种棒状细胞，数量多，但只感知光的强度。视锥细胞是一种锥形细胞，数量少，用来感知光的颜色。不同人的视锥细胞分布非常不同。

![[2dc84aa2db10c51d6453e07f58f2aaff_MD5.jpg]]

**视锥细胞** 又分为 S, M, L 三种，用来感知不同波长的光。L 负责红色区间，M 负责绿色区间，S 负责蓝色区间。因此，对于给定 SPD，我们大脑只接受来自这些受体的三个不同信号。这就是为什么只需要 3 个数字就可以精确表示任何颜色刺激的原因。

![[be6d887fb1c399a93dd0e64b6720a815_MD5.jpg]]

为了找到这 3 个表示任何颜色刺激的 3 个数字，CIE(国际照明委员会) 提出了一组测量颜色的标准条件，并使用它们进行了色匹配实验。实验方式大致如下，观察者观察由三基色光源组合的光颜色，当组合颜色与光源颜色匹配时，则认为这三基色组合为该颜色。

![[7f87f455ec88e6f0fc4aae92b234e540_MD5.jpg]]

下图显示了称为 r, g, b 三基色的一组测试结果。

![[0bbb1ab0952f63fc100509124ab3f637_MD5.jpg]]

直接实验得到的 rgb 光源的加权不能直接用来表示所有可见颜色，因为它们的色匹配函数波长上存在负权重。CIE 提出三种假象光源，使得可见波长权重均为正值。这些曲线是原始 rgb 色匹配函数的线性组合。

 $\begin{align} r'&=\frac{r}{r+g+b}\\ g'&=\frac{g}{r+g+b}\\ b'&=\frac{b}{r+g+b} \end{align}$

严格来说，RGB 值代表的是感知量而不是物理量。在基于物理的渲染中使用它们在技术上是一个类别错误。正确的方法是使用光谱量进行所有渲染计算，可以通过密集采样或投影到适当基础上表示，只在最后将其转换为 RGB 颜色。

然而，对于大多数渲染系统，特别是那些用于交互式应用程序的系统，它们并不旨在产生预测性模拟，RGB 渲染效果出奇地好。即使在电影特效的离线渲染中，也只是最近开始使用光谱渲染，并且远未普及。

## 参考

《Real-time Rendering 4th》

[基于物理渲染 (PBR) 白皮书](https://github.com/QianMo/PBR-White-Paper/tree/master)

[Games101: Lecture 15](https://sites.cs.ucsb.edu/~lingqi/teaching/resources/GAMES101_Lecture_15.pdf)

[Tutorial on Basic Radiometry for Computer Graphics](https://sugulee.wordpress.com/2021/02/09/tutorial-on-basic-radiometry-for-computer-graphics/)

[孙小磊的计算机图形学笔记](https://zhuanlan.zhihu.com/p/145410416)