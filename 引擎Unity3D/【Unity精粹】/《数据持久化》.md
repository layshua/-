
---
title: 《数据持久化》
aliases: []
tags: []
create_time: 2023-06-08 00:15
uid: 202306080015
banner: "![[]]"
---

![[Pasted image 20230611210946.png]]
**什么是数据持久化？**
数据持久化就是将内存中的数据模型转换为存储模型, 以及将存储模型转换为内存中的数据模型的统称
说人话: **将游戏数据存储到硬盘，硬盘中数据读取到游戏中，也就是传统意义上的存盘。**

**如何理解不同后缀的文件?**
文件后缀名决定了文件的格式
不同的软件可以根据后缀名用来判断文件的类型并且在打开文件时以特定的读取规则去解析它
文件后缀名是人为定的规则可以有无数种，可以自定义

# Playerprefs
## 基本方法
prefs：控制台

- Playerprefs 是 unity 提供的可以用于**存储读取玩家数据的公共类**
- PlayerPrefs 的数据存储类似于**键值对**存储，一个键对应一个值
    - 提供了存储 3 种数据的方法：int float string
    - 键：string 类型
    - 值：int float string  对应 3 种 API
- 如果不同类型用同一键名进行存储，会覆盖数据


> [!NOTE] 数据的唯一性
> PlayerPrefs 中不同数据的唯一性是由 key 决定的，不同的 key 决定了不同的数据，同一项目中如果不同数据 key 相同，会造成数据丢失要保证数据不丢失，就要建立一个保证 key 唯一的规则。

```cs file:存储数据
//直接调用set相关方法只会把数据存到内存里
//当游戏结束时 Unity会自动把数据存到硬盘中
PlayerPrefs.SetInt("myAge",18);  
PlayerPrefs.SetFloat("myHeight",1.75f);
PlayerPrefs.SetString("myName","张三");

//如果游戏不是正常结束的，而是崩溃，数据是不会存到硬盘中的
//可以调用save方法手动把数据存到硬盘中
PlayerPrefs.Save();
```

**注意运行时只要你 set 了对应键值对，即使你没有马上存储 save 在本地，也能够读取出信息**
```cs file:读取数据
int age = PlayerPrefs.GetInt("myAge",20); //可选第二参数，如果找不到myAge的值，就会返回第二个参数   
float height = PlayerPrefs.GetFloat("myHeight");
string name = PlayerPrefs.GetString("myName");
```

```cs file:判断数据是否存在
if(PlayerPrefs.HasKey("myAge"))
{
    print("myAge存在");
}
```

```cs file:删除数据
//删除单个数据
PlayerPrefs.DeleteKey("MyAge");
//删除所有存储的数据
PlayerPrefs.DeleteAll();
```

## 存储其他类型
PlayerPrefs 是有局限性的它只能存 3 种类型的数据，如果你想要存储别的类型的数据只能降低精度或者上升精度来进行存储，当然也可采用下面的小 trick：

```cs file:trick存储bool类型
bool sex = true;
PlayerPrefs.SetInt( "sex", sex ? 1 : 0);
```

**存储更复杂的 List<> 类型**

```cs file:存储更复杂的List<>类型


public class Player
{
    private string _name;
    public int _age;
    private int _atk;
    private int _def;

    //装备信息
    public List<Equipment> EquipmentsList;

    //该变量时一个存储和读取的唯一key标识。识别多个玩家，分别存储
    private string _keyName;

    public void Save()
    {
        PlayerPrefs.SetString(_keyName + "name", _name);
        PlayerPrefs.SetInt(_keyName + "age", _age);
        PlayerPrefs.SetInt(_keyName + "atk", _atk);
        PlayerPrefs.SetInt(_keyName + "def", _def);

        //装备信息
        PlayerPrefs.SetInt("EquipmentsCount", EquipmentsList.Count);
        for (int i = 0; i < EquipmentsList.Count; i++)
        {
            //存储每一个装备的id和数量
            PlayerPrefs.SetInt("EquipmentsID" + i, EquipmentsList[i]._id);
            PlayerPrefs.SetInt("EquipmentsCount" + i, EquipmentsList[i]._count);
        }
    }

    public void Load(string keyName)
    {
        this._keyName = keyName; 
        
        _name = PlayerPrefs.GetString(keyName + "name", "test");
        _age = PlayerPrefs.GetInt(keyName + "age", 18);
        _atk = PlayerPrefs.GetInt(keyName + "atk", 100);
        _def = PlayerPrefs.GetInt(keyName + "def", 1000);

        //装备信息
        int num = PlayerPrefs.GetInt("EquipmentsCount", 0);
        EquipmentsList = new List<Equipment>();
        for (int i = 0; i < num; i++)
        {
            Equipment equipment = new Equipment();
            equipment._id = PlayerPrefs.GetInt("EquipmentsID" + i, 0);
            equipment._count = PlayerPrefs.GetInt("EquipmentsCount" + i, 0);
            EquipmentsList.Add(equipment);
        }
    }
}

public class Equipment
{
    public int _id;
    public int _count;
}

public class NewBehaviourScript1 : MonoBehaviour
{
    void Start()
    {
        Player player1 = new Player();
        player1.Load("Player1");

        print("装备列表数量：" + player1.EquipmentsList.Count);

        for (int i = 0; i < player1.EquipmentsList.Count; i++)
        {
            print("道具ID：" + player1.EquipmentsList[i]._id);
            print("道具数量：" + player1.EquipmentsList[i]._count);
        }


        Equipment equipment1 = new Equipment();
        equipment1._id = 1;
        equipment1._count = 1;

        Equipment equipment2 = new Equipment();
        equipment2._id = 2;
        equipment2._count = 2;

        player1.EquipmentsList.Add(equipment1);
        player1.EquipmentsList.Add(equipment2);

        player1.Save();

        print("装备列表数量：" + player1.EquipmentsList.Count);
        for (int i = 0; i < player1.EquipmentsList.Count; i++)
        {
            print("道具ID：" + player1.EquipmentsList[i]._id);
            print("道具数量：" + player1.EquipmentsList[i]._count);
        }
        
        Player player2 = new Player();
        player2.Load("Player2");
        //...
        player2.Save();
        
        //...
    }
}
```

## 存储位置
不同平台存储位置不同
**Win**
存储在 `HKCU\Software\[公司名称]\[产品名称]` 项下的注册表中
其中公司和产品名称是在“Project settings”中设置的名称。 

1. 运行 regedit
2.  `HKEY_CURRENT_USER/SOFTWARE/Unity/UnityEditor/`公司名称/产品名称
**安卓**
`/data/ data/包名/shared_prefs/pkg-name .xml`
 
**IOS**
`/Librany/Preferences/[应用 ID]. plist`


单独使用它的原生功能，非常适合存储一些对安全性要求不高的简单数据
但是也不能小看它，对它进行简单的封装，也可以让它变得方便又安全

# Json
全称：JavaScript 对象简谱 (JavaScript Object Notation) 
Json 是国际通用的一种轻量级的数据交换格式
主要在网络通讯中用于传输数据，或本地数据存储和读取
易于人阅读和编写，同时也易于机器解析和生成，并有效地提升网络传输效率
![[Pasted image 20230611211123.png]]
我们一般**使用 Json 文件来记录和传输数据**

Json 文档就是使用 Json 格式配置填写的文档后缀一般为.json
我们在游戏中可以把游戏数据按照 Json 的格式标准存储在 Json 文档中，再将 Json 文档存储在硬盘上或者传输给远端，达到数据持久化或者数据传输的目的。

|**Json 和 Xml 的异同（Json 更好用！）** |   |
|:--|:--|
|**共同点**|**不同点**|
|都是纯文本|Json配置更简单|
|都有层级结构|Json在某些情况下读写更快速|
|都具有描述性|  |

Json 格式是一种键值对结构
![[Pasted image 20230611211722.png|450]]

## 语法规则
注释格式和 cs 一样
![[Pasted image 20230611211909.png]]

![[Pasted image 20230611212009.png]]