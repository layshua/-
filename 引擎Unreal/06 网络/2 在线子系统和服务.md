#  1  在线子系统
[虚幻引擎在线子系统和服务 | 虚幻引擎5.2文档 (unrealengine.com)](https://docs.unrealengine.com/5.2/zh-CN/online-subsystems-and-services-in-unreal-engine/)
Online Subsystem 
![[Pasted image 20231003212353.png]]
在线子系统及其接口的存在是为了在给定环境中提供一个抽象层，以实现跨平台的通用联机功能。
这里的平台指的是 Steam、Xbox Live、Facebook 等。可移植性是主要目标之一。

> [!question] 我需要子系统做什么？
默认情况下，您将使用 `SubsystemNULL`。这样您就可以作为 host 托管局域网会话（ LAN Sessions）（这样您就可以通过服务器列表找到会话，并在局域网（LAN）中加入它们）或直接通过 IP 加入。
> 

互联网上不允许这样托管会话，因为没有主服务器为客户端提供服务器/会话列表。
**子系统（例如 Steam）允许您托管在互联网上可见的服务器/会话。**

您也可以创建自己的子系统/主服务器，但这需要在虚幻引擎之外进行大量编码。
## 设计理念

在线子系统的基本**设计目的是处理与不同在线服务之间的异步通信**。由于本地电脑无法得知网络连接速度、服务器延迟和后端服务运行时间，因此无法预测与此类系统交互所需时间。为了处理该问题，**在线子系统对所有远程操作均进行委托，并确保使用支持的异步功能时调用此类委托**。除可在请求完成时进行响应和查询正在运行的请求外。委托还提供单一代码路径以跟踪，因此开发人员无需编写自定义代码来采集不同的成功或失败条件。

服务指定的模块化接口会将支持的功能分组在一起。例如，好友接口处理与好友列表的相关内容，而成就接口处理成就的排列、检查和授予等。在支持功能组的在线服务上，都存在相应功能组的接口，但不受服务支持的特定函数只会返回 `false`。利用此设计，开发人员可为所有在线服务编写相同代码。

在高阶层面上，更复杂的操作将使用[在线异步任务管理器](https://api.unrealengine.com/INT/API/Plugins/OnlineSubsystem/FOnlineAsyncTaskManager/index.html)来支持顺序任务，或者在不同线程上运行的任务。异步任务可以描述自身的依赖性，从而在连续运行顺序任务的同时，使无关任务能够平行且独立运行。在线子系统中的所有接口都以这种方式安排任务，以保持运算的一致性。
## 接口
在线子系统中包含以下接口。

> [!NOTE] 
> 部分接口只针对某些在线服务，取决于每个服务所支持的功能。


|接口|功能组描述|
|---|---|
| [成就](https://docs.unrealengine.com/5.2/zh-CN/online-subsystem-achievements-interface-in-unreal-engine) |列出游戏中的所有成就，解锁成就，并查看自己和其他用户已解锁的成就。|
| [外部UI](https://docs.unrealengine.com/5.2/zh-CN/online-subsystem-external-ui-interface-in-unreal-engine) |打开特定硬件平台或在线服务的内置用户接口。在某些情况下，仅可通过此接口获取部分核心功能的访问权。|
| [好友](https://docs.unrealengine.com/5.2/zh-CN/online-subsystem-friends-interface-in-unreal-engine) |好友和好友列表的相关内容，例如在好友列表中添加用户、阻止和解除阻止用户，以及列出最近遇到的在线玩家。|
| [排行榜](https://docs.unrealengine.com/5.2/zh-CN/online-subsystem-leaderboard-interface-in-unreal-engine) |访问在线排行榜，包括登记自己的得分（或时间），以及在排行榜中查看好友列表或世界其他玩家的得分。|
| [在线用户](https://docs.unrealengine.com/5.2/zh-CN/online-subsystem-user-interface-in-unreal-engine) |收集关于用户的元数据。|
| [状态](https://docs.unrealengine.com/5.2/zh-CN/online-subsystem-presence-interface-in-unreal-engine) |设置用户在线状态的显示方式，例如"在线"、"离开"、"游戏中"等。|
| [购买](https://docs.unrealengine.com/5.2/zh-CN/online-subsystem-purchase-interface-in-unreal-engine) |进行游戏内购和查看购买历史。|
| [会话](https://docs.unrealengine.com/5.2/zh-CN/online-subsystem-session-interface-in-unreal-engine) |创建、撤销和管理在线游戏会话。还包括搜索会话和配对系统。|
| [商店](https://docs.unrealengine.com/5.2/zh-CN/online-subsystem-store-interface-in-unreal-engine) |检索游戏内购可用的条目和特定价格。|
| [用户云](programming-and-scripting/online/online-subsystem-in-unreal-engine/UserCloudInterface) |提供每个用户云文件存储的接口。|
| [语音聊天(EOS)](https://docs.unrealengine.com/5.2/zh-CN/voice-chat-interface-in-unreal-engine) |使用 Epic 在线服务作为语音聊天提供者。|
## 模块


基础模块 ``OnlineSubsystem`` 定义服务指定的模块，并在引擎中进行注册。

在初始化期间，在线子系统将尝试加载 "`Engine.ini` "文件中**指定的默认平台服务器模块。** 对在线服务的所有访问都将通过此模块。

```c++
[OnlineSubsystem]
DefaultPlatformService = <Default Platform Identifier>
```

若成功，未指定参数时，将通过静态 Get 使用默认在线子系统。

```c++
static IOnlineSubsystem* Get(const FName& SubsystemName = NAME_None);
```

若调用此函数需请求其他服务，将按需进行加载。若标识符无效或加载模块失败，将适宜地返回 `null`。

## 委托的使用


与之前的虚幻引擎版本类似，在线子系统在调用具有异步（Asynchronous）副作用的函数时将大量使用委托。


重要的是要尊重委托，在调用链中更下游的函数之前，要等待适当的委托被调用。

不等待异步任务可能会导致崩溃和意外的、未定义的行为。在发生连接故障（如拉线（cable pull）或其他断开事件）时，等待委托尤为重要。在理想情况下，完成一项任务所需的时间似乎是瞬时的，但在超时情况下，则可能长达近一分钟。

委托接口相当简单明了，每个接口头的顶部都明确定义了每个委托。每个委托都有添加、清除和触发（Add, Clear, Trigger）函数。(虽然不鼓励手动触发委托）。

**通常的做法是，在调用相应函数之前先 `Add()` 委托，然后从委托本身 `Clear()` 委托。**
# 2 Online Subsystem Steam

**Online Subsystem Steam API** 使你可以将虚幻引擎（UE）应用程序发布到 [Valve 的 Steam 平台](https://partner.steamgames.com/)。 **Steam** 模块的主要目的是帮助你通过一组功能（如媒介和通栏广告）将应用程序分发给 Steam 用户。此外，Steam 模块实现多个由 [Online Subsystem](https://docs.unrealengine.com/5.2/zh-CN/online-subsystem-in-unreal-engine) 公开的接口，支持 Steamworks Software Development Kit（SDK）提供的大多数功能。

部分可用的 Steam 接口包括：
*   Matchmaking（Lobbies 和 GameServer API）
*   Leaderboards
*   Achievements
*   Voice
*   UserCloud
*   SharedCloud
*   External UI

> [!NOTE] Title
> 请参考[Online Subsystem Steam API](https://docs.unrealengine.com/en-US/API/Plugins/OnlineSubsystemSteam/FOnlineSubsystemSteam "FOnlineSubsystemSteam")以了解当前可用的Steam接口的更完整列表。

## 满足 Valve 的要求

Steam Subsystem 需要通过 [Valve Steamworks](https://partner.steamgames.com/?goto=%2Fhome) 进行额外设置。请联系 [Valve](http://www.valvesoftware.com/contact/) 并参考 [Steamworks SDK 文档](https://partner.steamgames.com/doc/home)以确保你的应用程序满足 Valve 的要求，然后再尝试将 Steam 与 UE 一起使用。

## 下载 Steamworks

如果你的应用程序满足 Valve 的要求，请继续并下载最新版 [Steamworks SDK](https://partner.steamgames.com/)。 SDK 需要解压并复制到 `/YourUnrealEnginePath/Engine/Source/ThirdParty/Steamworks/Steam[当前版本]/sdk`

如果要更新项目的 Steamworks SDK，请确保更新项目 Steamworks 路径中的 `[当前版本]`：  
`/YourUnrealEnginePath/Engine/Source/ThirdParty/Steamworks/`**Steam[当前版本]**`/sdk`  
你还需要更新 `Steamworks.build.cs`，它位于项目目录中。  

![](https://docs.unrealengine.com/5.2/Images/programming-and-scripting/online/online-subsystem-in-unreal-engine/Steam/SteamworksCSFile.jpg)

  
在本示例中， `[当前版本]` 格式为 `v139`。

## 设置 Steamworks SDK

对预编译版本引擎使用 Steam 应只需要将部分动态链接库从 Valve SDK 复制到相应的文件夹。如果你想要根据源代码重新编译引擎，还需要将 SDK 放在合适的位置。现在，将相关的可重新分发文件从 SDK `istributable_bin/` 目录复制到以下位置：

category: paramliteral id: paramliteral content: param active:paramliteral

部分 64 位库位于 Steam 客户端目录中（在编写本文时，Valve 没有将所有库包含在 SDK 中）。

`/YourUnrealEnginePath/Engine/Binaries/ThirdParty/Steamworks/Steam[Current Version]/Win64`

*   `steam_api64.dll`
    
*   `steamclient64.dll`
    
*   `tier0_s64.dll`
    
*   `vstdlib_s64.dll`
    

`/YourUnrealEnginePath/Engine/Binaries/ThirdParty/Steamworks/Steam[Current Version]/Win32`

*   `steam_api.dll`
    
*   `steamclient.dll`
    
*   `tier0_s.dll`
    
*   `vstdlib_s.dll`
    

只有在显式链接不允许为专用服务器版本使用 "-force_steamclient_link" 标签时，才会需要 `tier0_s.dll` 和 `vstdlib_s.dll` 文件。客户端版本永远不会需要这些文件。

category: paramliteral id: paramliteral content: param active:paramliteral

category: paramliteral id: paramliteral content: param active:paramliteral

## Steam 应用 ID

所有使用 Steam Online Subsystem 的游戏都必须有有效的应用程序 ID，因为如果 Steamworks API 不知道你应用程序的 Steam 应用 ID，就无法初始化。在初始化 Steam 之前，UE 将生成 `steam_appid.txt`（在正常关闭引擎时，UE 会删除这个文件）。需要注意的是， `steam_appid.txt` 必须位于应用程序可执行文件所在的目录，因为 Steam 将在当前工作目录寻找这个文本文件。此外，该文件不应包含在任何 Steam 映像中。

如果你打开 `steam_appid.txt`，将会看到 **SteamDevAppId** 条目，这个字段向 Steam 暗示应用程序 ID。这样就无需使用 Steam 客户端（尽管它必须运行）启动游戏。

如果想要测试应用程序，可以使用 **SteamDevAppId** `480`，这是所有开发者共享的测试应用 ID。虽然你可以使用之前提到的测试应用 ID 来测试大都数 Steam 接口，但应用程序需要有 Steam 应用 ID 才能发布。

### 发布构建版

在发布构建版时，引擎会检查以确保登录用户正确订阅了游戏，如果引擎测试返回 false，则会关闭（这是帮助保护游戏的一种方式）。此外，使用 Steam DRM（请参阅 Steamworks SDK）应进一步保护游戏不被篡改。

## 配置应用程序设置

如果你使用 **虚幻项目浏览器** 创建新项目，那么 `DefaultEngine.ini` 中应该没有 **Online Subsystem** 设置；但如果你要修改我们的某个样本项目，则 **Online Subsystem** 设置可能已经存在。

现在，你已经为应用程序设置了 Steamworks SDK（同时设置 Steam 应用 ID），便已准备好了配置应用程序设置以使用 Online Subsystem Steam。

### 步骤

1.  打开项目的 `DefaultEngine.ini` 文件，并添加以下设置：
    
    ```
    [/Script/Engine.GameEngine]
    +NetDriverDefinitions=(DefName="GameNetDriver",DriverClassName="OnlineSubsystemSteam.SteamNetDriver",DriverClassNameFallback="OnlineSubsystemUtils.IpNetDriver")
    ```
    
    **NetDriverDefinitions** 描述了可供 UE 使用的网络驱动器，并添加了以下属性：
    
    *   **DefName** 是该网络驱动器定义的唯一名称。
        
    *   **DriverClassName** 是主网络驱动器的类名称。
        
    *   **DriverClassNameFallBack** 是退却网络驱动器的类名（如果主网络驱动器类初始化失败）。
        
2.  为了告诉 UE 使用 Online Subsystem Steam，添加以下设置：
    
    ```
    [OnlineSubsystem]
    DefaultPlatformService=Steam
    ```
    
3.  现在，你已经告诉 UE，你希望应用程序使用 Steam Online Subsystem，接下来需要添加以下设置来配置 **OnlineSubsystemSteam** 模块：
    
    ```
    [OnlineSubsystemSteam]
    bEnabled=true
    SteamDevAppId=480
    ```
    
4.  最后，需要为应用程序连接在网络驱动器中指定 Steam 类：
    
    ```
    [/Script/OnlineSubsystemSteam.SteamNetDriver]
    NetConnectionClassName="OnlineSubsystemSteam.SteamNetConnection"
    ```
    

之后，接下来的步骤取决于你的游戏使用的是 **会话（Sessions）** 还是 **大厅（Lobbies）**。

### 使用会话

如果你在游戏中使用会话，请在 `OnlineSubsystemSteam` 添加以下内容：

```
bInitServerOnClient=true
```

如果你使用的是大厅，则无需设置该值：

你需要启用 `bInitServerOnClient` 设置，以便用户能够创建和加入会话。如果不启用该设置，Steam 的在线子系统将无法成功初始化。创建会话（Create Session）蓝图节点和相应的 C++ 函数将无法工作，导致你无法加入会话。

### 最终结果

在本简短指南结束后，你的应用程序 `DefaultEngine.ini` 文件应类似于以下设置块。如果你想查看其他项目是如何设置的并使用 Online Subsystem，请参考我们的样本项目库。

#### 完成的设置

**DefaultEngine. ini**

```
[/Script/Engine.GameEngine]
    +NetDriverDefinitions=(DefName="GameNetDriver",DriverClassName="OnlineSubsystemSteam.SteamNetDriver",DriverClassNameFallback="OnlineSubsystemUtils.IpNetDriver")

    [OnlineSubsystem]
    DefaultPlatformService=Steam

    [OnlineSubsystemSteam]
    bEnabled=true
    SteamDevAppId=480

    ; If using Sessions
    ; bInitServerOnClient=true

    [/Script/OnlineSubsystemSteam.SteamNetDriver]
    NetConnectionClassName="OnlineSubsystemSteam.SteamNetConnection"
```

## 服务器和大厅

Steam 支持利用大厅进行点对点匹配（专用和聆听服务器游戏），并提供运行专用服务器的功能。利用大厅，用户可获悉游戏服务器的相关信息，且大厅常用于传达聆听服务器游戏的相关游戏特定信息（如正在游玩的地图或模式等）。通过匹配系统，用户还可在无需加入游戏时看到连接到大厅的用户数量。专用服务器是与大厅不同的的二进制，其任务是运行并主持游戏的服务器端部分。欲了解 Steam 的功能、实现或开发者界面的更多相关信息，请参阅 Steam 网站上的[合作伙伴文档](https://partner.steamgames.com/doc/home)。

### 大厅细节

大厅实质上是 Steam 的后端服务上的聊天室，作为点对点实例存在。与服务器不同，在加入前无法获得如 ping 时或当前其他用户数等大厅相关信息。其通常用于聆听服务器。要设置大厅，将 `bUsesPresence` 和 `bUseLobbiesIfAvailable` 标志设为 `true`。你可以在传递给 `IOnlineSession::CreateSession` 方法的 `FOnlineSessionSettings` 对象中设置。

### 服务器细节

要设置服务器实例，将 `bUsesPresence` 标为 `false`。专用服务器需要以下三种宏，均须与合作伙伴面板（位于 Steam 专用服务器工具页面）上的值匹配。如此类值不匹配，Steam 网络将不显示专用服务器：

<table><caption></caption><colgroup><col> <col> <col></colgroup><thead><tr><th rowspan="1" colspan="1"><p>UE 宏</p></th><th rowspan="1" colspan="1"><p>Steam 命名</p></th><th rowspan="1" colspan="1"><p>说明</p></th></tr></thead><tbody><tr><td rowspan="1" colspan="1"><p><code>UE_PROJECT_STEAMPRODUCTNAME</code></p></td><td rowspan="1" colspan="1"><p><code>STEAMPRODUCTNAME</code></p></td><td rowspan="1" colspan="1"><p>Valve 建议将此设为版本 ID，通常使用 AppID（字符串形式）或无额外符号的简略产品名。</p><p>更改此字段（如更新版本 ID）将导致 Steam 在匹配时忽略使用旧命名的所有活跃服务器，且需在合作伙伴后端修改工具信息。</p></td></tr><tr><td rowspan="1" colspan="1"><p><code>UE_PROJECT_STEAMGAMEDIR</code></p></td><td rowspan="1" colspan="1"><p><code>STEAMGAMEDIR</code></p></td><td rowspan="1" colspan="1"><p>此通常为游戏的文件夹命名，且无可包含空格或符号。若该命名未包含空格或符号，则无需将其设为文件夹命名。</p></td></tr><tr><td rowspan="1" colspan="1"><p><code>UE_PROJECT_STEAMGAMEDESC</code></p></td><td rowspan="1" colspan="1"><p><code>STEAMGAMEDESC</code></p></td><td rowspan="1" colspan="1"><p>Valve 建议将此宏设为产品全名。</p></td></tr><tr><td rowspan="1" colspan="1"><p><code>UE_PROJECT_STEAMSHIPPINGID</code></p></td><td rowspan="1" colspan="1"><p>N/A</p></td><td rowspan="1" colspan="1"><p>要以 UE 4.22 和以上版本，在在 Steam 以外启动，此宏须包含产品的 Steam ID。</p></td></tr></tbody></table>

在 UE 4.22 版中，可在游戏的 `Target.cs` 文件中指定此类值。同时还可通过定义 `UE_PROJECT_STEAMSHIPPINGID`，将 Steam ID 写入版本。所有版本配置均需进行此操作，否则将无法在 Steam 外启动。

对于 4.22 之前的版本，编辑 `OnlineSessionAsyncServerSteam.cpp`，以便其包含游戏的值。

欲了解分发专用服务器版本的相关信息，参阅 [Steam 的合作伙伴文档](https://partner.steamgames.com/doc/sdk/uploading/distributing_gs)。

## Steam 在线验证

Steam 使用一种特殊的验证系统，用于控制对平台提供的部分独特服务器相关功能的访问，如广告服务器和玩家计数、检索禁令列表和做出反应（发行商和 Valve 反作弊禁令）和执行许可证检查。虚幻引擎允许通过 `FOnlineAuthSteam` 类与这个功能连接。应用程序设置为使用 Steam Online Subsystem 后，就可以启用 **SteamAuth** 包处理程序组件来利用这些功能。

### 启用 SteamAuth

要启用 SteamAuth，并将以下内容添加到 "DefaultEngine. ini" 或者针对每一个打算支持 Steam 在线验证的平台，添加到特定于平台的引擎. ini 文件（如 "WindowsEngine. ini"、"LinuxEngine. ini" 或 "MacEngine. ini"）：

```
[PacketHandlerComponents]
    +Components=OnlineSubsystemSteam.SteamAuthComponentModuleInterface
```

启用后，就可以使用 Steam Online Subsystem 接口（SteamOSS）功能 `GetAuthInterface` 来访问 SteamAuth 功能。

启用 SteamAuth 将会使应用程序对所有加入的玩家运行验证程序（针对 Steam 服务）。默认情况下，SteamAuth 将没有通过这项检查的玩家踢出游戏，但这个行为可以被覆盖。

### SteamAuth 委托

SteamAuth 系统中有两个开发者可能希望覆盖的委托：`OverrideFailureDelegate` 和 `OnAuthenticationResultDelegate`。

当玩家尝试加入服务器而没有通过 Steam 验证时，或者玩家在会话期间失去了 Steam 验证，通过玩家的 `FUniqueNetId` 调用 `OverrideFailureDelegate`。默认情况下，SteamAuth 会将玩家踢出游戏。但是，如果该委托受到约束，则默认行为将被暂停，因此开发者必须在仍需要这个行为时手动将玩家踢出。

`OnAuthenticationResultDelegate` 处理来自 Steam 验证服务的响应，提供玩家的 `FUniqueNetId` 和一个指示验证尝试是否成功的布尔值。

## 附加提示

### 使用 IPNetDriver

UE 的 Steam OSS 默认将 Steam 网络用作默认套接字子系统。在 4.22 版中，可通过将 `OnlineSubsystemSteam.bUseSteamNetworking` 设为 `false` 禁用此行为。要进行此操作，请将以下代码添加到 "DefaultEngine. ini"，或者各支持平台的平台特定引擎. ini 文件（如 "WindowsEngine. ini"、"LinuxEngine. ini" 或 "MacEngine. ini"）：

```
[OnlineSubsystemSteam]
bUseSteamNetworking=false
```

在 4.22 之前的版本中，修改调用 `RegisterSocketSubsystem` 函数的 `SocketSubsystemSteam.cpp`，将 `布尔` 参数改为 `false`。同时还需在项目配置文件中修改网络驱动。

### 模块设置

确保将虚幻引擎 Steam 模块作为项目的一部分包含进去（请参阅 [UnrealBuildTool 目标文件](https://docs.unrealengine.com/5.2/zh-CN/unreal-engine-build-tool-target-reference)以获取更多帮助）。具体而言，在 `mygame.build.cs` 的构造函数中添加以下行应足以确保随着游戏构建 Steam 模块。

```
DynamicallyLoadedModuleNames.Add("OnlineSubsystemSteam");
```

### Steam Overlay on Mac

Steam Overlay on Mac 要求通过 Steam 客户端启动游戏。为此，需要先使用 Steam"游戏" 菜单中的 "将非 Steam 游戏添加到我的库" 选项来将游戏添加到库。


# Online Services 在线服务
[Online Services in Unreal Engine | 虚幻引擎5.2文档](https://docs.unrealengine.com/5.2/zh-CN/online-services-in-unreal-engine/)

功能和在线子系统类似，暂时不学习