## 一、前言

游戏开发里四元数是用于旋转计算，由于四元数比较难以理解，因而知乎上有 “如何形象理解四元数” 之类的问题，会有四维空间的介绍，甚至一些图形化的表达方式，而四元数本身是一个抽象后的数学概念，个人觉得直接从四元数的代数性质出发，是理解四元数旋转性质的更简单、快速的方法。

本文对四元数一些性质的推导过程都是很基础的代数运算，其中一些思路来自《大学物理》第 23 卷第 4 期的《三维转动的四元数表述》一文。本文的大部分内容是从一些问题的理解出发，下面先列一下目录：

1. 四元数是超复数、四维向量、轴角？  
2. 四元数为什么能表示旋转？  
3. 为什么四元数旋转向量的公式是： $\mathbf v'=q\mathbf vq^{\ast}$ ？  
4. 为什么旋转向量使用单位四元数？  
5. 四元数的逆或共轭表示什么旋转？  
6. 四元数取反表示什么旋转？  
7. 有没有 0 四元数（0 旋转）？  
8. 代码里如何存储四元数？  
9. 代码里如何计算向量旋转？  
10. 四元数和标量、向量相乘有没有意义？  
11. 四元数和四元数相乘有没有意义？  
12. 四元数可以表示对一个向量的旋转信息，那么如何表示物体的朝向（orientation）？  
13. 四元数如何进行父子空间朝向信息的转换？  
14. 四元数加法有没有意义（四元数与角速度）？  
15. 两个四元数如何进行插值？

## 二、四元数的一些性质

**1. 四元数定义**

关于四元数的来源，可以看简单下百度百科上关于**向量**的发展历史 [[1]](https://zhuanlan.zhihu.com/p/385337220#ref_1) 介绍，大致是：复数可以表达二维向量的运算，四元数则是将复数拓展到三维空间，四元数分为标量部分和向量部分，后来的三维向量的分析运算就脱胎于四元数的向量部分。

四元数的定义是：

$q=s+x\mathbf i+y\mathbf j+z\mathbf k$ ， $\mathbf i^{2}=\mathbf j^{2}=\mathbf k^{2}=\mathbf {ijk}=-1$

四元数标量部分是 $s$ ，向量部分是 $\mathbf v=x\mathbf i+y\mathbf j+z\mathbf k$ ， $\mathbf {i,j,k}$ 是单位向量，因此四元数也可以写成：

$q=s+\mathbf v$

因此四元数是**标量和向量的组合**。

**2. 四元数与向量**

对于 2 个四元数 $q=a+b\mathbf i+c\mathbf j+d\mathbf k$ ， $p=e+f\mathbf i+g\mathbf j+h\mathbf k$ ，其乘积为：

$\begin{align} qp&=(a+b\mathbf i+c\mathbf j+d\mathbf k)(e+f\mathbf i+g\mathbf j+h\mathbf k)\\ &=(ae-bf-cg-dh)+(be+af-dg+ch)\mathbf i\\ &+(ce+df+ag-bh)\mathbf j+(de-cf+bg+ah)\mathbf k\\ &=(ae+a(f\mathbf i+g\mathbf j+h\mathbf k)+e(b\mathbf i+c\mathbf j+d\mathbf k))-(bf+cg+dh)\\ &+(-dg+ch)\mathbf i+(df-bh)\mathbf j+(-cf+bg)\mathbf k\\ \end{align}$

把四元数写出标量加向量的形式： $q=a+\mathbf u$ ， $p=e+\mathbf v$ ， 其中 $\mathbf u=b\mathbf i+c\mathbf j+d\mathbf k$ ， $\mathbf v=f\mathbf i+g\mathbf j+h\mathbf k$ ，则有：

$\mathbf u·\mathbf v=-(bf+cg+dh)$  
$\mathbf u×\mathbf v=(-dg+ch)\mathbf i+(df-bh)\mathbf j+(-cf+bg)\mathbf k$ （叉乘的性质）

那么上面四元数的乘积就变成：

$qp=ae+a\mathbf v+e\mathbf u-\mathbf u·\mathbf v+\mathbf u×\mathbf v$

而本身乘积也可以表示为：

$qp=(a+\mathbf u)(e+\mathbf v)=ae+a\mathbf v+e\mathbf u+\mathbf u\mathbf v$

所以可以得出：

$\mathbf u\mathbf v=-\mathbf u·\mathbf v+\mathbf u×\mathbf v$

同理可得：

$\mathbf v\mathbf u=-\mathbf v·\mathbf u+\mathbf v×\mathbf u=-\mathbf u·\mathbf v-\mathbf u×\mathbf v$ （叉乘是反交换律）

联合上面 2 式可得：

$\mathbf u·\mathbf v=-\frac{\mathbf u\mathbf v+\mathbf v\mathbf u}{2}$  
$\mathbf u×\mathbf v=\frac{\mathbf u\mathbf v-\mathbf v\mathbf u}{2}$

也就是说向量的运算可以用四元数运算获得，如果把 $\mathbf u,\mathbf v$ 当成标量为 0 的四元数，这种四元数其实也叫做**纯四元数**。

而事实上标量和向量都是四元数的一个特例，所以**四元数的性质及运算规则也适用于向量**，四元数本身也有点乘和叉乘 [[2]](https://zhuanlan.zhihu.com/p/385337220#ref_2)：

$p\cdot q=ae+\mathbf u\cdot \mathbf v$  
$p\times q=\mathbf u\times \mathbf v$

此时再看四元数定义里的 $\mathbf i^{2}=\mathbf j^{2}=\mathbf k^{2}=\mathbf {ijk}=-1$

由于 $\mathbf i,\mathbf j,\mathbf k$ 是单位向量，那么就可以得出： $\mathbf i^2=\mathbf i\mathbf i=-\mathbf i·\mathbf i+\mathbf i×\mathbf i=-\mathbf i·\mathbf i=-1$

如果 $\mathbf i,\mathbf j,\mathbf k$ 互相垂直，则： $\mathbf j\mathbf k=-\mathbf j·\mathbf k+\mathbf j×\mathbf k=\mathbf j×\mathbf k=\mathbf i$

刚好反向证明了 $\mathbf i,\mathbf j,\mathbf k$ 的定义。

**3. 四元数的模、共轭、逆**

**四元数的模**：

$|q|=\sqrt{s^{2}+x^{2}+y^{2}+z^{2}}$

复数的共轭是实部相等，虚部相反，因此可以定义**四元数的共轭**：

$q^{\ast}=s-\mathbf v$

令四元数 $q$ 的逆为 $q^{-1}$ ，根据：

$qq^{-1}=q^{-1}q=1$  
$qq^{\ast}=(s+\mathbf v)(s-\mathbf v)=s^{2}-\mathbf{vv}=s^{2}+\mathbf v\cdot \mathbf v=s^{2}+x^{2}+y^{2}+z^{2}=|q|^{2}$  
$q\frac{q^{\ast}}{|q|^{2}}=1$

可得**四元数的逆**：

$q^{-1}=\frac{q^{\ast}}{|q|^{2}}$

那么可知单位四元数： $q_{unit}^{-1}=q_{unit}^{\ast}$

相应的，也可以定义**向量的共轭、逆**，令向量 $\mathbf v=0+\mathbf v=q_{v}$ ，也就是个纯四元数，则：

$\mathbf v^{\ast}=q_{v}^{\ast}=-\mathbf v$  
$\mathbf v^{-1}=q_{v}^{-1}=-\frac{\mathbf v}{|\mathbf v|^{2}}$

**4. 四元数的三角形式**

对与四元数 $q=s+\mathbf v$ ，令： $r=|q|$ ， $\rho=|\mathbf v|$ ，可得： $r=\sqrt{s^{2}+\rho^{2}}$ ，因此对于 $s$ 和 $\rho$ 的关系可以给出极坐标下的形式，即： $s=r\cos\theta$ ， $\rho=r\sin\theta$ ，在令向量 $\mathbf n$ 为向量 $\mathbf v$ 的单位向量，即： $\mathbf v= \rho\mathbf n$ ，那么就可以对四元数的表达式进行变形：

$q=r(\cos\theta+\mathbf n\sin\theta)$

这就是**四元数的三角形式**，这与复数的三角形式： $z=r(\cosθ+i\sinθ)$ 是统一的，区别是一个是单位向量、一个是虚数单位，不过在代数运算上是一样的： $\mathbf n^{2}=i ^{2}=-1$ 。另外复数的三角形式也可以写成指数形式： $z=re^{\theta i}$ ，对应四元数也有一样的**指数形式**：

$q=re^{\theta \mathbf n}$

**5. 四元数的一些运算规则**

利用四元数运算的多项式展开方法，可以证明：

$q_{1}q_{2}\ne q_{2}q_{1}$  
$q_{1}(q_{2}+q_{3})= q_{1}q_{2}+q_{1}q_{3}$  
$(q_{1}q_{2})q_{3}= q_{1}(q_{2}q_{3})$

也就是**四元数满足乘法的分配律、结合律，不满足交换律**。

$(q_{1} q_{2})^{\ast}= q_{2}^{\ast}q_{1}^{\ast}$  
$(q_{1} q_{2})^{-1}= q_{2}^{-1}q_{1}^{-1}$

也就是**四元数乘积的共轭和逆是各个四元数共轭和逆的倒序的乘积**。

## 三、关于四元数的一些问题的理解

**1. 四元数是超复数、四维向量、轴角？**

类比复数定义 $z=a+bi$ ， $i^{2}=-1$ ，四元数可以叫做超复数。

由于四元数有 4 个维度的数据，所以本质上说是四维向量也没有问题，而且确实能从四维空间进行一定的解释，不过四元数设计之初应该不是直接从 4 维空间去考虑的，另外 4 维空间难以理解，因此游戏开发中不必纠结与理解四元数的 4 维空间性质。

轴角是一个有明确几何意思的概念，而四元数的概率更抽象一点，虽然四元数的三角形式代表的几何意义其实是与轴角一样的，但是轴角很难应用与实际运算中，相反四元数非常合适。

**2. 四元数为什么能表示旋转？**

定义向量 $\mathbf a$ 和 $\mathbf b$ ，其夹角为 $\theta$ ， $|\mathbf a|=|\mathbf b|=l$ ， $\mathbf n$ 为垂直于 $\mathbf a$ 、$\mathbf b$ 所在的平面单位向量，则有：

$\mathbf a\cdot \mathbf b=l^{2}\cos\theta$  
$\mathbf a \times \mathbf b=\mathbf nl^{2}\sin\theta$

所以有：

$\mathbf b \mathbf a=-\mathbf a\cdot \mathbf b-\mathbf a\times \mathbf b=-l^{2}\cos\theta-\mathbf nl^{2}\sin\theta$ $\mathbf b=-l^{2}(\cos\theta+\mathbf n\sin\theta)\mathbf a^{-1}=-l^{2}(\cos\theta+\mathbf n\sin\theta)\frac{-\mathbf a}{l^{2}}=(\cos\theta+\mathbf n\sin\theta)\mathbf a$

也就是 $\mathbf b=(\cos\theta+\mathbf n\sin\theta)\mathbf a$ ，其中 $(cos\theta+\mathbf n\sin\theta)$ 就是一个三角形式的单位四元数，因此**存在一个单位四元数可以表示一个向量的旋转操作**。

**3. 为什么是四元数旋转向量的公式是：** $\mathbf v'=q\mathbf vq^{\ast}$ **？**

上一个问题的前提是：“ $\mathbf n$ 为垂直于 $\mathbf a$ 、$\mathbf b$ 所在的平面单位向量”，那么对于任意向量和四元数，有没有表示旋转的形式？

定义向量 $\mathbf a$ 和 $\mathbf b$ ， $|\mathbf a|=|\mathbf b|=l$ ，令 $\mathbf a$ 绕单位向量轴 $\mathbf n$ 旋转 $\theta$ 角度得到 $\mathbf b$ ，将 $\mathbf a$ 分解为平行于 $\mathbf n$ 的 $\mathbf a_{∥}$ 和垂直与 $\mathbf n$ 的 $\mathbf a_{\bot}$ ，实际上只要旋转 $\mathbf a_{\bot}$ 就行了，并且 $\mathbf a_{\bot}$ 满足问题 2 的推导，如下图：

![](<assets/1682505103969.png>)

则有：

$\mathbf a_{∥}=(\mathbf a \cdot \mathbf n)\mathbf n=-\frac{1}{2}(\mathbf a\mathbf n+\mathbf n\mathbf a)\mathbf n=\frac{1}{2}(\mathbf a-\mathbf n\mathbf a\mathbf n)$  
$\mathbf a_{\bot}=\mathbf a-\mathbf a_{∥}=\mathbf a-\frac{1}{2}(\mathbf a-\mathbf n\mathbf a\mathbf n)=\frac{1}{2}(\mathbf a+\mathbf n\mathbf a\mathbf n)$  
$\mathbf a'_{\bot}=(\cos\theta+\mathbf n\sin\theta)\mathbf a_{\bot}=\frac{1}{2}(\cos\theta+\mathbf n\sin\theta)(\mathbf a+\mathbf n\mathbf a\mathbf n)$  
$\begin{align} \mathbf b&=\mathbf a_{∥} + \mathbf a'_{\bot}=\frac{1}{2}(\mathbf a-\mathbf n\mathbf a\mathbf n + (\cos\theta+\mathbf n\sin\theta)(\mathbf a+\mathbf n\mathbf a\mathbf n))\\ &=\frac{1}{2}((\cos\theta+1)\mathbf a+\sin\theta\mathbf n\mathbf a-\sin\theta\mathbf a\mathbf n+(\cos\theta-1)\mathbf n\mathbf a\mathbf n)\\ \end{align}$

令： $\mathbf b=(s+x\mathbf n)\mathbf a(t+y\mathbf n)=st\mathbf a+xt\mathbf n\mathbf a+sy\mathbf a\mathbf n+xy\mathbf n\mathbf a\mathbf n$ ，才能得到上面的表达式，不过这里用四元数的三角式：

$\begin{align} \mathbf b&=x(\cos\alpha+\sin\alpha\mathbf n)\mathbf ay(\cos\beta+\sin\beta\mathbf n)\\ &=xy\cos\alpha\cos\beta\mathbf a+xy\sin\alpha\cos\beta\mathbf n\mathbf a+xy\cos\alpha\sin\beta\mathbf a\mathbf n +xy\sin\alpha\sin\beta\mathbf n\mathbf a\mathbf n\\ \end{align}$

在将原式通过三角函数二倍角公式公式变形：

$\mathbf b=\cos^{2}\frac{\theta}{2}\mathbf a+\sin\frac{\theta}{2}\cos\frac{\theta}{2}\mathbf n\mathbf a-\sin\frac{\theta}{2}\cos\frac{\theta}{2}\mathbf a\mathbf n-\sin^{2}\frac{\theta}{2}\mathbf n\mathbf a\mathbf n$

可得等式：

$xy\cos\alpha\cos\beta=\cos^{2}\frac{\theta}{2}$  
$xy\sin\alpha\cos\beta=\sin\frac{\theta}{2}\cos\frac{\theta}{2}$  
$xy\cos\alpha\sin\beta=-\sin\frac{\theta}{2}\cos\frac{\theta}{2}$  
$xy\sin\alpha\sin\beta=-\sin^{2}\frac{\theta}{2}$

消元得：

$\tan\alpha=\tan\frac{\theta}{2}$  
$\tan\beta=-\tan\frac{\theta}{2}$

可取： $a=\frac{\theta}{2}$ ， $\beta=-\frac{\theta}{2}$ ，那么可得： $xy=1$ （如果取 $a=\frac{\theta}{2}+\pi$ 则 $\sin\alpha$ 和 $\cos\alpha$ 只是取反，不影响最终结果），带入上面假设的三角式就得到：

$\mathbf b=(\cos\frac{\theta}{2}+\sin\frac{\theta}{2}\mathbf n)\mathbf a(\cos\frac{\theta}{2}-\sin\frac{\theta}{2}\mathbf n)$

令四元数 $q=\cos\frac{\theta}{2}+\sin\frac{\theta}{2}\mathbf n$ ，则 $q^{\ast}=\cos\frac{\theta}{2}-\sin\frac{\theta}{2}\mathbf n$ ，因此可得结论：

$\mathbf b=q\mathbf a q^{\ast}$

也就是向量 $\mathbf a$ 绕单位向量轴 $\mathbf n$ 旋转 $\theta$ 角度得到向量 $\mathbf b$ 可由四元数运算获得，这里四元数是单位四元数，所以**任意单位四元数可将任意向量旋转一定角度，旋转轴是四元数向量部分，旋转角度是四元数三角式里角度的 2 倍**。

**4. 为什么是旋转向量使用单位四元数？**

如果不是单位四元数，令 $q'=rq$ ，则：

$\mathbf b'=q'\mathbf a q'^{\ast}=rq\mathbf a rq^{\ast}=r^{2}\mathbf b$

那么新向量的模长会增大四元数模平方的倍数，不过这里也可以发现，只要最终得到的向量在更改模大小就可以了，运算过程中四元数不是单位四元数也没关系。

**5. 四元数的逆或共轭表示什么旋转？**

令单位四元数 $q=\cos\frac{\theta}{2}+\sin\frac{\theta}{2}\mathbf n$ ，则其逆或共轭为 :

$q^{-1}=q^{\ast}=\cos\frac{\theta}{2}-\sin\frac{\theta}{2}\mathbf n=\cos(-\frac{\theta}{2})+\sin(-\frac{\theta}{2})\mathbf n$

也就是**绕相同的轴反向旋转相同的角度**。

**6. 四元数取反表示什么旋转？**

令单位四元数 $q=\cos\frac{\theta}{2}+\sin\frac{\theta}{2}\mathbf n$ ，则取反为 :

$q'=-q=-\cos\frac{\theta}{2}-\sin\frac{\theta}{2}\mathbf n=\cos\frac{2\pi-\theta}{2}+\sin\frac{2\pi-\theta}{2}(-\mathbf n)$

是**绕相反的轴旋转 $2\pi-\theta$ 的角度**，从对向量的旋转结果可以看出其旋转效果是一样的：

$\mathbf v'=(-q)\mathbf v(-q^*)=q\mathbf vq^*$

**7. 有没有 0 四元数（0 旋转）？**

如果四元数不产生旋转效果，也就是 $\theta=0$ ，则 $q=1$ ，这也是引擎里四元数 “Identity” 变量的定义，类似于向量的 “Zero” 变量。

**8. 代码里如何存储四元数？**

因为游戏使用四元数就是表示旋转信息，所以存储内容的就是： $q=\cos\frac{\theta}{2}+\sin\frac{\theta}{2}\mathbf n$ ，也就是绕轴 $\mathbf n$ 旋转 $\theta$ 角度，其中有 4 个维度的数据，因此代码里的数据结构是： $\left[ w,x,y,z \right]$ ，其中： $w=\cos\frac{\theta}{2},x=\sin\frac{\theta}{2} \mathbf n_{x},y=\sin\frac{\theta}{2} \mathbf n_{y},z=\sin\frac{\theta}{2} \mathbf n_{z}$ 。

同样可由 $\left[ w,x,y,z \right]$ 得知四元数的旋转角是： $\theta=2\arccos w$ ，旋转轴是： $\mathbf n=\frac{\left[x,y,z \right]}{\sqrt{x^{2}+y^{2}+z^{2}}}$ 。

**9. 代码里如何计算向量旋转？**

$\mathbf v'=q\mathbf vq^{\ast}$ 只是向量旋转的公式，真正代码计算还是得用到向量的点乘和叉乘，所以对公式进行展开，令单位四元数 $q=t+\mathbf u$ ：

$\begin{align} \mathbf v'&=(t+\mathbf u)\mathbf v(t- \mathbf u)=t^{2}\mathbf v+t\mathbf u\mathbf v-t\mathbf v\mathbf u-\mathbf {uvu} \\ &=t^{2}\mathbf v+2t(\mathbf u\times \mathbf v)+(\mathbf u\cdot\mathbf v)\mathbf u+(\mathbf u\times\mathbf v)\cdot\mathbf u-(\mathbf u\times\mathbf v)\times\mathbf u\\ &=t^{2}\mathbf v+2t(\mathbf u\times \mathbf v)+(\mathbf u\cdot\mathbf v)\mathbf u-(\mathbf u\cdot \mathbf u)\mathbf v+(\mathbf u\cdot \mathbf v)\mathbf u\\ &=(t^{2}-\mathbf u\cdot \mathbf u)\mathbf v+2t(\mathbf u\times \mathbf v)+2(\mathbf u\cdot\mathbf v)\mathbf u\\ \end{align}$

因为 $t^{2}+|\mathbf u|^{2}=1$ ，也就是 $t^{2}+\mathbf u\cdot\mathbf u=1$ ，对上式在进行变形：

$\begin{align} \mathbf v'&=(1-2\mathbf u\cdot \mathbf u)\mathbf v+2t(\mathbf u\times \mathbf v)+2(\mathbf u\cdot\mathbf v)\mathbf u \\ &= \mathbf v+2t(\mathbf u\times \mathbf v)+2((\mathbf u\cdot\mathbf v)\mathbf u-(\mathbf u\cdot \mathbf u)\mathbf v) \\ &=\mathbf v+2t(\mathbf u\times \mathbf v)+2\mathbf u\times (\mathbf u\times \mathbf v) \\ \end{align}$

这就是**引擎里最终使用的向量旋转计算公式**，很简洁，推导过程用到了双重叉乘公式。

**10. 四元数和标量、向量相乘有没有意义？**

四元数和标量相乘就是各个分量和标量相乘，结果会改变四元数的模长，但并不改变四元数旋转数值，四元数和向量相乘的结果是一个新的四元数，标量和向量部分都改变了。2 者单独使用对四元数代表的旋转信息的改变都没有什么明确意义，实际使用是存在与四元数的一些运算中，例如和标量相乘是在四元数的 Normalize 中，和向量相乘是在四元数旋转向量的计算中。

**11. 四元数和四元数相乘有没有意义？**

文中开头分析过四元数相乘的结果是： $pq=st+t\mathbf v+s\mathbf u-\mathbf u·\mathbf v+\mathbf u×\mathbf v$ ，结果还是一个四元数，由于四元数的主要用途表示旋转信息，因此考虑对向量进行多次旋转的情况，例如对向量 $\mathbf v$ 先后进行 $q_{1},q_{2},q_{3}$ 3 次旋转，则旋转结果应为：

$\mathbf v'=q_{1}\mathbf vq_{1}^{*}$  
$\mathbf v''=q_{2}\mathbf v'q_{2}^{*}=q_{2}(q_{1}\mathbf vq_{1}^{*})q_{2}^{*}=(q_{2}q_{1})\mathbf v(q_{1}^{*}q_{2}^{*})=(q_{2}q_{1})\mathbf v(q_{2}q_{1})^{*}$  
$\mathbf v'''=q_{3}\mathbf v''q_{3}^{*}=(q_{3}(q_{2}q_{1}))\mathbf v((q_{2}q_{1})^{*}q_{3}^{*})=(q_{3}q_{2}q_{1})\mathbf v(q_{3}q_{2}q_{1})^{*}$

令四元数 $q=q_{3}q_{2}q_{1}$ ， $\mathbf v'''=q\mathbf vq^{*}$ ，也就是**四元数乘积对向量的旋转相当于各个四元数依次按倒叙对向量进行旋转，所以四元数和四元数相乘代表了旋转的复合**。

**12. 四元数可以表示对一个向量的旋转信息，那么如何表示物体的朝向（orientation）？**

表达物体朝向最直观的方法就是确定物体本地坐标系的 3 个轴，以左手系为例就是：（Forward、Right、Up）3 个轴（Unity 里是 zxy 轴，UE 里是 xyz 轴，所以这里用这个写法代替），可以从世界坐标系的（Forward、Right、Up）旋转一定角度获得，旋转的角度其实就是**欧拉角**，一般也叫做：翻滚角、俯仰角、偏航角（Roll、Pitch、Yaw）：

![](<assets/1682505105176.png>)

当然欧拉角有很多形式，用不同顺序的轴旋转的结果是不一样的，这里用的（Roll、Pitch、Yaw）旋转顺序，旋转轴就是世界坐标轴，有意思的是按照相反的顺序也能获得完全一样的旋转结果，只不过旋转轴是本地坐标轴（欧拉角一般指按本地坐标轴进行旋转，其 Yaw、Pitch、Roll 的旋转形式是与世界坐标轴的 Roll、Pitch、Yaw 旋转形式结果一致的）：

![](<assets/1682505105243.png>)

所以用四元数表示朝向就是 3 次坐标轴向量旋转的复合，旋转轴（Forward、Right、Up）用（x、y、z）代替，旋转角（Roll、Pitch、Yaw）用（ $\alpha$ 、 $\beta$ 、 $\gamma$ ）代替，则转换公式为：

$\begin{align} q_{xyz}&=q_{z}q_{y}q_{x}=(\cos \frac{\gamma}{2}+\sin \frac{\gamma}{2}\mathbf z)(\cos \frac{\beta}{2}+\sin \frac{\beta}{2}\mathbf y)(\cos \frac{\alpha}{2}+\sin \frac{\alpha}{2}\mathbf x) \\ &=(\cos \frac{\alpha}{2}\cos \frac{\beta}{2}\cos \frac{\gamma}{2}+\sin \frac{\alpha}{2}\sin \frac{\beta}{2}\sin \frac{\gamma}{2})\\ &+(-\cos \frac{\alpha}{2}\sin\frac{\beta}{2}\sin\frac{\gamma}{2}+\sin\frac{\alpha}{2}\cos \frac{\beta}{2}\cos \frac{\gamma}{2})\mathbf x\\ &+(\cos \frac{\alpha}{2}\sin\frac{\beta}{2}\sin\frac{\gamma}{2}+\sin\frac{\alpha}{2}\cos \frac{\beta}{2}\sin\frac{\gamma}{2})\mathbf y\\ &+(\cos \frac{\alpha}{2}\cos \frac{\beta}{2}\sin\frac{\gamma}{2}-\sin\frac{\alpha}{2}\sin\frac{\beta}{2}\cos \frac{\gamma}{2})\mathbf z\\ \end{align}$

其中（x、y、z）满足 $\mathbf x^{2}=\mathbf y^{2}=\mathbf z^{2}=\mathbf {xyz}=-1$ ，可求得 $\mathbf {zy}=-\mathbf x$ ， $\mathbf {yx}=-\mathbf z$ ， $\mathbf {zx}=\mathbf y$ ， $\mathbf {zyx}=1$ ，带入展开式即可。这里的结果同维基百科上 [[3]](https://zhuanlan.zhihu.com/p/385337220#ref_3) 是一致的，不过跟虚幻引擎里的并不一致，原因是 UE 里的欧拉角 Roll、Pitch 是顺时针旋转，而 Yaw 是逆时针旋转的，这块具体设计原因不太清楚。

![](<assets/1682505105371.png>)

因此**四元数通过复合运算最终可以表示物体的朝向信息**，由于四元数的旋转信息就是轴和角，所以对任意 2 个朝向，可以直接找到一个轴并使一方绕轴旋转一定角度获得另一方，也就是说 **2 个朝向可以通过一次旋转进行转换**，这也是轴角旋转的原理（欧拉旋转定律）。

**13. 四元数如何进行父子空间朝向信息的转换？**

四元数可以表示物体的朝向，其也代表了从世界空间坐标系到物体本身坐标系的旋转信息，因此在游戏里父子空间下物体朝向信息的转换就是四元数操作的复合。

对于 2 个物体的朝向 $q_{1}$ 和 $q_{2}$ ，物体 1 的朝向是直接从世界坐标系旋转来的，先考虑物体 2 的朝向是在物体 1 的本地坐标系上旋转而来的，也就是说物体 1 的坐标系是物体 2 的 “世界坐标系”，想象一下先把 A 拉回 0 朝向，则物体 2 的朝向就是世界朝向，也就是应用了一个世界空间的 $q_{2}$ ，然后在让 A 应用本身的 $q_{1}$ ，则此时物体 2 就回到了原来的朝向，因为物体 1 的旋转会带动物体 2 旋转，因此物体 2 在世界空间的旋转是：

$q_{w2}=q_{2\rightarrow1}=q_{1}q_{2}$ ，也就是：**世界旋转 = 父世界旋转 * 本地旋转**

在考虑物体 2 的朝向也是从世界坐标系旋转来的，则物体 2 相对与物体 1 的本地朝向的旋转可以从上面的式子进行推导：

$q_{2}=q_{1}q_{l2}$  
$q_{l2}=q_{1}^{-1}q_{2}=q_{1}^{*}q_{2}$ ，也就是：**本地旋转 = 父世界逆旋转 * 世界旋转**

这里应该在回顾一下问题 11，会发现同样是四元数连乘，但是意义却是不一样的，看过 UE 四元数代码应该注意到这个注释：

![](<assets/1682505105432.png>)

也就是公式：

$q'=q(\Delta q)$  
$q'=(\Delta q)q$

前者假定 $\Delta q$ 是本地空间的，对应的是旋转从本地转世界，后者则假定 $\Delta q$ 是世界空间的，对应的是旋转的复合，当然最终都是获得世界空间的新旋转（这里的世界空间也可以理解为父所在空间），使用的时候需要注意下这里的区别。

**14. 四元数加法有没有意义（四元数与角速度）？**

四元数的加法就是各个分量相加，得到一个新的四元数，标量和向量部分都改变了，所以加法本身并不能代表什么实际意义。

四元数加法一个实际应用的地方是在对四元数微分方程的求解上，考虑向量可以代表物体的位置，位置向量对时间求导就是速度，用于描述物体的线性运动，那么四元数可以代表物体的朝向，则四元数的对时间求导应该也能描述物体的旋转运动，由于游戏里一般使用显示欧拉法求解运动微分方程，所以四元数旋转运动方程形式应该是：

$\dot{q}=\frac{dq}{dt}\Rightarrow q_{(t+\Delta t)}=q_{(t)} + \dot{q}\Delta t$

因此**四元数的加法可以体现在四元数的旋转运动方程的求解中**，其中 $\dot{q}=\frac{1}{2}\mathbf ω q$ （ $\mathbf ω$ 是世界空间下的），关于这个公式的推导有很多方式，这里介绍一个利用四元数本身的代数运算规则来推导的方法 [[4]](https://zhuanlan.zhihu.com/p/385337220#ref_4)：

角速度和线速度的关系为： $\mathbf v=\mathbf ω\times \mathbf r$ ，而线速度也能由位置向量 $\mathbf r$ 对时间求导获得： $\mathbf v=\frac{d\mathbf r}{dt}$ ，因此：

$\mathbf v=\frac{d\mathbf r}{dt}=\mathbf ω\times \mathbf r$

其中位置向量 $\mathbf r$ 可以定义一个四元数运算获得： $\mathbf r=q\mathbf r_{0}q^{*}$ ，表示从物体 0 朝向下经由四元数 $q$ 旋转而来，所以 $q$ 也代表了物体目前的朝向，因此可得：

$\frac{d\mathbf r}{dt}=\frac{d}{dt}(q\mathbf r_{0}q^{*})=\dot q\mathbf r_{0}{q}^{*}+q\mathbf r_{0}\dot q^{*}=\mathbf ω\times\mathbf r$

其中 $\mathbf r_{0}$ 是常量，而 $\dot q^{*}$ 可由 $\frac{d}{dt}(qq^{*})=\frac{d}{dt}(1)=\dot q{q}^{*}+q\dot q^{*}=0$ 求得：

$\dot q^{*}=-q^{*}\dot q{q}^{*}$

带入原式可得：

$\dot q\mathbf r_{0}{q}^{*}-q\mathbf r_{0}q^{*}\dot q{q}^{*}=\dot q({q}^{*}q)\mathbf r_{0}{q}^{*}-\mathbf r\dot q{q}^{*}=\dot q{q}^{*}\mathbf r-\mathbf r\dot q{q}^{*}=\mathbf ω\times\mathbf r$

另 $q\dot q^{*}=(\dot q{q}^{*})^{*}$ 可得： $\dot q{q}^{*}+q\dot q^{*}=\dot q{q}^{*}+(\dot q{q}^{*})^{*}=0$ ，也就是说形如 $\dot q{q}^{*}$ 的四元数肯定是一个纯四元数，也就是个向量，由向量的乘法运算可知：

$(\dot q{q}^{*})\mathbf r-\mathbf r(\dot q{q}^{*})=2(\dot q{q}^{*}) \times\mathbf r=\mathbf ω\times \mathbf r$

由于 $\mathbf ω$ 与 $\mathbf r$ 是垂直的，因此只有一个解就是： $2\dot q{q}^{*} =\mathbf ω$ ，也就得到最终结果：

$\dot q =\frac{1}{2}\mathbf ωq$

**15. 两个四元数如何进行插值？**

对两个四元数进行插值有几个思路，第一个是针对四元数的代数表达式进行直接插值，也就是针对标量部分和向量部分或者 4 个分量进行插值，第二个是将四元数理解成旋转信息，也就是旋转轴加旋转角，则 2 个四元数插值可以分别对旋转轴和旋转角进行插值，第三个是将四元数看成一个朝向，而 2 个朝向可以通过一个四元数的旋转进行转换，那么就可以找到一个转换四元数，然后对这个转换四元数的旋转角进行插值。

第一个思路，令四元数 $q=s+\mathbf v$ 和 $p=t+\mathbf u$ ，插值系数 $\alpha$ ，则插值后的四元数为：

$q'=\alpha s+\alpha\mathbf v+(1-\alpha)t+(1-\alpha)\mathbf u$

第二个思路，令四元数 $q=\cos\frac{\theta}{2}+\sin\frac{\theta}{2}\mathbf n$ 和 $p=\cos\frac{\eta}{2}+\sin\frac{\eta}{2}\mathbf m$ ，插值系数 $\alpha$ ，则插值后的四元数为：

$q'=\cos\frac{\alpha\theta+(1-\alpha)\eta}{2}+\sin\frac{\alpha\theta+(1-\alpha)\eta}{2}\mathbf (\alpha\mathbf n+(1-\alpha)\mathbf m)$

第三个思路，对于四元数 $q=s+\mathbf v$ 和 $p=t+\mathbf u$ ，插值系数 为 $\alpha$ ，转换四元数为： $q=(\Delta q)p\Rightarrow\Delta q=qp^{*}$ ，则插值后的四元数为：

$\Delta q= (s+\mathbf v)(t-\mathbf u)=st+\mathbf v\cdot \mathbf u+t\mathbf v-s\mathbf u-\mathbf v\times \mathbf u=\cos\frac{\theta}{2}+\sin\frac{\theta}{2}\mathbf n$  
$\theta=2\arccos(st+\mathbf v\cdot \mathbf u),\mathbf n=\frac{t\mathbf v-s\mathbf u-\mathbf v\times \mathbf u}{\sin\frac{\theta}{2}}$  
$q'=(\cos\frac{\alpha\theta}{2}+\sin\frac{\alpha\theta}{2}\mathbf n)p$

如果这个思路写成四元数的指数形式的话就是：

$\Delta q=\cos\frac{\theta}{2}+\sin\frac{\theta}{2}\mathbf n=e^{\frac{\theta}{2}\mathbf n}$  
$q'=(\cos\frac{\alpha\theta}{2}+\sin\frac{\alpha\theta}{2}\mathbf n)p=e^{\alpha\frac{\theta}{2}\mathbf n}p=\Delta q^{\alpha}p=(qp^{*})^{\alpha}p$

这其实就是**四元数的 Slerp 插值公式**，对上面的推导公式进行进一步化简可得：

$\mathbf n=\frac{qp^{*}-\cos\frac{\theta}{2}}{\sin\frac{\theta}{2}}$  
$\begin{align} q'&=(\cos\frac{\alpha\theta}{2}+\sin\frac{\alpha\theta}{2}(\frac{qp^{*}-\cos\frac{\theta}{2}}{\sin\frac{\theta}{2}}))p=\cos\frac{\alpha\theta}{2}p+\frac{\sin\frac{\alpha\theta}{2}q-\sin\frac{\alpha\theta}{2}\cos\frac{\theta}{2}p}{\sin\frac{\theta}{2}}\\ &=\frac{\cos\frac{\alpha\theta}{2}\sin\frac{\theta}{2}p-\sin\frac{\alpha\theta}{2}\cos\frac{\theta}{2}p+\sin\frac{\alpha\theta}{2}q}{\sin\frac{\theta}{2}}=\frac{\sin\frac{\alpha\theta}{2}q-\sin\frac{(a-1)\theta}{2}p}{\sin\frac{\theta}{2}}\\ &=\frac{\sin\frac{\alpha\theta}{2}q+\sin\frac{(1-\alpha)\theta}{2}p}{\sin\frac{\theta}{2}} \end{align}$

如果令 $\Omega=\frac{\theta}{2}=\arccos(st+\mathbf v\cdot \mathbf u)=\arccos(q\cdot p)$ ，则最终的形式就是：

$q'=\frac{\sin(\alpha\Omega) q+\sin{((1-\alpha)\Omega)}p}{\sin\Omega}=\frac{\sin(\alpha\Omega)}{\sin\Omega}q+\frac{\sin{((1-\alpha)\Omega)}}{\sin\Omega}p$

这就是实际计算时用到的四元数的 Slerp 公式，之所以叫 Slerp 是因为公式跟向量的 Slerp 是一样的，而且角 $\Omega$ 正好也是四元数的点积，这也应征了四元数的四维向量的性质。

然后看一下 3 个方案的效果，从左到右按照上面的思路顺序来，最后一个是对欧拉角的线性插值效果：

![](<assets/1682505105510.png>)

![](<assets/1682505105577.png>)

第一个方案其实就是四元数的 Nlerp（Lerp 之后在 Normalize 一下），效果上跟第三个 Slerp 还有点区别的，Slerp 因为是对旋转角进行插值的，所以插值变化时角速度时不变的，看起来更平稳，Nlerp 则是中间快 2 头慢，具体可以参考向量的 Lerp 和 Slerp 的分析 [[5]](https://zhuanlan.zhihu.com/p/385337220#ref_5)，方案 2 的旋转效果看起来是大概是一个先慢后快的过程，不过计算量比 Slerp 大一点。另外第二张图可以明显看见 Slerp 旋转的路径更简单（可以看到 XY 轴旋转角度小于 180 度），这是因为引擎在实际处理 Slerp 的时候会判断插值的旋转角，如果比较大那么可以对转换四元数进行取反，这样旋转的角度就会变小，旋转路径更短，这也是 Slerp 的一个优势。

## 参考

1.  [^](https://zhuanlan.zhihu.com/p/385337220#ref_1_0) 向量 [https://baike.baidu.com/item/%E5%90%91%E9%87%8F/1396519?fr=aladdin](https://baike.baidu.com/item/向量/1396519?fr=aladdin)
2.  [^](https://zhuanlan.zhihu.com/p/385337220#ref_2_0) 四元数 [https://baike.baidu.com/item/%E5%9B%9B%E5%85%83%E6%95%B0/5795379?fr=aladdin](https://baike.baidu.com/item/四元数/5795379?fr=aladdin)
3.  [^](https://zhuanlan.zhihu.com/p/385337220#ref_3_0)Conversion between quaternions and Euler angles [https://en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles](https://en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles)
4.  [^](https://zhuanlan.zhihu.com/p/385337220#ref_4_0)How to Integrate Quaternions [https://www.ashwinnarayan.com/post/how-to-integrate-quaternions/](https://www.ashwinnarayan.com/post/how-to-integrate-quaternions/)
5.  [^](https://zhuanlan.zhihu.com/p/385337220#ref_5_0) 四元数与三维旋转 [https://krasjet.github.io/quaternion/quaternion.pdf](https://krasjet.github.io/quaternion/quaternion.pdf)