
---
title: 11 曲线与曲面
aliases: []
tags: []
create_time: 2023-08-08 13:35
uid: 202308081335
banner: "![[Pasted image 20230808133603.png]]"
---

# 曲线与曲面
## 概述

三角形是渲染流水线中的默认图元。然而，我们可以通过曲线和曲面方程对原始三角形进行变换，从而生成更多用于渲染的表示曲面的三角形。
**使用曲面表示模型具有以下优点：**
(1) 比三角形集合具有更紧凑的表示方式；
(2) 提供可扩展的几何图元；
(3) 提供比直线和平面三角形更平滑和连续的图元；
(4) 动画和碰撞检测可能变得更简单和更快速。

**在实时渲染中，曲面具有以下优势**：可以节省模型存储内存，对曲面进行变换通常涉及较少的矩阵乘法，相较于使用网格表示曲面进行变换。如果图形硬件可以直接接受这样的曲面描述，那么主机 CPU 发送到图形硬件的数据量通常比发送三角形网格要少得多。

使用曲面还带来了可伸缩性的优点。这意味着可以根据某些因素动态决定曲面的三角形数量。

**概念总结：**
**镶嵌 (tessellation)**：在实时渲染中，我们需要计算并创建 (多个) 三角形对真实曲面进行拟合，这个过程称为镶嵌。在运行时，表面可以被镶嵌为多个小三角形。
**控制点（control point）**：控制点是定义曲面形状的关键元素。它们是二维或三维空间中的点，用于确定曲面的控制网格。一般来说，曲面通过关于控制点的方程计算生成。比如贝塞尔曲线通过控制点控制曲线，三角形可以看作时拥有 3 个控制点的面片。
**面片（patch）**：对于一个参数曲面 $p(u,v)$ ，如果定义域 $(u,v)$ 为矩形，则称该曲面为 patch。可以看成是多个顶点的集合，包含每个顶点的属性。**（属性是所有顶点共享的，不是每个顶点有独自的属性）**
## 参数曲线

**参数曲线 (parametric curve)** 使用方程作为关于参数 $t$ 的函数来描述**点**。我们将其写做 $p(t)$ ，这意味着该函数每个 $t$ 值都会生成一个点。 $t\in[a,b]$ 称为定义域。生成的点是连续的，即 $\sigma\rightarrow 0,~p(t+\sigma)\rightarrow p(t)$ 。

### 贝塞尔曲线

点 $(p_0, p_1)$ 构成的线段可以使用**线性插值方程** $p(t)$ 描述，即

$\mathbf{p}(t)=\mathbf{p_{0}}+t(\mathbf{p_{1}}-\mathbf{p_{0}})=(1-t)\mathbf{p_{0}}+\mathbf{p_{1}},~t\in[0,1]$

如下图左，线性插值对两点路径拟合较好，但对多个点的路径拟合会产生连接处的突变。

![[17f9b8be9261fec5cbba5e33bf3f0c31_MD5.jpg]]

为了解决这个问题，我们采用**重复线性插值**的方式。通过这样做，我们得到了 **Bezier 曲线**的几何构造。

为了能够进行重复插值，我们需要引入更多的点，它们被称为**控制点 (control points)**。例如下图中，我们引入 $abc$ 作为控制点。假设我们要求 $ac$曲线路径上的点 $f$。首先，在 ab 上找线性 $t=1/3$ 的点即 $d=p_{ab}(1/3)$ 。然后，在 $bc$ 上找 $e=p_{bc}(1/3)$ 。最后，在 de 上找 $f=p_{de}(1/3)$ 。

![[d7c856b385027dcfc95dd274a547da50_MD5.jpg]]

通过上述描述，我们将 $p(t)=f$ ，最终得到如下的关系：

$\begin{align} \mathbf{p}(t)&=(1-t)\mathbf{d}+t\mathbf{e}\\ &=(1-t)[(1-t)\mathbf{a}+t\mathbf{b}]+t[(1-t)\mathbf{b}+t\mathbf{c}]\\ &=(1-t)^{2}\mathbf{a}+2(1-t)t\mathbf{b}+t^{2}\mathbf{c} \end{align}$

观察发现 $t$ 的最大次数为 2，因此这是一个抛物线。**实际上，给定 $n+1$ 个控制点，曲线的次数就是 $n$**。这意味着更多的控制点为曲线提供了更多的自由度。

这种重复插值计算贝塞尔曲线的方法称为 **de Casteljau 德卡斯特里奥算法**。在这个算法中，我们定义插值次数 $k$ ，由此次插值产生的点为 $p_{i}^{k}$ ，其中 $i\in[0,n-k]$ 。那么，由 $n+1$ 个控制点定义的 $n$ 阶贝塞尔曲线可以用如下公式表示：

$p_{i}^{k}(t)=(1-t)\mathbf{p_{i}^{k-1}}(t)+t\mathbf{p_{i+1}^{k-1}}(t),~\left\{\begin{align}k&=1...n,\\i&=0...n-k.\end{align} \right.$

各点的关系可以从下图中看出：

![[34a5fa3ae5ef0669991f06e72f312b60_MD5.jpg]]

事实上，我们可以将 de Casteljau 算法展开，得到它的线性表达式。这又称为使用 **伯恩斯坦多项式 (bernstein polynomials)** 的贝塞尔曲线。

$\mathbf{p}(t)=\sum_{i=0}^{n}B_{i}^{n}\mathbf{p_{i}}$

其中， $B_{i}^{n}$ 被称为 **伯恩斯坦多项式 (bernstein polynomials)** 或 **贝塞尔基方程** 。也就是说，我们可以将这个线性展开理解为**先算出所有的基向量，再对控制点线性组合**。

$B_{i}^{n}(t)=\left(\begin{matrix}n\\i\end{matrix} \right)t^{i}(1-t)^{n-i}=\frac{n!}{i!(n-i)!}t^{i}(1-t)^{n-i}$

![[5c534229cea65ecf6a323a86d25a11a1_MD5.jpg]]

如上图，伯恩斯坦系数有如下性质。

$B_{i}^{n}(t)\in[0,1],~when t\in[0,1],~~~~and~~\sum_{i=0}^{n}B_{i}^{n}(t)=1$

这两个性质确保贝塞尔曲线会经过起点和终点。并且具有**凹包性质**，即曲线一定不会超出所有控制点构成的多边形范围。

![[ddccc1225d07d395c661f05bb6d0b121_MD5.jpg]]

另外，对曲线直接应用仿射变换 (平移，缩放，旋转) 等效于先对控制点进行相同放射变换，然后对新控制点计算新曲线。控制点的数量是小于曲线上点的数量的，所以后者计算更为高效。

我们可以将伯恩斯多项式写作矩阵形式，这在某些数学运算上更为简洁。以三次贝塞尔曲线 (cubic bezier curve) 为例，它的线性展开为：

$\mathbf{p}(t)=(1-t)^{3}\mathbf{p_{0}}+3t(1-t)^{2}\mathbf{p_{1}}+3t^{2}(1-t)\mathbf{p_{2}}+t^{3}\mathbf{p_{3}}$

我们将其重写为矩阵形式：

$p(t)=\begin{bmatrix}1&t&t^{2}&t^{3}\end{bmatrix} \begin{bmatrix}1& 0& 0 &0\\ -3& 3& 0& 0\\ 3& -6& 3& 0\\ -1& 3& -3& 1\end{bmatrix} \begin{bmatrix}p_{0}\\ p_{1}\\ p_{2}\\ p_{3}\end{bmatrix}$

我们可以运用导数的乘方与乘积运算法则来求出伯恩斯坦基函数的导数，然后将它们整理起来，最终得到贝塞尔曲线的导数为：

$\frac{d}{dt}\mathbf{p}(t)=n\sum_{i=0}^{n-1}B_{i}^{n-1}(t)(\mathbf{p}_{i+1}-\mathbf{p}_{i})$

可以发现，**贝塞尔曲线的导数是阶数比原方程少 1 的贝塞尔曲线**。

贝塞尔曲线也存在一些**缺点**，首先它不会通过所有的控制点（除了端点）。并且，随着控制点数量的增加，曲线的阶数也会增加，导致计算变得越来越昂贵。

## 参数曲面

**参数曲面 (parametric)** 是参数曲线的自然延伸，就像三角形或四边形是 1D 到 2D 的扩展，参数曲面可以用来建模具有弯曲表面的物体。一个参数曲面由少量的 **控制点 (control points)** 控制。在实时渲染中，我们需要计算并创建 (多个) 三角形对真实曲面进行拟合，这个过程称为**镶嵌 (tessellation)**。在运行时，表面可以被镶嵌为多个小三角形。因此，参数曲面非常适合在质量和速度之间进行权衡。另一个优点是控制点可以被动画化，并且随后对表面进行镶嵌处理；而直接动画化大型三角网格则可能代价更高。

### 贝塞尔曲面

**贝塞尔曲面 (bezier patches)** 由贝塞尔曲线从一个参数扩展为两个参数得到。我们先讨论如何得到一个由 4 控制点得到的参数曲面。首先给出四个控制点 $abcd$ 。并且用参数 $(u, v)$ 代替参数 $t$ ， $u$ 用来对 $a\&b$ 和 $c\&d$ 进行线性插值得到 $e$ 和 $f$ ， $v$ 用来对 $e\&f$ 线性插值得到 $p(u,v)$ 。

![[24ad1dccf80c7931734e61e9ff92463b_MD5.jpg]]

这个过程用表达式为：

$\begin{align} \mathbf{p}(u,v)&=(1-v)\mathbf{e}+v\mathbf{f}\\ &=(1-u)(1-v)\mathbf{a}+u(1-v)\mathbf{b}+(1-u)v\mathbf{c}+uv\mathbf{d} \end{align}$

注意到，这与纹理双线性插值方程相同，它描述了最简单的非平面参数曲面，其中曲面上不同的点由定义域 $(u,v)\in[0,1]^{2}$ 生成。当定义域为矩形时，我们称这个曲面为**面片 (patch)**。

贝塞尔曲面同样可以通过重复插值得到。以下图双二次 (biquadratic) 贝塞尔曲面为例，首先定义 9 个控制点，然后插值相邻 4 个控制点得到 4 个新控制点，再用 4 个新控制点插值得到最终点。

![[9cef64cf0b436748a1f7f520a261d15a_MD5.jpg]]

我们定义曲面的阶数为 $n$ ，控制点为 $p_{i,j},~i,j\in[0,n]$ ，因此该曲面共有 $(n+1)^{2}$ 个控制点。令第 k 次插值生成的控制点为 $p^{k}_{i,j}$ 。可以得到 **de Casteljau[patches]**：

$\begin{align} p_{i,j}^{k}(u,v)&=(1-u)(1-v)\mathbf{p_{i,j}}^{k-1}+u(1-v)\mathbf{p_{i,j+1}}^{k-1}+(1-u)v\mathbf{p_{i+1,j}}^{k-1}+uv\mathbf{p_{i+1,j+1}^{k-1}}\\ k&=1...n,~~i=0...n-k,~~j=0...n-k \end{align}$

我们同样可以将它展开为 **Bernstein[patches]**：

$\begin{align} p(u,v)&=\sum_{i=0}^{m}B_{i}^{m}(u)\sum_{j=0}^{n}B_{j}^{n}(v)p_{i,j}=\sum_{i=0}^{m}\sum_{j=0}^{n}B_{i}^{m}(u)B_{j}^{n}(v)\mathbf{p_{i,j}}\\ &=\sum_{i=0}^{m}\sum_{j=0}^{n}\left(\begin{matrix}m\\i\end{matrix}\right)\left(\begin{matrix}n\\j\end{matrix}\right)u^{i}(1-u)^{m-i}v^{j}(1-v)^{n-j}\mathbf{p_{i,j}} \end{align}$

再伯恩斯坦多项式中，我们定义了 $m\times n$ 的复合度数。对于第一个式子，我们可以理解为 **先算出每列的控制点，然后再将每列控制点按行加权得到最终点** 。第二个式子可以理解为**先计算出两个方向的基数，然后计算出 i,j 基向量，最后将所有基向量组合起来**。

![[865720b2550811e624dab0ec9e646c67_MD5.jpg]]

如果说 m>n，则需要先进性 n 次双线性插值，然后再进行 m-n 次线性插值，如下图。

![[030a136c1b03f3d5c7197cff63efd8c1_MD5.jpg]]

但在一般情况下，m=n，伯恩斯坦多项式可以简写为：

$\mathbf{p}(u,v)=\sum_{i=0}^{m}B_{i}^{m}(u)\sum_{j=0}^{n}B_{j}^{n}(v)p_{i,j}=\sum_{i=0}^{m}B_{i}^{m}(u)\mathbf{q_{i}}(v)$

贝塞尔曲面同样有性质

$\sum_{i=0}^{m}\sum_{j=0}^{n}B_{i}^{m}(u)B_{j}^{n}(v)=1$

这意味着贝塞尔曲面一定过对角点，并且曲面再凹包内。同样的，对贝塞尔曲面直接进行仿射变换 (缩放，平移，旋转) 等效于对控制点进行相同变换后计算新的曲面，后者更为高效。

同样运用导数的乘方与乘积运算法则来求出伯恩斯坦基函数的导数，然后将它们整理起来，最终得到贝塞尔曲面的导数为：

$\begin{align} \frac{\partial{\bf p}(u,v)}{\partial u}&=m\sum_{j=0}^{n}\sum_{i=0}^{m-1}B_{i}^{m-1}(u)B_{j}^{n}(v)[{\bf p}_{i+1,j}-{\bf p}_{i,j}], \\ \frac{\partial{\bf p}(u,v)}{\partial v}&=n\sum_{i=0}^{m}\sum_{i=0}^{n-1}B_{i}^{m}(u)B_{j}^{n-1}(v)[{\bf p}_{i,j+1}-{\bf p}_{i,j}]. \end{align}$

将两个偏导叉乘， 可以计算未归一化的法线：

$\mathbf{n}(u,v)={\frac{\partial\mathbf{p}(u,v)}{\partial u}}\times{\frac{\partial\mathbf{p}(u,v)}{\partial v}}.$

### 贝塞尔三角形

贝塞尔三角形不像贝塞尔面片那样直截了当，但它却能衍生出 **PN 三角形**和 **Phong Tessellation**，这些技术快速而简单。

**n 阶贝塞尔三角形意味着每条边有 n+1 个控制点**，它们被表示为 $p_{i,j,k}^{0}$ ，其中 $i+j+k=n,~i,j,k\geq n$ 。因此，n 阶贝塞尔的控制点个数为：

$C(n+2,2)=\frac{(n+1)(n+2)}{2}$

贝塞尔三角形同样可以通过重复插值计算得到，但是三角形的插值是通过**重心坐标插值 (barycentric coordinates)** 进行的，即

$\mathbf{p}(u,v)=\mathbf{p}_{0}+u(\mathbf{p}_{1}-\mathbf{p}_{0})+v(\mathbf{p}_{2}-\mathbf{p}_{0})=(1-u-v)\mathbf{p}_{0}+u\mathbf{p}_{1}+v\mathbf{p}_{2}$

其中， $(u,v)$ 为重心坐标，且 $u\geq 0,~v\geq 0,~w=1-(u+v)\geq 0,~u+v\leq 1$ 。

在这个基础上，可以推出 **de Casteljau [triangles]**：

$\begin{align} \mathbf{p}_{i,j,k}^{l}(u,v)&=u{\bf p}_{i+1,j,k}^{l-1}+v{\bf p}_{i,j+1,k}^{l-1}+(1-u-v){\bf p}_{i,j,k+1}^{l-1},\\ l&=1... n,\quad i+j+k=n-l \end{align}$

贝塞尔三角形的最终顶点在 $\mathbf{p}_{000}^{n}(u,v)$ 。

![[ca8d7aff54c0242d03f140d941d7fe33_MD5.jpg]]

将 de Casteljau 展开为 **Bernstein [triangles]**：

${\bf p}(u,v)=\sum_{i+i+k=n}B_{i j k}^{n}(u,v){\bf p}_{i j k}.$

由于伯恩斯坦项基于重心坐标插值，它与贝塞尔面片的表达式有所不同：

$B_{i j k}^{n}(u,v)=\frac{n!}{i!j!k!}u^{i}v^{j}(1-u-v)^{k},\ \ \ i+j+k=n.$

同样地，可以求出 **Derivatives [triangles]**：

$\begin{align} \frac{\partial\mathrm{p}(u,v)}{\partial u}&=\sum_{i+j+k=n-1}n B_{i j k}^{n-1}(u,v){\big(}\mathrm{p}i{+}1,j,k-\mathrm{p}i,j,k+1{\big)},\\ \frac{\partial\mathrm{p}(u,v)}{\partial v}&=\sum_{i+j+k=n-1}n B_{i j k}^{n-1}(u,v){\big(}\mathrm{p}i,j+1,k-\mathrm{p}i,j,k+1{\big)}. \end{align}$

同贝塞尔面片，贝塞尔三角形一定过三个原控制点，并且曲面在控制点凹包内。

### PN 三角形
P：point  N：normal
**PN 三角形方案旨在通过使用点和法线来构建曲面，以改善三角网格的阴影和轮廓。** 该算法**不需要邻居信息即可从每个三角形的点和法线生成曲面，并且可以在硬件上进行细分。**

![[f709f22cd4bb8a1213101237d27f806d_MD5.jpg]]

PN 三角形需要且**仅需要**一个三角形的如下信息：顶点位置 $\mathbf{p}{300}, ~\mathbf{p{030}},~ \mathbf{p}{003}$ 和顶点法线 $\mathbf{n}{200},~\mathbf{n}{020},~\mathbf{n}{002}$ 。根据这些数据，生成如下图 7 个控制点。然后根据这总共 10 个控制点，得到贝塞尔三角面上的顶点。对法线做类似的处理，我们后面再讨论。

![[f39655381c0738b733680e825e65741b_MD5.jpg]]

令 $w=1-u-v$ ，则三次 (cubic) 贝塞尔三角形的表达式为：

$\begin{align} {\bf p}(u,v)&=\sum_{i+j+k=3}B_{i j k}^{3}(u,v){\bf p}_{i j k}\\ &=u^{3}{\bf p}_{300}+v^{3}{\bf p}_{030}+w^{3}{\bf p}_{003}+3u^{2}v{\bf p}_{210}+3u^{2}w{\bf p}_{201} \\ &+3u v^{2}{\bf p}_{120}+3v^{2}w{\bf p}_{021}+3v w^{2}{\bf p}_{012}+3u w^{2}{\bf p}_{102}+6u v w{\bf p}_{111}. \end{align}$

为了计算曲面顶点位置，我们需要先生成剩下的七个控制点的位置。为了保证贝塞尔曲面的 $C^{0}$ **连续性** (相邻贝塞尔曲面的边界处控制点相同)，边缘六个控制点可以由对角三个控制点的位置计算得到，而重心控制点可以由剩余控制点计算得到。

注意到由顶点法线够成的**顶点切线空间**都是相应的局部几何。假设我们要计算控制点 $\mathbf{p}{210}$ 的位置，可以简单地将 $\frac{2}{3}\mathbf{p}{300}+\frac{1}{3}\mathbf{p}{030}$ 投影到由顶点 $\mathbf{p}{300}$ 和对应法线 $\mathbf{n}_{200}$ 的切线空间中。

![[1b6d96c7e3c569672b2cf29ca59d9d9b_MD5.jpg]]

假设都是归一化向量，那么：

$\mathbf{p}_{210}={\frac{1}{3}}(2{\bf p}_{300}+{\bf p_{030}}-({\bf n}_{200}\cdot({\bf p}_{030}-{\bf p}_{300})){\bf n}_{200}).$

其他边缘控制点的计算类似。中心控制点可以由其他控制点计算得到：

$\mathbf{p}_{111}=\frac{1}{4}(\mathbf{p}_{210}+\mathbf{p}_{120}+\mathbf{p}_{102}+\mathbf{p}_{201}+\mathbf{p}_{021}+\mathbf{p}_{012})-\frac{1}{6}(\mathbf{p}_{300}+\mathbf{p}_{030}+\mathbf{p}_{003})$

下面讨论法线的计算。简单来说，首先，线性插值不足以描述曲面变化后的法线。由于曲面是三次贝塞尔面，所以法线应该是二次贝塞尔曲面插值。即：

$\begin{align} \mathbf{n}(u,v)&=\sum_{i+j+k=2}B_{i j k}^{2}(u,v)\mathbf{n}_{i j k}\\ &=u^{2}{\bf n}_{200}+v^{2}{\bf n}_{020}+w^{2}{\bf n}_{002}+2(u v{\bf n}_{110}+u w{\bf n}_{101}+v w{\bf n}_{011}). \end{align}$

为了完成上述公式的计算，我们需要额外的 3 个法线控制点。（只有下图三角形绕序为逆时针，下面给的公式绕序为顺时针，懒得改图了）

![[7640bd2fd2ee3fe360454317287a95fc_MD5.jpg]]

以 $p_{300}$ 法线 $n_{200}$ 和 $p_{030}$ 法线 $n_{020}$ 法线控制点 $n_{110}$ 为例。首先取它们的平均值，然后再将平均法线取平面 $\pi$ 反射向量为 $n_{110}$ 。其中，平面 $\pi$ 为过原点的法线平行于 $\vec{p_{300}p_{030}}$ 的平面。

![[5307719a668392a585f002bb1b31f95b_MD5.jpg]]

最终，计算得到 $n_{110}$ 表达式为：

${\bf n}_{110}={\bf n}_{200}+{\bf n}_{020}-2{\frac{({\bf p}_{030}-{\bf p}_{300})\cdot({\bf n}_{200}+{\bf n}_{020})}{({\bf p}_{030}-{\bf p}_{300})\cdot({\bf p}_{030}-{\bf p}_{300})}}({\bf p}_{030}-{\bf p}_{300}).$

在原 paper 中，使用因子 3/2 而不是 2，这在肉眼上很难区分差别，但因子 2 更能描述它反射的性质。

由于 PN 三角形的连续性仅为 $C^{0}$ ，这意味着在多个 PN 三角形连接处可能有折痕。

### Phong Tessellation

Phong Tessellation 与 PN 三角形类似，它主要用来平滑 Phong 着色结果，减少 artifaction。并且尽可能少的生成额外三角形，以减少消耗。相对于 PN 三角形，它的计算速度更快且更容易实现。但 PN 三角形带来的效果更好。

![[b27a0dffbe47447fcb52d15cc6f22337_MD5.jpg]]

注意到由顶点法线定义的顶点切线空间处于对应的局部几何。我们将重心坐标插值的顶点 $p(u,v,w)$ 分别投影到三个顶点的切线空间中得到 $p_{i}$ ，然后将 $p_{i}$ 利用重心坐标系数 $(u,v,w)$ 插值得到最终点 $p^{*}$ 。

![[fb10740fe3b073ef42e8faa5eda183a7_MD5.jpg]]

对于点 p，投影到经过三角形顶点 $v_{i}$ 的法线为 $n_{i}$ 的切线空间，其方程为 (向量均归一化)(向投影方向偏移)：

$\pi_{i}(\mathbf{p})=\mathbf{p}-\left((\mathbf{p}-\mathbf{v}_{i})^{T}\mathbf{n}_{i}\right)\mathbf{n}_{i}$

进一步可以求得曲面点：

$p^{*}(u,v)=(u,v,w)\left( \begin{matrix} \pi_{i}(\mathbf{p}(u,v))\\ \pi_{j}(\mathbf{p}(u,v))\\ \pi_{k}(\mathbf{p}(u,v)) \end{matrix} \right)$

最后，引入曲率因子 $\alpha$ ，用于在平面和曲面上进行插值。经过实验， $\alpha=0.75$ 效果最佳。

$p^{*}(u,v)=(1-\alpha)\mathbf{p}(u,v)+\alpha(u,v,w)\left( \begin{matrix} \pi_{i}(\mathbf{p}(u,v))\\ \pi_{j}(\mathbf{p}(u,v))\\ \pi_{k}(\mathbf{p}(u,v)) \end{matrix} \right)$

由于将上式展开后得到的是一个二次贝塞尔曲面，所以它不能提供拐点，但在实际应用中足以使用。



