
---
title: 02 光栅化
aliases: []
tags: []
create_time: 2023-06-19 22:26
uid: 202306192226
banner: "![[Pasted image 20230619222606.png]]"
---
# 光栅化 rasterization
光栅 raster 这个词就是德语中屏幕的意思，**光栅化的意思就是将图像绘制在屏幕上进行显示。**

> [!NOTE] 
> 要进行光栅化需要先将空间变换到屏幕空间，以下都是在屏幕空间上的操作

## 三角形-基本形状单元

三角形在图形学中有很多很好的性质：
1. 三角形是最基本的多边形，并且任何其他的多边形都可以拆分为三角形。
2. 三个点可以保证他在一个平面如果是四边形四个点就不能保证。
3. 它可以很好地用叉积判断一个点是不是在三角形内部（三角形的内外定义特别清晰）

## 采样

**采样就是给定一个连续的函数，在不同的点求它的值，也可以认为，采样是把一个连续的函数离散化的过程。**
**光栅化的过程其实就是在屏幕空间离散的像素中心点上进行采样来判断像素是否在三角形内的采样。**
比如下图中，要实现一个判断屏幕上的像素是否在三角形内的函数 inside (tri, x, y)，然后将三角形顶点构成的最大长方形区域内所有点作为函数的输入，判断这些点是否在三角形内，如果在三角形内，就将屏幕上的像素点进行点亮。这个过程就是采样。其他采样的例子包括对视频进行时间上的采样，这样就可以得到视频中的某几帧画面。
![[Pasted image 20230519213634.png]]
`inside(tri,x,y)`
1：point (x, y)在三角形内（判断方法见软光栅中的总结），如果碰巧点在三角形的边界，可以设定标准视为在内或在外
0：其余情况
遍历所有点，判断所有点是否在像素内
```cpp file:Inside函数
for(int x = 0; x < xmax; ++x)
{
    for(int y = 0; y < ymax; ++y)
    {
        image[x][y] = inside(tri, x + 0.5, y + 0.5);
    }
}
```

一张照片其实就是所有达到感光元件的光学信息，通过把它离散成图像的过程，其实这也是采样。采样不仅可以发生在不同的位置，也可以发生在不同的时间，视频就是在时间中进行采样的。
![[Pasted image 20230519213806.png|300]] ![[Pasted image 20230519213811.png|300]]
### 包围盒（bounding box）

利用包围盒 (Bounding Box)对不会包含三角形的像素进行优化
![[Pasted image 20230519213724.png]]

## Artifacts
**Artifacts 可翻译为伪影、瑕疵，** 表示了一切在图形学上的错误，异常，不希望看到的结果，看上去不对的效果以及各种瑕疵。


**a、采样产生的第一个问题就是我们刚刚提到的锯齿问题（Jaggies）**

在光栅化中表现为锯齿（Jaggies!）。我们可以看到右边的图中三角形有明显的凹凸锯齿。
![[Pasted image 20230519213743.png]]
**锯齿产生的原因**就是因为**信号的变化频率高，而相应的采样频率低**。在计算机渲染中，由于绘制的**图形在数学上是连续的**，而渲染的**像素点是离散的**，从而导致在光栅化的三角形遍历阶段，将图形打散为像素时，会不可避免的产生**锯齿（Jaggies）**。

**锯齿（Jaggies）现象也被称为走样（Aliasing）**。常见的走样有几何走样，着色走样、动画走样。**消除锯齿现象的技术就是抗锯齿，也被称为反走样（Anti- Aliasing，AA）**。
1. **几何走样**：几何覆盖函数采样不足，即俗称的边缘锯齿，一般发生在光栅化阶段。注意下图立方体边缘 ![[9a6a1f2cdd7d513757163e28ff815eea_MD5.webp]]
2. **着色走样**：渲染方程的采样不足，因为渲染方程也是连续函数，对某些部分在空间变化较快（高频部分）采样不足也会造成走样，反映在视觉上一般是图像闪烁或噪点，这类走样称之为着色走样，一般发生在各种着色阶段。注意下图中的高光，给人的感觉非常噪。![[c17a051be42e32e7fedb5beb41fa0d7b_MD5.webp]]

**走样不可避免**，只能减轻。主要通过硬件（像素点数量加倍）和软件（各种算法，如超级采样算法等）来反走样（抗锯齿）。
1. 硬件增加采样率：本质上增加了频谱之间的距离，需要更高分辨率的显示器、传感器、帧缓冲区。
2. 软件算法：先模糊后采样+各种抗锯齿算法

**b、Moiré Patterns in Imaging—（摩尔纹）**

如果我们把下面图片左图中的**奇数行和列的像素剔除**，就会出现摩尔纹效果。当我们拿手机拍显示屏的屏幕时也会出现类似的的效果，这些都是采样带来的问题。
![[Pasted image 20230519214150.png]]
**c、Wagon Wheel Illusion (车轮错觉)**

接着是车轮效应，当我们顺时针旋转纸片时，如下图所示：有些条纹显得在逆时针旋转，在生活中我们也经常能看到类似的现象，比如高速行驶的汽车，其轮子看上去在反向旋转，这是因为人眼在时间中的采样速度更不上运动的速度造成的。
![[Pasted image 20230519214201.png]]
## 反走样（抗锯齿）

### 先模糊再采样

如何进行反走样呢？可以在采样之前先做模糊再采样（模糊也可以认为是低通滤波器，把三角形边界的这种高频信号给过滤掉）。（注意：顺序不能变，先采样再模糊无法反走样）

![[5fb72113837a507894d8787b74f0a7df_MD5.webp]]

### 抗锯齿算法
[[4 高级扩展#4.4 抗锯齿]] 
## 信号基础
上面我们出现了走样（**Aliasing**）问题，我们是通过先模糊后采样的进行反走样（**Antialiasing** ）去优化它的。这里我们不仅不思考几个问题： 
1. **为什么采样频率低于信号变化频率就会产生走样？**
2. **为什么先模糊后采样就可以解决锯齿问题？**

> [!NOTE] 答案：
> 1. 进一步理解走样：
![[Pasted image 20230519215455.png]]
图中蓝色为高频信号，黑色为低频信号，当我们采用相同的采样频率（图中的圆圈为对应得采样点）采样时，得到的结果相同。即在给定的采样率下我们无法区分他们得信号频率，这就是走样。
>2. 模糊就是一个低通滤波先把高频的信息拿掉，这样做的原因就是让频谱覆盖的面小一些然后我们再以原本的间隔去采样它，这个时候我们发现它就不会产生信号重叠了。
![[Pasted image 20230519231332.png]]


要探究其根本原因，我们就需要了解一点信号原理。
### 时域/频域
- 频域是描述信号在频率方面特性时用到的一种坐标系。在电子学，控制系统工程和统计学中，**频域图显示了在一个频率范围内每个给定频带内的信号量** 。
- 时域是描述数学函数或物理信号对时间的关系的一种坐标系。

**1、时域（时间域）**（time domain）

自变量是时间, 即横轴是时间, 纵轴是信号的变化。其动态信号 $x(t)$ 是描述信号在不同时刻取值的函数。

![[0a28d03e344d360d277a69ecb1f8c3f2_MD5.webp]]

图 1 是正弦波的时域图，示出了振幅与时间的关系。在时域图中，横轴是时间，纵轴是振幅。时域图显示振幅随时间的变化，可以看出峰值振幅为 5V，可以算出频率 f=6 Hz。

**2、频域（频率域**）（frequency domain）

自变量是频率, 即横轴是频率, 纵轴是该频率信号的幅度, 也就是通常说的频谱图。

![[1a93ef106ce561eaca6d9ed548ca25a8_MD5.webp]]


图 2 是图 1 中正弦波的频域图，在频域图中，横轴是频率，纵轴是峰值振幅。**频域图仅仅示出峰值振幅与频率，而不显示振幅随时间的变化。**

从频域图可以看出，正弦波的频率为 6Hz，这个 6Hz 的正弦波的峰值振幅为 5V 。

频域图的优点是，从频域图中，可以一眼看出正弦波的频率和峰值振幅。整个正弦波在频域图上只是一个立柱立柱的位置显示了正弦波的频率，立柱的高度显示了正弦波的峰值振幅。

**3、时域和频域**

将时域频域一起放在一个三维的坐标系中，如图所示，与时域和频域的轴表示振幅：
![[84d2bd76b2350bd34e3a57efd74e79fd_MD5.webp]]

另外一张动图：
![[v2-809c336fd3cbe446a57e0cf09afa593b_b.gif]]


**4、时域变换到频域的意义**

对信号进行时域分析时，有时一些信号的时域参数相同，但并不能说明信号就完全相同。因为信号不仅随时间变化，还与频率、相位等信息有关，这就需要进一步分析信号的频率结构，并在频率域中对信号进行描述。

**动态信号从时间域变换到频率域主要通过傅立叶级数和傅立叶变换等来实现。** 很简单时域分析的函数是参数是 t，也就是 y=f (t)，频域分析时，参数是 w，也就是 y=F (w)两者之间可以互相转化。**时域函数通过傅立叶或者拉普拉斯变换就变成了频域函数。**

总的来说，在某种需求下将信号变换到另一种域中，有利于进行处理、计算和分析。

### 空间域/变换域
**空间域（spatial domain）**
空间域简称空域，又称图像空间 (image space)，一般这个概念会出现在数字图像处理中，指由图像像元组成的空间。在图像空间中以长度 (距离)为自变量直接对像元值进行处理称为空间域处理。
简单来说就是是以图像左上为原点，横为 y 竖为 x 的二维平面。  
![[Pasted image 20230519222221.png]]

实际上你可以简单理解为，像素空间，在空域的处理就是在像素级的处理，通过傅立叶变换后，得到的是图像的频谱。表示图像的能量梯度。

**变换域：**
在有些情况下，通过变换输入图像来表达处理任务，在变换域执行处理任务，方便我们的计算吗，然后再逆变换到空间域。比如使用傅里叶变换将图像转换到频率域进行滤波，再转换回空间域得到滤波后的图像。
简单来说，就是空间域经过傅里叶变换，变换为频域。我们在频域进行滤波等处理。这个频域我们也可以成为"变换域"，变换域是一个宽泛的概念，可以理解为一种中间状态。

> [!important] 理解
> 广义上，傅里叶变换将时域转换到频域。而在图像处理中，傅里叶变换可以将空间域转换为频域（变换域）。**下文讨论的傅里叶变换我们都认为是在图像处理中进行。**

### 频率和周期
频率是 f，周期是 T。  
频率越快，函数变化越快，如下图所示。  
![[Pasted image 20230519214316.png]]
### 傅里叶级数展开
**傅里叶级数展开：** 任何一个周期函数都可以写成一系列正弦和余弦函数的线性组合和一个常数项。
![[Pasted image 20230519214332.png]]

![[ee1231062ffc8dc28f21e594ae143109_MD5.webp]]

通过傅里叶级数展开，我们将周期函数分解为多个不同频率的段（即上式中的正弦和余弦函数），随着展开式越来越多，越来越接近我们想要表达的函数：
![[Pasted image 20230519214421.png]]
>从图中可以看出，在设置相同的周期性采样位置（对应采样频率）的条件下，低频信号的采样点连接起来更接近原函数（对应信号变化频率），而高频信号的采样点连接起来就和原函数相差很大。这说明，信号变化频率越高，我们就需要越高的采样频率。

### 傅里叶变换 Fourier Transform 
傅里叶变换（**Fourier Transform**）：空间域转换为频域

傅里叶变换，**傅里叶变换可以将信号分解为频率，并且能将满足一定条件的某个函数表示成三角函数（正弦和/或余弦函数）或者它们的积分的线性组合**（如下图）。
![[Pasted image 20230519214406.png]]
![[f760f7ce9e8cf66d2f51fbd596b267d3_MD5.webp]]
>左图：空间域图像/右图：频域图像（我们称之为**频谱**）


### 滤波 Filtering 
- 滤波：去除特定的频率的内容
- 高通滤波器（High-pass filter）：只保留高频信号（高频信号一般在边界）
- 低通滤波器（Low-pass filter）：只保留低频信号（画面变模糊）

我们之前光栅化抗锯齿做的先模糊就是采用了低通滤波器，使其高频信号边界去除然后图形就会变得模糊。

![[487b949ab2557b6eee493568fdda5db5_MD5.webp|850]]

**应用滤波器时，使用的是卷积运算。（可以说滤波=卷积）**

**在空间域上的卷积等同于在频域上的乘积。**

下图我们用了一个 33 的卷积核在实域做了一个卷积，因此图片变得模糊了。如果我用一个更大的卷积核（$9\times9$）做卷积图片会变得更模糊（我们这里可以用极限的思想来想一想，如果这个卷积核无限大比图片像素还大，那是不是每个点积值几乎都是一样的，保留的信息就越少了越接近低频。如果我们用一个无限小比图片像素还小的卷积核去做卷积，那是不是意味着它相当于没有做滤波，值没有改变，也就是说把所有的频率信息都保留下来了）。

![[Pasted image 20230519224739.png]]

### 从频域的角度看采样

接下来我们从频域的角度来看什么是采样？**采样其实就是在重复频谱上的内容。**

我们可以看到时域上的连续函数（a）, 它的频域对应的是（b）。
采样的过程就是让（a）乘以冲激函数（c）得到一系列离散点（e）。

从 S (f)中的频谱中可以看出，采样就是在重复原始信号的频谱。

![[Pasted image 20230519225709.png]]
  >左边时时域图像/右边是频域图像（频谱）
  
密集采样是没有问题的，但是如果采样频率过小（采样店数量很少），这就会导致频谱之间的距离减少，这可能导致了原始信号与重复的信号产生**频谱混叠**（也就是走样）如下图：。
![[Pasted image 20230519230142.png]]


**知道了这个走样的原理，我们就可以解释为什么先做一个模糊再进行采样可以进行反走样。模糊就是一个低通滤波先把高频的信息拿掉，这样做的原因就是让频谱覆盖的面小一些然后我们再以原本的间隔去采样它，这个时候我们发现它就不会产生信号重叠了。**
![[Pasted image 20230519231332.png]]




