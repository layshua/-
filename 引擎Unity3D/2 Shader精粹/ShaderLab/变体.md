# 变体基础
![[Pasted image 20230628192002.png]]

能否写一个 All in One 的 Shader？
有三种方式，根据具体需求选择：
1. 静态分支 `#if`
2. 动态分支 `if`
3. 着色器变体 `#pragma`

## 静态分支 `#if`
![[Pasted image 20230628192227.png|500]]

**原理**：着色器**编译时**选择代码分支

**选择**：编译时，能够确定 Shader 执行的条件

**用法**：
- 使用 `#define` 定义激活分支
- 使用 `#if` 、 `#elif` 、 `#else` 和 `#endif` 预处理程序指令来创建静态分支
- 让 shader 代码执行其中一个分支
- 编译器会裁剪未激活代码分支，只会将执行的部分编译

**注意**：静态分支仅在手写代码可用，不能在 Shader Graph 中创建静念分文。

## 动态分支 `if`
![[Pasted image 20230628192654.png|300]]
**原理**：着色器**运行时**选择代码分支

**选择**：运行时，是否有可能动态选择分支? 

**用法**:
- 在手写代码中，使用 if 语句来执行分支
- 在 Shader Graph 中，使用 Branch 节点

动态分支的优点（相对于着色器变体方式)：
- 可以动态选择分支
- 不会造成代码膨胀

动态分支缺点（相对于着色器变体方式)：会导致运行时性能损失

## 着色器变体 `#pragma`

![[Pasted image 20230628193118.png]]

**着色器变体原理： (静态分支的加强版)**
- 编译时，生成多个**静态分支**的着色器版本
- 运行时，根据选择的变体**动态确定**要执行的着色器版本

**变体形成的 Shader 集合:** shader variants (SL) / shader states (SG)
  >SL 意思是手写的 shaderlab ，SG 意思是 shadergraph
  
**变体关键字:** shader keyword (SL) / keyword node (SG)

**包含多个变体的 Shader 被称为 Mega / Uber Shader**
- 例如: Standard/Lit Shader
- 详见《TA 进阶之路》: Unity Shader 源码解析

**着色器变体优点**：不会导致运行时性能损失
**着色器变体缺点**：构建时间、文件大小、运行时内存使用、加载时间

![[Pasted image 20230628193737.png]]

## 变体分类
  ![[Pasted image 20230628194409.png|700]]
**使用方法：**
属性快：声明变体
代码头：定义变体
代码体：使用变体

> [!Bug] 
> 变体关键词必须大写！

**变体有两种：**
1. multi_ compile：打包会为所有关键词生成变体，因此**可以在运行的时候通过脚本切换效果**
2. shader_feature：只会为材质使用到的关键词生成变体，没有使用到的关键词被裁剪不会生成变体，减小打包体积，**但无法在运行的时候通过脚本切换效果**。

```c
//shader_feature 可以看作 multi_compile 的子集 
#pragma shader_feature FANCY_STUFF

//等价于，两个着色器变体（第一个没有定义，第二个有定义）
#pragma shader_feature _ FANCY_STUFF
```


**如何选择：**
1. 变体用于所有 Shader 还是单个材质?
    - 应该将 shader_feature 用于单个材质中设置的关键字
    - 而 multi_compile 更适合**通过代码**来全局设置的
2. 关键字运行时是否会通过 CS 脚本修改？
如果设定好的变体在运行时不会通过 CS ，则应选择 shader_feature，否则选择 multi_compile


# multi_ compile

![[Pasted image 20230628194839.png]]
## 变体激活
Unity 默认激活第一个变体，因此我们可以将默认关闭的开关放在第一个，防止意外打开开关。
```c
//如下：将产生两个变体，默认激活LIGHT_OFF变体
#pragma multi_compile LIGHT_OFF LIGHT_ON 
```

由于 Unity 变体数量的限制 (255 个，Unity已用 60+个)
因此，可以用 `_` 或 `__` 表示开关关闭 6
```c
 #pragma multi_compile _ LIGHT_ON
 //生成两个变体
 //_或__:无关键字，即表示不用 LIGHT_ON，又不产生变体LIGHT_ON
 //第二个就是变体LIGHT_ON
```

对于单一条件的判定，没必要写两个变体浪费变体数量。
直接使用以下方式即可：
```c
#if defined(LIGHT_ON)
...
#else 
...
```


## 变体组合

![[Pasted image 20230628195933.png]]
 ![[Pasted image 20230628195959.png]]

## 变体开关
![[Pasted image 20230628200255.png]]


## 快捷方式
- ? URP 管线有快捷方式吗？

有些情况需要定义很多变体，代码很长，Unity 提供了一些快捷方式
## 变体(Variants)

URP支持着色器的变体，可以使用#pragma multi_compile宏实现编译不同需求下的着色器，常见的内置关键字有：

- _MAIN_LIGHT_SHADOWS
- _MAIN_LIGHT_SHADOWS_CASCADE
- _ADDITIONAL_LIGHTS_VERTEX
- _ADDITIONAL_LIGHTS
- _ADDITIONAL_LIGHT_SHADOWS
- _SHADOWS_SOFT
- _MIXED_LIGHTING_SUBTRACTIVE


大多数内置快捷方式会产生许多着色器变体。如果知道项目不需要这些变体，可以使用 `#pragma skip_variants` 来跳过对其中一些变体的编译。例如：

```c
# pragma multi_compile_fwdadd
# pragma skip_variants POINT POINT_COOKIE
```

该指令会跳过包含 `POINT` 或 `POINT_COOKIE` 的所有变体。

# 实战
[(34条消息) Unity Shader - 使用multi_compile对Shader渲染质量控制_keywordenum_Jave.Lin的博客-CSDN博客](https://blog.csdn.net/linjf520/article/details/93721871?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522168796772416800222884417%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&request_id=168796772416800222884417&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-10-93721871-null-null.268^v1^koosearch&utm_term=%E5%8F%98%E4%BD%93&spm=1018.2226.3001.4450)


03-1 代码控制待续...
枚举值控制（属性面板——Shader Property）
代码控制

