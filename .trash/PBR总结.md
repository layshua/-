
## 渲染方程与双向反射分布函数（BRDF）
#### 渲染方程
如何实现能量守恒➡渲染方程

> [!NOTE]
> 我们定义：
>- 入射光方向为点到光源的方向
> - 出射光方向为点到摄像机的方向
> 

![[Pasted image 20230703155835.png]]

某一点 p 的渲染方程如下：

PBR 的反射方程可抽象成下面的形式：

$$L_o(p,\omega_o) = \int\limits_{\Omega} f_r(p,\omega_i,\omega_o) L_i(p,\omega_i) n \cdot \omega_i d\omega_i$$

![[Pasted image 20230703155823.png]]

![[Pasted image 20230703155826.png]]

实时渲染中，我们常用的是渲染方程的简化的版本：
![[Pasted image 20230703155848.png]]



#### BRDF
光强度信息我们从基于物理的光照中可以拿到
其他参数比较好计算，**我们还要知道反射比例是多少，这就需要使用 BRDF**


BRDF 描述了入射光反射后在各个方向如何分布。
![[Pasted image 20230703155918.png]]

Diffuse BRDF 可以分为传统型和基于物理型两大类。其中，传统型主要是众所周知的 Lambert。而基于物理型，从 1994 年的 Oren Nayar 开始，到现在较新的有 GDC 2017 上提出的适用于 GGX+Smith 的基于物理的漫反射模型（PBR diffuse for GGX+Smith），在 SIGGRAPH2018 上提出的，来自《使命召唤：二战》的多散射漫反射 BRDF（MultiScattrering Diffuse BRDF）。

在实时渲染中，会有两种光对物体表面造成影响，分别是直接光和间接光，分为四个部分。
- **直接光的漫反射**
- **直接光的高光反射**
- 间接光的漫反射
- 间接光的高光反射

**Cook-Torrance BRDF：**

![[Pasted image 20230703160015.png]]

将 Cook-Torrance 带入渲染方程可得：

![[Pasted image 20230703160024.png]]
![[Pasted image 20230703160030.png]] 是漫反射项，c 为反射率 Albedo
![[Pasted image 20230703160036.png]] 是高光反射项
DFG 分别是三个函数，n 表示粗糙度
D：法线分布函数
F：菲涅尔项
G：几何遮蔽函数

实时渲染中，基于物理的光照模型，漫反射部分依然采用 lambert 算法，已经可以取得不错的效果。
这里的 ks 表示镜面反射所占百分比，kd=1-ks 表示漫反射所占百分比
更多的细节都在高光反射部分。

**Cook-Torrance BRDF —— D 法线分布函数**

主流的的法线分布函数是 GGX（Trowbridge-Reitz），因为具有更好的高光长尾：
![[Pasted image 20230703160117.png]]
![[Pasted image 20230703160122.png]]
>D 法线分布函数：描述的是微表面的法线方向与半角向量对齐的概率，如果对齐那么认为该反射光可以被看到，否则没有。

α：粗糙度
m：半角向量
n：法线向量


**Cook-Torrance BRDF ——F 菲涅尔项：**

菲涅尔反射：视线垂直于表面时，反射较弱，而当视线非垂直表面时，夹角越小，反射越明显。反映了反射/折射与视点角度之间的关系。如果你站在湖边，低头看脚下的水，你会发现水是透明的，反射不是特别强烈；如果你看远处的湖面，你会发现水并不是透明的，但反射非常强烈。这就是“菲涅尔效应”。
![[Pasted image 20230703160302.png]]
![[Pasted image 20230703160305.png]]
菲涅尔（Fresnel）方程很复杂，计算量很大，实时渲染中广泛采用 Schlick 的 Fresnel 近似，因为计算成本低廉，而且精度足够：
![[Pasted image 20230703160214.png]]
>R0：平面基础反射率。大多数常见电介质的 F0 范围为 0.02-0.05（线性值），对于导体，R0 范围为 0.5-1.0。


**Cook-Torrance BRDF ——G 几何遮蔽函数**
G：我们是使用微平面理论，也就是说每个面单独计算互不干扰。但现实世界中，物体的表面的凹凸存在相互遮蔽的情况。主要受粗糙度影响
因此，几何函数从统计学上近似的求得了微平面间相互遮蔽的比率这种相互遮蔽会损耗光线的能量。(除了被吸收，还有被自身遮蔽带来的能量损耗）

![[Pasted image 20230703160450.png]]
计算 G 项的方案有很多，虚幻引擎使用的是 Schlick-GGX，
基于 Schlick 近似，将 k 映射为 k=a/2，去匹配 GGX Smith 方程
![[Pasted image 20230703160317.png]]
![[Pasted image 20230703160320.png]]

![[Pasted image 20230703160437.png]]
>可以得到如下所示不同粗糙度的视觉效果 0: 没有微平面阴影    1：微平面彻底被遮蔽

