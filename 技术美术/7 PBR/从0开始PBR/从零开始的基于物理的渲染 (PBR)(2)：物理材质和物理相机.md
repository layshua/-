目录：

[TheTus：从零开始的基于物理的渲染 (PBR)(0)：开篇](https://zhuanlan.zhihu.com/p/633603239)

在本章中，我们会讨论剩下的两个物理模型，即物理材质和物理相机。本章大部分内容还是偏物理，主要理解 **微观几何学** 和 **光线与表面的作用方式**。

## 光的作用物质

[TheTus：从零开始的基于物理的渲染 (1): 物理光照](https://zhuanlan.zhihu.com/p/633519853)

在光的物理学中，我们介绍了光被建模为一种 **电磁横波 (transverse wave)**，光波的磁场和电场耦合并且垂直于其传播方向振荡。两者长度之比固定，该比率等于 **相速度 (phase velocity)**。

光源发射出光波，打到物质上进行相互作用，这种相互作用被称为 **散射 (scattering)**。广义上，弹性散射可以表现为 **反射 (reflection)** 和 **散射 (refraction)**。在渲染中，我们更多关注许多分子组合的集合体，即粒子 (particles)，介质(media) 和表面(surfaces)。

接下来，我们会简单对这三种物质进行介绍。

### 粒子

**粒子 (particles)** 是指分子在空间中的离散点，其相对位置是完全随机和不相关的，它们不会相互影响。然而，当分子聚集成簇时，会显著增加散射光的强度。云和雾的散射光强烈的原因之一是冷凝，空气中的水分子聚集成越来越大的簇，从而大大增加了光的散射效应，即使水分子的总体密度没有发生变化。在讨论光的散射时，粒子一词既可以指代孤立的分子，也可以指多个分子聚集形成的团簇。

### 介质

**介质 (media)** 可以分为均匀介质和非均匀介质。

**均匀介质 (homogeneous medium)** 是指充满均匀间隔的相同分子的体积，分子间距不必完全规则。如果液体和非晶态固体的组成是纯净 (pure)(所有分子都相同) 且没有缝隙或气泡，则它们可以在光学上是均匀的。在均匀介质中，散射的波会排列成一排，最终结果与原始波相同，值时其相速度和振幅可能不同。最终的波不表现任何散射现象。

光在传播到两种不同介质交界处时，原波和新波的相速度比定义了介质的一个光学特性，称为 **折射率 (index of refraction, IOR)**，用字母 n 表示。有些介质可以吸收光能转换为其他能量，导致波振幅随传播距离呈指数级衰减。这个衰减系数由κ表示。n 和κ通常都随波长而变化，两者组成复数 n+iκ，称为 **复折射率 (complex index of refraction)**。

其中，

*   复折射率的实部度量了介质如何影响光速，即相对于光在真空中传播速度减慢的度量。
*   复折射率的虚部确定了光在传播时是否被吸收，转换成其他形式的能量，通常是热能。非吸收性介质虚部为 0。

引入折射率，可以让我们从更高层次的介质观察光与物质的细节交互，而不是光与分子层面。光吸收对视觉有直接影响，因为它减少了光的强度，并且 (如果按波长变化) 也可能改变光的颜色。如下图，这是四个具有不同吸收属性的液体。从左到右：清水，石榴糖浆，茶和咖啡。

![[522cc5e4fa25b33b900e5bd507ec7b2d_MD5.jpg]]

也就是说，光在介质中发生折射的条件是 **在小于单一波长距离内发生折射率的突然变化**。

![[dbb92bde4a241486ff29a44b347a00ff_MD5.jpg]]

**非均匀介质 (nonhomogeneous medium)** 通常被建模为嵌入散射粒子的均匀介质。分子分布中任何局部变化 (密度等) 都会打破破坏性干涉模式(光波相互叠加时产生的干涉效应，其中两个或多个波的振幅相互抵消)，使得散射光波能够传播。非均匀介质可以用来建模气体、浑浊的水或云雾。

散射和吸收都与 **观察尺度有关 (scale-dependent)** 。 在小场景中不产生任何明显散射的介质在较大尺度上可能具有非常明显的散射。 例如，当观察房间中的一杯水时，在空气中的光的散射和在光在水中的吸收都是不可见的。 但是，在宽阔的环境中，两种效果都很重要。如下图，左图显示，在多米的距离内，水会强烈吸收光线，特别是红光。右图显示即使在没有严重污染或雾霾的情况下，空气在数英里范围内也存在明显的光散射。

![[3a474111d0b22be36fbc6570ec931f2e_MD5.jpg]]

### 表面

在光学中，**表面 (surfaces)** 是指将不同折射率的体积 (介质) 分开的二维界面。

![[20d57f29693eab96153be45a183fc0eb_MD5.jpg]]

**斯涅尔公式 (Snell's law)** 描述了入射光线、折射光线和表面法线之间的关系，适用于全局折射。

 $sin(\theta_{t})=\frac{n_{1}}{n_{2}}sin(\theta_{i})$

其中， $n_{1}$ 为入射介质折射率， $n_{2}$ 为出射介质折射率， $\theta_{i}$ 为入射光与表面法线夹角， $\theta_{t}$ 为出射光与表面法线夹角。

斯涅尔公式主要观察的是，当光从光密介质 (折射率较高) 射向光疏介质 (折射率较低) 时，光线会朝表面法线弯曲，即折射角小于入射角。相反地，当光从光疏介质射向光密介质时，光线会远离法线弯曲，即折射角大于入射角。

折射通常发生在透明材料，如玻璃和晶体，同时也会在不透明物体的表面发生。当不透明物体表面发生折射时，光线会在物体内部发生散射和吸收。

其中，

*   散射决定介质的 **浑浊程度**。大多数情况下，固体和液体介质中的可莉都比光的波长更大，并且倾向于均匀地散射所有可见波长的光。高散射会产生不透明的外观。
*   吸收决定材质的 **表面颜色**。几乎任何材质的表面颜色通常都是由其吸收的波长相关性引起的。

当然，除了折射的光线，材质的外观还与反射有关。

![[865fd7d70e03cf3821ea246d3dc04de3_MD5.jpg]]

这种光线在表面折射，进入内部发生散射和吸收的现象又叫做 **次表面散射 (subsurface scattering, SSS)**。它多出现于渲染半透明材质，例如皮肤、蜡烛、水果等。如下图所示，光打到表面上，首先被镜面反射出去 (黄线)，然后折射进入介质。折射进介质的光线又发生散射和吸收，最终一些折射光被散射回表面 (蓝线)。这就是次表面散射。

![[e6637c2a73da09daf9d35398c41212f1_MD5.jpg]]

**漫反射 (diffuse)** 的本质也是次表面反射，区别在于 **观察尺度** 的不同。散射距离相较于像素来说微不足道，次表面散射便可以近似为漫反射。如下图左，像素 (黄圈) 大于光线离开表面之前所经过的距离，在这种情况下，可以假设出射光从宏观交点直接射出，从而建模成右图的漫反射模型，可以使用局部着色模型处理。

![[732ec37c248675c1524c2f34ca1f1aff_MD5.jpg]]

折射率缓慢的逐渐变化不会导致光线的分离，而是导致其传播路径的弯曲。一个例子是当空气密度因温度而变化时，通常可以看见热变形 (heat distortion) 现象。

![[77051434c4359ddf418caef9770689b2_MD5.jpg]]

此外，即使一个物体有明确的边界，如果它完全浸没在具有相同折射率的物质中，它也不会有可见的表面。只有在存在折射率变化的情况下，才会发生反射和折射现象。这刚好应征了表面的定义：将不同 **折射率** 分开的体积。如下图，这些珠子的折射率与水相同。在水面上，由于折射率与空气不同，因此有一个可见表面。但在水下，珠子表面两侧折射率相同，因此表面是看不见的。只有通过它们吸收光线而呈现出颜色时才能看到这些珠子。

![[af5a459e4bde948f94096cae0ac0d594_MD5.jpg]]

## 几何光学与微观几何学

### 几何光学

严格来说，完全平坦的平面表面是不可能存在的，每个表面都有某种程度上的不规则形。然而，比波长小得多的表面不规则性对光线没有影响，而比波长大得多的表面不规则会有效地倾斜表面而不影响其局部平整度。只有大小在 1-100 个波长范围内的不规则形才会导致该表面与平坦平面有所区别。

在渲染中，通常使用 **几何光学 (geometrical optics)** 忽略光的干涉和衍射等波动效应。几何光学作出如下假设：1. 所有表面不规则都比光波小或大得多； 2. 将光线建模为射线而非波浪形式进行处理；3. 在光线与曲面相交的那一点上，该曲面被局部地视为一个平面 4. 光线可逆

### 微观几何学

比波长大得多的表面不规则性会改变表面的局部方向，当这些不规则性小于像素大小时，我们称为 **微观几何 (microgeometry)**。它的核心是认为每个微表面都有自己的法向量，它们的分布对整体的法向量有贡献，最终的表面外观是许多 **具有不同表面取向的点的聚合结果** 。如下图。

![[5da37064e00381726861dc4a6a3d3b45_MD5.jpg]]

对于大多数表面而言，微观几何表面法线分布是连续且各项同性的，并且在宏观表面法线较强处呈现较强峰值。这种分布 “紧密度” 由表面 **粗糙度 (roughness)** 决定。表面越粗糙，则微观几何法线就会更加 “扩散”。也就是说，在微观尺度上，表面越粗糙，反射越模糊，因为表面取向与整个宏观表面取向的偏离更强。也就是说，微表面法线影响宏观表面的反射率，如下图所示。

![[a9740fc78226b4808591646853e033fa_MD5.jpg]]

在渲染中，我们不是显式地对微观几何进行建模，而是将其统计处理，并认为表面有随机的 **微观法线分布**。因此，我们将表面建模为在连续方向上反射 (和折射) 的光线。也就是说，从宏观上看，表面可以看作是在多个方向反射和折射光线。

![[7a26f8aaad1c78d84d86125d9ea6ff77_MD5.jpg]]

### Shadowing&Masking

由于微观表面的高度分布不同，光线可能会在表面内部进行弹射，从而产生自遮挡的阴影。如下图所示，左侧这种从光源射向微表面的遮挡现象叫做 **Shadowing**，中间这种从微表面射向 eye 的遮挡现象叫做 **Masking**。右侧显示了光线在微表面间的互反射。

![[8c71e0b51185e84c583ab7a1df499b63_MD5.jpg]]

被微表面遮挡地光线并没有消失，而是被反射回来，并可能落在其他微观结构上。光线可能经过微表面多次反射才进入眼睛，如上图右侧所示。由于菲涅尔反射效应，每次散射都会损失一定的光能。

如果微观几何高度与表面法线之间存在相关性，那么 Shadowing 和 Masking 可以有效地改变法线分布。如下图所示，微观表面凹处粗糙，凸处平滑。顶部图像中的光线以接近垂直的角度照射表面，能够探测到表面的凹坑，导致光线在不同方向上散射，使表面看起来比较粗糙。而底部图像中的光线以非常平行的角度照射表面，凹坑被 Shadowing 所遮挡，光线很少击中凹坑，大部分光线从表面的光滑部分反射出去，使表面看起来比较光滑。

![[2bede305554e2d462adbeaa8be6c218f_MD5.jpg]]

当入射角逐渐接近法线时，自遮挡性质大小会减小。当完全接近平行 (grazing angle) 时，这种性质缩短到比光波还要小，从而从宏观层面来看它们 “消失” 了。

## 光线与表面的作用方式

光线与表面的作用方式在上文中已经分散地都涉及到了，这里简单地总结一下。

当光与表面相互作用时，可能发生以下三种情况：

*   **吸收 (absorption)**：光可以消失，其辐射能被转化为其他形式，例如化学键的能量或热量。
*   **弹性散射 (elastic scattering)**：光线可以改变方向，但波长不变。
*   **非弹性散射 (inelastic scattering)**：光线可以经历波长的改变，通常是到更长的波长，并且通常在不同的方向上。

其中，弹性散射包含反射和折射。

![[5aab1cb81f640376b703aea25d4f2675_MD5.jpg]]

具体来说，光线打到物体表面，首先会在交界处直接反射出来，这称为镜面反射。折射进入物体内部的光线会被吸收和散射。

![[152fe7940fb27d3a6f21d186fa361048_MD5.jpg]]

*   **反射 (reflection)**：**光线在两种介质交界处的直接反射即镜面反射 (specular)**。金属的镜面反射颜色为三通道的彩色，而非金属的镜面反射颜色为单通道的单色。
*   **折射 (refraction)**：从表面折射入介质的光，会发生吸收和散射，而介质的整体外观由其散射和吸收特性的组合决定，其中：
*   **散射 (scattering)**：折射率的快速变化引起散射，光的方向会改变 (分裂成多个方向)，但是光的总量或光谱分布不会改变。散射最终被视作的类型与观察尺度有关：

*   **次表面散射 (subsurface scattering)**：观察像素小于散射距离，散射被视作次表面散射。
*   **漫反射 (diffuse)**：观察像素大于散射距离，散射被视作漫反射。
*   **透射 (transmission)**。入射光经过折射穿过物体后的出射现象。透射为次表面散射的特例。

*   **吸收 (Absorption)**：具有复折射率的物质区域会引起吸收，具体原理是光波频率与该材质原子中的电子振动的频率相匹配。复折射率的虚部确定了光在传播时是否被吸收 (转换成其他形式的能量)。发生吸收的介质的光量会随传播的距离而减小 (如果吸收优先发生于某些波长，则可能也会改变光的颜色)，而光的方向不会因为吸收而改变。任何颜色色调通常都是由吸收的波长相关性引起的。

## 物理相机

[TheTus：从零开始的基于物理的渲染 (1): 物理光照](https://zhuanlan.zhihu.com/p/633519853)

在辐射度量学中，我们提到，渲染的目的就是计算着色点到相机位置的 radiance。这模拟了成像系统的简化模型。成像系统由许多离散的小型传感器组成，如眼睛中的视杆和视锥、数码相机中的光电二极管或胶片中的染料颗粒。这些传感器检测表面上的辐照度值，并产生颜色信号。

为了生成图像，成像系统采用光密封的外壳，带有一个小孔 (光圈)，限制光线进入并照射传感器的方向。镜头放置在光圈上，将光线聚焦到传感器上的小区域和少量的入射方向。

辐照度传感器本身无法生成图像，因为它们平均了来自所有入射方向的光线。相反，辐射度传感器测量平均辐射度，用于量化单个光线的亮度和颜色。

在渲染中，我们使用 **针孔相机 (pinhole camera)** 模拟成像系统。如下图，针孔相机由一个光密盒子和一个小孔组成。当这个小孔被揭开时，光线进入此小孔并落在固定在盒子另一端的一张照相纸上。尽管它很简单，但这种类型的相机仍然经常用于艺术目的。需要非常长时间曝光才能使足够多的光线进入胶片以形成图像。

![[cad023bc7b5f528c1ba5c204571f97e6_MD5.jpg]]

另一种思考针孔相机的方法是将成像平面放置在针孔前方的近平面，此时针孔相机被称作 **眼睛 (eye)**。

![[1315cc46d5cf5f802867174fcb7ad4d4_MD5.jpg]]

相机的一个重要任务就是从相机发出光线，打到场景的物体上，计算得到射线与成像平面的 radaince 并进行着色，如下图所示。

![[940406e7505fbc2946810fd67c175e7b_MD5.gif]]

更多关于物理相机的内容，可以参考 [games101 第 19 讲](https://www.bilibili.com/video/BV1X7411F744)

## 参考

《Real-time Rendering 4th》

[基于物理渲染 (PBR) 白皮书](https://github.com/QianMo/PBR-White-Paper/tree/master)

[The Physics of Scattering](https://www.oceanopticsbook.info/view/scattering/physics-scattering)

[GDC2016: An End-to-End Approach to Physically Based Rendering](https://ubm-twvideo01.s3.amazonaws.com/o1/vault/gdc2016/Presentations/Bugden_Sam_AnEndTo.pdf)

[Physically Based Rendering 3ed: Photorealistic Rendering and the Ray-Tracing Algorithm](https://www.pbr-book.org/3ed-2018/Introduction/Photorealistic_Rendering_and_the_Ray-Tracing_Algorithm)

[games101 Lecture19: Camera](https://www.bilibili.com/video/BV1X7411F744)

[games202 Lecture10: Geometry](https://www.bilibili.com/video/BV1X7411F744?p=10&vd_source=77dffcb51185106a7d6d4b263fef7afa)