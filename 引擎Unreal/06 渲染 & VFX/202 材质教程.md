# D BenCloward
## 04 扭曲着色器
这一节做扭曲和调节的shader  
首先最基本的用一张uv的checkimg图贴到立方体上
![[Pasted image 20221219161254.png]]
使用add节点和常量改变UV试试
![[Pasted image 20221219161311.png]]
使用time节点改变UV，让它动起来试试，因为time是单值，所以是对角线移动
![[Pasted image 20221219161318.png]]
同样也可以用time和常量的乘法来控制
![[Pasted image 20221219161323.png]]
如果想要偏移每个像素的UV怎么办呢？这就需要引入一些noise或者一张纹理  
噪声纹理里每个通道都是不同的灰度值，用它们来偏移UV坐标
![[Pasted image 20221219161330.png]]
稍微控制一下偏移的强度，就可以看到扭曲的效果
![[Pasted image 20221219161335.png]]
对噪声纹理的UV也做一个移动的偏移，结合到纹理图上，可以看到它动了起来
![[Pasted image 20221219161340.png]]
但是这只是一味重复，很容易被看出来，做一些改变，可以得到不容易看出来重复的效果
![[Pasted image 20221219161346.png]]
## 05 帧动画Fiipbook
算法核心：帧数/行列数得行号，余数为列数

Flipbook的动画效果在视觉上很常用，因为游戏通常为了保证帧数，很多时候不能做复杂的事情 。所以美术设计者，一般会把动画效果渲染成单独的帧，然后将它们渲染到纹理上再去应用。
如图，这是一张UE4初学者内容中自带的爆炸图片，框架按照6 * 6来排列 ，为了展示这个效果，我们要一次显示一帧 。上一节我们扭曲了UV，这一节，我们要让UV从一帧跳到下一帧，开始播放它。
![[Pasted image 20221213232453.png]]
自己动手实现：
首先，我们需要缩放我们的UV，让它只能显示一帧的内容 ，用到frac节点，获取小数部分。
![[Pasted image 20221219161748.png]]
而后要让它跳到下一帧，可以这么做
![[Pasted image 20221219161755.png]]
## 06 环境材质混合
在做这节效果之前，我们假想一个场景，有一位场景同学来诉苦，做岩石太累了。有那么多场景，沙漠/雪/潮湿/丛林，这里面都用到石头，它们上面有雪，有沙子，有苔藓。要做这么多石头太累了，能不能**用一个shader，轻松的只用一组岩石，然后用雪/苔藓/沙子等等任何东西去涂它**呢？
这是可以做到的，我们只用一组岩石资产，然后更改它是哪种材料。

首先我们有最基础的东西

![[Pasted image 20221219162434.png]]
如果要把它变成一个长满苔藓的岩石，要该如何把苔藓颜色和正常的石头颜色混合在一起呢？  
总之先把苔藓的diffuse和normal拿到
![[Pasted image 20221219162450.png]]
我们要做的是把两者融合到一起，融合的方式是lerp
![[Pasted image 20221219162455.png]]
这个节点代表，有些纹理放到A，有些纹理放到B，然后通过alpha，把两者进行混合  
只是用alpha=0.5，把diffuse简单lerp得到一个效果
![[Pasted image 20221219162510.png]]
然而这种效果实际上是不存在的，苔藓不是透明贴上去的，所以这不是我们希望的效果。
所以我们接着要做其他事，不过学会lerp是第一步，我们可以把normal也lerp在一起。

我们想做的事情，是创建一个蒙版，只是把苔藓固定在顶部
为了这么做，我们需要找到顶部，为此需要法线，选择vertexNormal节点，用mask取出B通道（因为虚幻是Z方向作为向上的）
得到一些奇怪的效果
![[Pasted image 20221220123644.png]]
上部分有苔藓了，但是下部分变蓝了，为什么呢？  
因为我们的取出的这个通道是-1到1，在lerp中，如果-1就变成了岩石减去苔藓了  
为了避免这种错误，使用clamp节点
![[Pasted image 20221220123651.png]]
我们想做的事情是增加mask的对比度，而不是看着似乎是透明过渡的苔藓  
想在苔藓交接的地方多一点硬线  
为了增加一些对比，可以在mask之后使用power  
单独看看这个mask，我们power拉的越多，越靠上，边缘越锐利
![[Pasted image 20221220123659.png]]
我们可以加一个数上去，交界是有了，但是这样的交界不太行，他是基于物体的法线的  
所以我们最好用贴图自己的法线，而不是顶点法线
![[Pasted image 20221220123707.png]]
但是法线贴图的图，不可以直接拿来用，这个涉及到切线空间和世界空间的差异  
（附上以前的[法线贴图笔记](https://blog.csdn.net/weixin_43803133/article/details/109392166)，内有切线空间推导说明）  
所以我们为了自己使用法线图要加一个节点，把它从切线空间变换到世界空间  
，也就是TransformVector节点
![[Pasted image 20221220123717.png]]
达到了我们的效果  
这不是一项新奇的技术，早在2011年是上古卷轴5：天际中就被使用了，但是当我们也会经常使用  
稍微整理加个注释
![[Pasted image 20221220123725.png]]

## 07 性能优化
衡量性能的方法：
- 查看shader复杂度》颜色
- 查看shader统计数据》指令数量
- 最准确的方法是，把要用的shader，放到要用的模型上，放到要运行的场景中  
然后运行该场景在预期目标平台上去评估。

优化性能的方法：
- 优化的第一个方法，很简单，就是删除所有用不到的东西，很多计算了但是排不上用处的逻辑依然会损耗性能
- 优化的第二个方法，重构数学逻辑，去使用不同的方法获得相同的结果
- 优化的第三个方法，节点能合并就合并
- 优化的第四个方法，纹理通道打包
## 10 布料
两个Fresnel相减
![[Pasted image 20221220131355.png|300]]
![[Pasted image 20221220131328.png]]
## 11 体积冰
我们最开始只是连一个UE4自带的T_Perlin的噪声图
![[Pasted image 20221220131524.png]]
我们想要的是，让这些噪声似乎在表面下移动，而不是卡在表面  
现在它是直接用了UV坐标固定在表面，我们希望它随着眼睛和表面的关系移动

我们现在是这样，只有这俩向量和表面，表面并不会动
![[Pasted image 20221220131533.png]]
然而我们希望，表面下面的纹理能够随着视线移动  
我们需要去了解如何把表面的纹理推进去并且移动，达到如下的效果
![[Pasted image 20221220131540.png]]
有一个向量可以完成这个事情，也就是反射向量
![[Pasted image 20221220131557.png]]
但它在表面上方，不在下方，所以还要翻转一下
![[Pasted image 20221220131604.png]]
我们可以把这个东西加到UV坐标里去，让UV随着相机矢量的移动在表面下滑动

做法是，把视线转到切线空间，在切线空间内求出反射向量，得到uv，这时候纹理会移动
![[Pasted image 20221220131702.png]]
![[20210120155841635.gif]]
得到一个效果，看起来很像是用一个立方体的放大镜去看这个噪声纹理
这虽然类似是我们想要的效果，但是太强了
我们想要的是纹理在表面之下

但这么处理的效果，显得好像纹理在表面之后，而且偏移也很明显

所以我们需要一些控件去调整这种效果

获取反射向量以后，取得它的Z，进行绝对值，然后一个除法控制偏移量的大小
![[Pasted image 20221220131813.png]]
![[20210120161541926.gif]]
接着我们还要做其他事，因为现在这个表面非常光滑，但是冰块是不太光滑的

我们选择一个法线贴图的法线（T_Metal_Gold_N这个贴图）去替代（0,0,1）  
可以看到法线图大部分很光滑，只是有一些小斑点
![[Pasted image 20221220131923.png|300]]
![[20210120162109523.gif]]
效果一下就出来了

我们还可以接着做，因为目前是噪声纹理是完全均匀地进行整体偏移

所以，我们可以选择其他纹理（这里还是选择了原来的噪声纹理）来指定我们的偏移量，而不是100这个值
![[Pasted image 20221220132235.png]]
目前所做的是这个效果的核心，让效果拥有体积，而不只是附在上面。  
这个效果和之前做的高度图或者视差映射相比，它是进入表面内部，而不是从表面出来
## 12 树叶着色器
比如这个纹理上面有几十张叶子
![[Pasted image 20221220132723.png|300]]
如果是多边形模型作为动画处理，那么会作为一个整体去移动  
也就是这个纹理的叶子会一起移动

为了解决这个问题，这节讨论的技术，可以对这个纹理上的单个叶子进行动画处理，去近似现实树叶的复杂度  
最初我们只是把这个纹理导入进来，做一个alpha遮罩
![[Pasted image 20221220132835.png]]
用sin来控制树叶抖动，但是这样还是整体移动
![[Pasted image 20221220133043.png]]
接下来我们要做的是，从整个图片上分离出单个叶子的方法，以至于我们能让单个叶子自己进行不同程度的摆动

为了实现这个想法，我们首先要做一个遮罩纹理，在ps中制作即可，红绿蓝通道分别设置几片叶子
![[Pasted image 20221220133129.png]]
![[Pasted image 20221220133838.png]]
## 13 雨水潮湿
在这一节我们就只要想着去还原一下潮湿的结果就可以  
我们以UE4初学者内容自带的这个砖块的着色器为基础，添加几个功能，把它变得潮湿
![[Pasted image 20221220134039.png]]
### 潮湿物体颜色
是什么让表面变湿了呢？有很多东西影响  
**物体表面吸水会让颜色变深**，所以这里需要表面的基础颜色  
**“潮湿的基础颜色”会变得暗淡和饱和**，所以我们可以从这个地方下手  
我们使用Desaturation这个去饱和度节点，只是去简单连一下基础颜色
![[Pasted image 20221220134159.png]]
可以看到颜色被弄成灰度了，然而我们想要其饱和，这里有一个小技巧  
**如果我们传递一个负值给这个节点，那么它就变成了一个饱和节点**
![[Pasted image 20221220134212.png]]
我们接着又给它一个Saturate节点。  
感觉很迷惑？确实，但是这个节点只是拿来clamp出0到1的值，并不会控制颜色
![[Pasted image 20221220134247.png]]
![[Pasted image 20221220134249.png]]
在这之后用乘法让颜色变暗  
于是我们现在得到了一个，**更暗更饱和**的结果
![[Pasted image 20221220134358.png]]

### 潮湿物体表面特点
潮湿物体还有一个特点
当水聚集在材质的表面的时候，材质的表面实际变得略微细腻，并且略微减少specular

我们接下来模拟这种效果

用一个二维向量来提供那些聚集在表面的水的粗糙度0.07（因为积水很光滑）和高光度0.3

大部分材质有0.5的高光度值，但水会比它们小一点。尽管很多人认为，水会更加反光。

但其实反光是弱一点的，只是在掠射角的时候水反射很强，直视看的时候，水的反射性蛮小的

用一个常量到最后面，分别去插值 默认的基础颜色与潮湿颜色，默认的粗糙度高光度和潮湿的粗糙度高光度

潮湿常量为0.1
![[Pasted image 20221220135155.png]]
### 打包材质函数
为了方便复用，接下来我们会把这堆节点做成Material Function。  
把这堆节点变成函数，这样以后就只用添加一个节点就行了
![[Pasted image 20221220135244.png]]
![[Pasted image 20221220135249.png]]
## 14 表面水珠
RG通道：用它来创建雨滴的法线
![[Pasted image 20221220135853.png|300]]
B通道：时间偏移遮罩，控制雨滴出现时间
![[Pasted image 20221219145226.png|300]]
Alpha通道：黑色静态雨滴，白色动态雨滴
![[Pasted image 20221219145345.png|300]]
### 水珠动画-动静结合
![[Pasted image 20221220144146.png]]![[20210121105353817.gif]]
提取出静态雨滴，也就是这个alpha通道的黑色部分，将其换为白色
![[Pasted image 20221219145345.png|300]]
很好理解，黑色部分乘2减1变为-1，再乘-1，就变为1（白色）
![[Pasted image 20221220144539.png]]
成功：
![[Pasted image 20221220144829.png]]
### 向上才会淋雨
我们再创建一个和对象朝向有关的蒙版，我们现在看到，这个球上都是水滴  
但是这样是没有意义的，因为雨滴来自天空，整个球都有水是不科学的  
所以我们使用顶点法线向量，只要朝上的向量
![[Pasted image 20221220144914.png]]
### 光滑的水珠
加平滑来让物体看着湿润  
所以我们来控制一下粗糙度![[Pasted image 20221220145220.png]]
## 15 流淌雨滴
用如下过程在PS画了纹理
黑底
![[Pasted image 20221220145924.png]]
画了几根线
![[Pasted image 20221220145938.png]]
加个模糊，调整一下效果，然后把这个处理完的遮罩（mask），放到纹理的B通道（下面第二个图）  
把这个图当做高度图，去转成法线图，完成后提取法线的RG通道到纹理的RG通道（使用PS的插件转）
![[Pasted image 20221220150016.png]]
![[Pasted image 20221220150018.png]]
![[Pasted image 20221220150022.png]]
给每一条道道画了个mask，存到纹理的的alpha通道，不同的灰色mask充当不同的时间偏移
![[Pasted image 20221220150034.png]]
纹理导入，长这样（纹理压缩设置选“用户界面2D”，采样纹理的地方选“线性颜色”）
