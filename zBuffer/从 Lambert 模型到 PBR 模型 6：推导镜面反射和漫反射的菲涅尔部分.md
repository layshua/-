[从 Lambert 模型到 PBR 模型 1：基础渲染模型 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/163023172)

[从 Lambert 模型到 PBR 模型 2：Phong、BinnPhong 与 NDF - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/163672179)

[从 Lambert 模型到 PBR 模型 3：渲染方程与反射率方程 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/165425545)

[从 Lambert 模型到 PBR 模型 4：BRDF 的漫反射 Fr - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/166154814)

[从 Lambert 模型到 PBR 模型 5：推导镜面反射 Fr 中的分母 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/187569004)

之前我们推导了漫反射跟镜面反射里，光线积分的部分。

镜面反射里的微表面的法线建模，我们后续再说。我们先把漫反射跟镜面反射两部分关联起来。

之前我们用 C 来表示材质漫的反射光线的系数。

其实光线会发生漫反射还是镜面反射，还受到的一个影响因素，就是**菲尼尔效应**。

## **1. 菲涅尔效应（菲涅尔反射）是什么？**

随着物体表面法线与视线的角度增大，物体的反射能力增大，这种现象称之为**菲涅尔效应**，万物皆有菲涅尔效应。

角度跟法线角度越小，越容易穿透介质，发生折射、散射、漫反射。

角度跟法线角度越大，越难穿透介质，就越容易发生镜面反射。

![](<images/1683601665957.png>)

![](<images/1683601666056.png>)

可以看到，**菲涅尔效应**在很大程度上（不是所有程度，后续会说到其他影响因素）控制了光线是发生漫反射还是镜面反射。而且影响了光线的强度。

比如上图，近处的地面就更多的发生漫反射。

## 2. 为什么会产生菲涅尔效应？

初中物理学过：光线在折射率不同的介质间传播，会发生折射现象。

其实不只是折射，当光通过不同的介质界面时，入射光会分为反射光和折射光两部分，是因为光是一种横波的。

光在表面的折射条件是需要在小于单一波长的距离内发生折射率的突然变化。

折射和反射的方向，分别遵循折射定律和反射定律。

**折射方向遵循 Snell 法则:**

![](<images/1683601666120.png>)

入射角是θi，折射角是θr

**sinθi/sinθr = nr/ni = vi/vt**

Vi Vt 是光线传播速度

ni, 是光线入射前的介质的折射率，我们图形学里就是空气，一般我们用 1（真空的折射率）来代替。

nr 是被光线入射的介质的折射率，不同材质的值不同，一般都大于空气。

这个公式的来源，可以用 **“光只走最短路径”** 来解释。

当光线在黄线的上下空间传播速度不同时，从 A 点到 B 点，光线能走的最短路径就是两条线段组合起来的。

![](<images/1683601666175.png>)

同时，在这个交界点，光线一部分会被吸收，另一部分则产生一个子光源，发生折射和反射。

通过上式可以看出，如果θi 变大，那么θr 也会变大**。**

如果 n1 变大，那么θr 也可以会变大。

足够大的时候，θr >90 度，就可以产生反射。

所以，为什么角度越大，菲涅尔效应越强。

另外，n2 足够大的时候，θr 不可能大于 90 度，菲涅尔效应就出现不了了，比如**理想中的金属。**

![](<images/1683601666239.png>)

上面的图是，致疏物质向致疏介质传递的过程，不能完全用来解释致疏介质向致疏物质传递。

只是便于理解和记忆。

另外，这个时候由于波的叠加，还会产生菲涅尔衍射。我们后面的部分模型，会把菲涅尔衍射也计算进去，也就是掠射角的后向反射。

菲涅尔衍射一般发生在物体边缘、很小的孔径。

![](<images/1683601666297.png>)

## **3. 菲涅尔方程和麦克斯韦方程组**

为了渲染菲涅尔效应，我们需要使用菲涅尔方程。

麦克斯韦方程组可以在折射率变化时计算光的行为。对于空气中通常的物体表面而言，物体的表面便是空气折射率和物体折射率的交界面，对此特殊的折射率交界面而言，麦克斯韦方程组的解被我们称为菲涅尔方程（Fresnel equations）。

**菲涅尔方程**（Fresnel Equations），用来描述光在不同折射率的介质之间的行为的方程。

菲涅尔方程描述的是**被反射的光线所占的百分比**，这个比率会随着我们观察的角度不同而不同。

所以菲涅尔方程同时影响漫反射跟镜面反射。  

**我们先给出菲尼尔方程**（Fresnel Equation）

我们一般采用 Schlick 的 Fresnel 近似，因为计算量小，精度足够：

F_Schlick(v,h) = F0 + (1-F0)(1- dot(v,h))^5

## **2. 方程里的 F0 与 F90**

**任何角度都有菲涅尔反射，我们需要计算两个特殊角度的菲尼尔反射，然后插值得到所有角度的菲尼尔反射，也就是渲染每个像素时的 F。**

**F0** : 指视线与法线夹角 = 0 度角时，入射的菲涅尔反射率。F0 也叫基础反射率。

**F90**：指视线与法线夹角 = 0 度角（掠射角）时，入射的菲涅尔反射率。

![](<images/1683601666421.png>)

物理上对不同材质的观察，有一些结论：

1. 不同材质的 F90 基本都接近 1，所以我们一般不会暴露 F90 来给美术调节。

2. 不同材质的 F0 有一定差别，基本在 2-5％，所以如果有需要，可以给定一个 F0 来渲染不同材质。

3. 虽说大部分情况，F90 接近于 1。但对于粗糙表面，Fresnel 效果会随着物体表面的光滑度变低快速的变弱。所以后续的 F90，我们需要引入粗糙度的影响。

4. 角度越大，反射率变化越迅速。

另外，金属跟非金属的 F0 差异很大。

## **3. 金属与非金属的 F0**

由于光由电磁波组成，因此，物质的光学特性与其导电特性密切相关。

即根据导电特性，可将现实生活中的物质分为三个主要光学类别：导体（金属）和绝缘体（电解质，非金属）、半导体。

渲染和游戏领域只关注：金属和非金属。

**1. 非金属**

1.1 大部分电介质的光学性质在可见光谱上变化很小，导致无色反射率值，**它们的反射光的颜色一般跟光源颜色一致**。即非金属的 F0 是一个 float。

1.2 基本反射率，也就是 F0，大多为 0.02-0.05（线性值），基本都在 0.17 这个水平线以下，且 rgb 分量一致，所以 Unity 引擎**固定使用 0.04（线性空间）**。

1.3. 虽然非金属的 F0 很低，但 F90 也接近于 1，, 这一现象也导致了金属与非金属外观上的不同

**2 金属**

2.1 一些**金属具有**在可见光谱范围内变化的光学性质。所以反射率 rgb 分量值不一致（正是这个不一致性，使得白光照射下的不同的金属有显著的颜色差异，如金、铜、银）。因为金属表面会吸收所有折射光线而没有漫反射，而 albedo 是我们绘制的材质对于光线的反射率，

**所以我们可以使用 albedo 来作为 F0。**

**金属的镜面反射颜色都来自表面颜色纹理。**

**其实从这句话可以看出，菲尼尔反射效应，本质上也是一个特殊的镜面反射。**

2.2 导体本身的反射率就已经很强，随角度变化很小，所以 F0 较高，范围为 0.5-1.0。

2.3 金属会立即吸收任何透射光，因此它们不会出现任何次表面散射或透明感。这也意味着理论上金属不会表现出任何的漫反射，使得金属看起来很闪亮。

2.4 但实际中由于金属表面氧化等原因，还是会表现出部分散射效果，所以 PBR 用 “metalness” 作为输入来表示材料的金属程度，而不是 albedo（反射率） & reflectivity。 **因为金属没有透射，所以使用 BRDF 即可。**

**从上文，我们可以得到一个信息：**albedo 纹理，在漫反射里作为漫反射 rgb 系数，在镜面反射里，对于金属，作为 F0 使用。

albedo 纹理在 PBR 里是个很特殊的纹理。

## **4. 我们观察公式逐一解释：**

F_Schlick(v,h) = F0 + (1-F0)(1- dot(v,h))^5

1. 我们在宏观层面看到的菲涅尔效应实际上是微观层面微平面菲涅尔效应的平均值。所以我们的 F 是在微表面计算的，**使用微平面的法向量，也就是宏观平面的中间向量**。 所以公式里是 dot（v,h）

2. 可以看到，v 跟 h 垂直时，F 是 F90。 这时候 dot(v,h) = cos90 度 = 0

F90 = F_Schlick(v,h) = F0 + (1-F0)(1)^5 = 1

v 跟 h 平行时，F 是 F0。 这时候 dot(v,h) = cos0 度 = 1

F0 =F_Schlick(v,h) = F0

可以看到，菲尼尔方程精确的满足了 F0 和 F90 这两个上下限，而且通过 (1- dot(v,h))^5 在 F0 和 F90 之间做了插值。

3. 我们上文说了，角度越大，菲尼尔反射率变化越迅速。

(1- dot(v,h))^5 恰好满足这个特征。

dot(v,h) 接近 1 时，指数函数变化慢。

dot(v,h) 接近 0 时，指数函数变化快。

菲尼尔方程跟物理观察得到的结果拟合度还是比较好的。

总之，菲尼尔方程可以拟合出任意角度的 F。

之所以说是拟合，因为它并不是一个精确解。

当然，这个 F 是我们**镜面反射的系数, 我们用符号 Fs 来表示**

## **5.** 镜面反射的菲涅尔系数 Fs

**// 第 1 步，我们统一金属和电解质的 F0**

```
vec3 F0 = vec3(0.04); 
//使用mix函数和metallic做插值，metallic越接近0，那么就越接近绝缘体，
//metalness越接近1，那么就越接近金属的albedo。
F0      = mix(F0, albedo, metallic);
```

**// 第 2 步，我们用 F0 计算不同视线角度的反射率 F，F 也就是我们的镜面反射系数 Ks**

**//** 我们根据观察角度，对 F0 和 1 进行插值。

```
float3 fresnelSchlick(float HdotV, float3 F0) {
    return F0 + (1 - F0) * pow(1 - HdotV , 5.0));
}
half Pow5(half v) {
	return v * v * v * v * v;
}
vec3 Fs  = fresnelSchlick(max(dot(H, V), 0.0), F0);
```

## **5. 菲尼尔对漫反射的影响 Fd**

漫反射的菲尼尔系数，我们用符号 Fd 表示。

按理说，不被反射的部分就是漫反射部分 + 吸收部分

Fd = 1- Fs;

（因为有评论不知道为什么这里 Fs 变成了 F0,2021 年 9 月 2 号补充这一段）

**但是 Fd、Fs 都不是一个固定值，在不同视角下都不一样，我们还是算出 0 角度下的 Fd_0**

**和 Fs_0，以后根据观察角度来进行插值。**

按理说：

Fd_0 = 1- Fs_0;

但是，我们之前说了，理想的金属没有漫反射，但因为实际中金属表面的氧化，导致漫反射，所以我们要考虑金属度。

Fd_0 = (1- Fs_0）*(1 - metallic);

**这里的 Fs_0，就是我们上一节计算的 F0**

其实，要求不高的 PBR 模型，这样计算就可以了。

**我们看看 Unity 的标准 PBR 的计算**

**跟上面公式相同：**

oneMinusReflectivity = (1 - metallic) * (1- F0)

而 1- F0 在 Unity 里提前存储起来了

half4(0.04, 0.04, 0.04, 1.0 - 0.04)

所以：

oneMinusReflectivity = (1 - metallic) * Liner_ColorSpaceDielectricSpec.a

这就是我们的最终的漫反射 Fd。

然后

return albedo * oneMinusReflectivity;

**就得到了 0 角度下的漫反射系数（所以后面还要计算一次入射角和出射角）**

**迪士尼计算菲尼尔对漫反射的影响 Fd**

**使用的是 burley 漫反射模型，**考虑了我们之前说的菲涅尔衍射的效应，也就是掠射角的后向反射。

因为迪士尼觉得上面的漫反射部分效果对于他们想要的美术效果偏暗，所以增加后向反射，达到亮度提高的效果。

Fd = F(n,l,1,F90) * F(n,v,1,F90)

F90 = 0.5 + 2 * LdotH*LdotH * roughness

然后，我们加上之前的漫反射 Fr = C/π

得到最后的漫反射系数：

Kd = Fd * Fr = C/π * F(n,l,1,F90) * F(n,v,1,F90)

```
//传入某个角度的f，得到漫反射的1-f
float SchlickFresnel(float f) {
    float fd = clamp(1-f, 0, 1);
    return Pow5(fd); 
}

half Pow5(half v) {
	return v * v * v * v * v;
}

//漫反射的菲尼尔系数。
//没有次表面散射时，我们的F90：掠射角0.5, 垂直角度1
//并且基于粗糙度插值
float Fd_burley (float NdotL, float NdotV, float LdotH, float roughness){
    float FL= SchlickFresnel(NdotL); 
    
    //F0时，NdotV=1. FV=0    Lerp(1, Fd90, FV) =1 
    //F90时，NdotV=0. FV=1     Lerp(1, Fd90, FV) =0
    float FV= SchlickFresnel(NdotV); 
    float Fd90 = 0.5 + 2.0 * LdotH*LdotH * roughness;
    return  Lerp(1, Fd90, FL) * Lerp(1, Fd90, FV);
}
```

迪士尼的 PBR 里，还把次表面散射跟漫反射统一起来了，用 subsurface 这个参数来控制漫反射和次表面散射的程度。

下面代码可以替代上文的 Fd_burley 函数，通过调节 subsurface 来达到效果。

```
float Fd_ss (float NdotL, float NdotV, float LdotH, float roughness, float subsurface ){
    float FL= SchlickFresnel(NdotL); 
    float FV= SchlickFresnel(NdotV);
    float Fd90 = 0.5 + 2.0 * LdotH*LdotH * roughness;
    Fd  = Lerp(1, Fd90, FL) * Lerp(1, Fd90, FV);
    
     //次表面散射的菲涅尔系数。
 //有次表面散射时，我们的F90从0开始
 //基于Hanrahan-Krueger brdf近似的各向同性bssrdf
    // 1.25 scale 用于 (近似) 保持 albedo
    // Fss90 用于 "平滑" 基于粗糙度的逆反射(retroreflection)
    float Fss90 = LdotH*LdotH*roughness;
    float Fss = mix(1.0, Fss90, FL) * mix(1.0, Fss90, FV);
    float ss = 1.25 * (Fss * (1 / (NdotL + NdotV) - 0.5) + 0.5);
    return mix(Fd, ss, subsurface);
}
```

## **5. 基于折射率求 F0**

我们开头说过，一般 F90 不需要暴露，F0 可以暴露。

我们一般使用的 F0，都是空气对于材质的 F0。我们默认空气的折射率 = 1

假如材质位于水中、油中等等，F0 会发生变化。

特殊情况下，如果我们要通过 F0 对反射建模，则需要通过折射率重新计算 F0。

光在真空中的速度 c 与在透明介质中的速度 v 之比，称之为该介质的绝对折射率，简称折射率。

n = c/v

通用的折射率与 F0 的关系：（9 月 1 日更正下，之前公式写错了）

F0 = pow((n1-n2),2) / pow((n1+n2),2)

其中，n1 和 n2 分别为两种介质的折射率。通常假设 n1=1 近似于空气的折射率：

F0 = pow((1-n2),2) / pow((1+n2),2)

```
_Ior("Ior",  Range(1,4)) = 1.5  
  
float _Ior; 
float IOR2F(float ior) {      
     float f0 = pow((1-ior),2) / pow((1+ior),2)
      return f0; 
}
```