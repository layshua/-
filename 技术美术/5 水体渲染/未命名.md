由计算简单正弦函数之和开始，逐步扩展到更复杂的函数。我们也将技术扩展到像素 shader 领域，使用周期波函数的加和，来创建动态的平铺 (tiling）凹凸贴图，从而获得水面的细节。

# 正弦近似值的加和
我们需要运行两个表面模拟：
- 表面网格的几何波动
- 网格上法线图的扰动。

两个模拟本质上是相同的。水面高度由简单的周期波叠加表示。

我们从求正弦函数之和开始，接着将接触到更有趣的波形。
正弦函数叠加后得到了一个连续函数，**这个函数描述了水面上所有点的高度和方向**。
1. 在处理顶点时，我们基于每个顶点的水平位置对函数取样，使得网格细分形成连续水面。
2. 在几何分辨率之下，将该技术继续应用于纹理空间。通过对近似正弦叠加的法线取样，用简单像素 shader 渲染到 RT，从而产生表面的法线图。为每帧渲染法线图，允许有限数量的正弦波组相互独立地运动，这大大地提高了渲染的逼真度。

## 波的选择
纹理的波纹好坏决定着模拟的逼真度。波纹表面的几何波动提供呈现纹理的精细框架结构。于是，对纹理波纹我们有不同的几何选择标准。

需要一个参数来定义每个波：
- **波长 $L$** 世界空间中波峰到波峰之间的距离。波长 $L$ 与角频率 $\omega$ 的关系为 $\omega=2\pi/L$。
- **振幅 $A$** 从水平面到波峰的高度。
- **速度** $S$：每秒钟波峰移动的距离。为了方便，把速度表示成相常数 ${\varphi}={S}\times2{\pi}/L$。·
- **方向** $D$： 垂直于波阵面的水平向量。波阵面为波峰沿着它运动的面。

波的状态定义为水平位置 $(x,y)$ 和时间 $(t)$ 的函数:
$$
W_{i}(x,y,t)=A_{i}\times\sin\left(\mathbf{D}_{i}\cdot(x,y)\times\omega_{i}+t\times\varphi_{i}\right)
$$
所有波 $i$ 的总表面：
$$
H(x,y,t)=\sum\bigl(A_{i}\times\sin\bigl(D_{i}\cdot(x,y)\times\omega_{i}+t\times\varphi_{i}\bigr)\bigr)
$$
![[Pasted image 20230808145634.png]]

为了提供场景动力学的变量，我们将在约束中随机产生这些波参数。随着时间的变化，我们会不断地将一个波淡出，然后再以一组不同的参数将其淡入。此过程中这些参数是相关的。**必须仔细地产生一个完整的参数组，才能使各个波以可信的方式结合在一起。**

## 法线和切线
因为表面是一个显式函数，所以能在任意给定点直接计算表面方向，不必使用有限差分技术。副法线 $B$ 和切线$T$ 向量分别为 $x$ 和 $y$ 方向的偏导数。对在 2D 水平面中的任何点 $(x, y)$，在表面上的三维位置$Р$是:
$$
P(x,y,t)=(x,y,H(x,y,t))
$$
x 方向的偏导：
$$
\begin{aligned}B(x,y)=&\left(\frac{\partial x}{\partial x},\frac{\partial y}{\partial x},\frac{\partial}{\partial x}(H(x,y,t))\right)\\\\B(x,y)=&\left(1,0,\frac{\partial}{\partial x}(H(x,y,t))\right)\end{aligned}
$$

y 方向的偏导：
$$
\begin{gathered}
T(x,y)=\left({\frac{\partial x}{\partial y}},{\frac{\partial y}{\partial y}},{\frac{\partial}{\partial y}}(H(x,y,t))\right) \\
T(x,y)=\left(0,1,{\frac{\partial}{\partial y}}(H(x,y,t))\right) 
\end{gathered}
$$
法线由 BT 叉积获得：
$$
N(x,y)=B(x,y)\times T(x,y)
$$
$$
N(x,y)=\left(-\frac{\partial}{\partial x}(H(x,y,t)),-\frac{\partial}{\partial y}(H(x,y,t)),1\right)
$$
